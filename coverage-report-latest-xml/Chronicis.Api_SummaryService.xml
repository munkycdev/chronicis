<?xml version="1.0" encoding="utf-8"?>
<CoverageReport scope="Chronicis.Api.Services.SummaryService">
  <Summary>
    <Class>Chronicis.Api.Services.SummaryService</Class>
    <Assembly>Chronicis.Api</Assembly>
    <Files>
      <File>Z:\repos\chronicis\src\Chronicis.Api\Services\SummaryService.cs</File>
    </Files>
    <Coveredlines>46</Coveredlines>
    <Uncoveredlines>0</Uncoveredlines>
    <Coverablelines>46</Coverablelines>
    <Totallines>923</Totallines>
    <Linecoverage>100</Linecoverage>
    <Coveredbranches>14</Coveredbranches>
    <Totalbranches>14</Totalbranches>
    <Branchcoverage>100</Branchcoverage>
    <Coveredmethods>5</Coveredmethods>
    <Fullcoveredmethods>5</Fullcoveredmethods>
    <Totalmethods>5</Totalmethods>
    <Methodcoverage>100</Methodcoverage>
    <Fullmethodcoverage>100</Fullmethodcoverage>
  </Summary>
  <Metrics>
    <Element name="cctor">
      <CrapScore>1</CrapScore>
      <Cyclomaticcomplexity>1</Cyclomaticcomplexity>
      <Linecoverage>100</Linecoverage>
      <Branchcoverage>100</Branchcoverage>
    </Element>
    <Element name="ctor">
      <CrapScore>6</CrapScore>
      <Cyclomaticcomplexity>6</Cyclomaticcomplexity>
      <Linecoverage>100</Linecoverage>
      <Branchcoverage>100</Branchcoverage>
    </Element>
    <Element name="BuildPrompt">
      <CrapScore>2</CrapScore>
      <Cyclomaticcomplexity>2</Cyclomaticcomplexity>
      <Linecoverage>100</Linecoverage>
      <Branchcoverage>100</Branchcoverage>
    </Element>
    <Element name="FormatSources">
      <CrapScore>1</CrapScore>
      <Cyclomaticcomplexity>1</Cyclomaticcomplexity>
      <Linecoverage>100</Linecoverage>
      <Branchcoverage>100</Branchcoverage>
    </Element>
    <Element name="FormatArticleSources">
      <CrapScore>6</CrapScore>
      <Cyclomaticcomplexity>6</Cyclomaticcomplexity>
      <Linecoverage>100</Linecoverage>
      <Branchcoverage>100</Branchcoverage>
    </Element>
  </Metrics>
  <Files>
    <File name="Z:\repos\chronicis\src\Chronicis.Api\Services\SummaryService.cs">
      <LineAnalysis line="1" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="using Azure;" />
      <LineAnalysis line="2" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="using Azure.AI.OpenAI;" />
      <LineAnalysis line="3" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="using Chronicis.Api.Data;" />
      <LineAnalysis line="4" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="using Chronicis.Shared.DTOs;" />
      <LineAnalysis line="5" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="using Chronicis.Shared.Enums;" />
      <LineAnalysis line="6" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="using Microsoft.EntityFrameworkCore;" />
      <LineAnalysis line="7" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="using OpenAI.Chat;" />
      <LineAnalysis line="8" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="9" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="namespace Chronicis.Api.Services;" />
      <LineAnalysis line="10" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="11" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="/// &lt;summary&gt;" />
      <LineAnalysis line="12" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="/// Azure OpenAI implementation of AI summary generation service." />
      <LineAnalysis line="13" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="/// Supports articles, campaigns, and arcs with customizable templates." />
      <LineAnalysis line="14" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="/// &lt;/summary&gt;" />
      <LineAnalysis line="15" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="public class SummaryService : ISummaryService" />
      <LineAnalysis line="16" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="{" />
      <LineAnalysis line="17" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private readonly ChronicisDbContext _context;" />
      <LineAnalysis line="18" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private readonly IConfiguration _configuration;" />
      <LineAnalysis line="19" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private readonly ILogger&lt;SummaryService&gt; _logger;" />
      <LineAnalysis line="20" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private readonly AzureOpenAIClient _openAIClient;" />
      <LineAnalysis line="21" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private readonly ChatClient _chatClient;" />
      <LineAnalysis line="22" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="23" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="    private const decimal InputTokenCostPer1K = 0.00040m;" />
      <LineAnalysis line="24" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="    private const decimal OutputTokenCostPer1K = 0.00176m;" />
      <LineAnalysis line="25" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private const int CharsPerToken = 4;" />
      <LineAnalysis line="26" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private const string SessionSummaryPromptConfigKey = &quot;AzureOpenAI:SessionSummaryPromptTemplate&quot;;" />
      <LineAnalysis line="27" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="28" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    // Well-known template IDs (from seed data)" />
      <LineAnalysis line="29" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="    private static readonly Guid DefaultTemplateId = Guid.Parse(&quot;00000000-0000-0000-0000-000000000001&quot;);" />
      <LineAnalysis line="30" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="    private static readonly Guid CampaignRecapTemplateId = Guid.Parse(&quot;00000000-0000-0000-0000-000000000006&quot;);" />
      <LineAnalysis line="31" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="32" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public SummaryService(" />
      <LineAnalysis line="33" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        ChronicisDbContext context," />
      <LineAnalysis line="34" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        IConfiguration configuration," />
      <LineAnalysis line="35" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        ILogger&lt;SummaryService&gt; logger)" />
      <LineAnalysis line="36" visits="4" coverage="Covered" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="37" visits="4" coverage="Covered" coveredbranches="" totalbranches="" content="        _context = context;" />
      <LineAnalysis line="38" visits="4" coverage="Covered" coveredbranches="" totalbranches="" content="        _configuration = configuration;" />
      <LineAnalysis line="39" visits="4" coverage="Covered" coveredbranches="" totalbranches="" content="        _logger = logger;" />
      <LineAnalysis line="40" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="41" visits="4" coverage="Covered" coveredbranches="" totalbranches="" content="        var endpoint = _configuration[&quot;AzureOpenAI:Endpoint&quot;];" />
      <LineAnalysis line="42" visits="4" coverage="Covered" coveredbranches="" totalbranches="" content="        var apiKey = _configuration[&quot;AzureOpenAI:ApiKey&quot;];" />
      <LineAnalysis line="43" visits="4" coverage="Covered" coveredbranches="" totalbranches="" content="        var deploymentName = _configuration[&quot;AzureOpenAI:DeploymentName&quot;];" />
      <LineAnalysis line="44" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="45" visits="4" coverage="Covered" coveredbranches="2" totalbranches="2" content="        if (string.IsNullOrEmpty(endpoint))" />
      <LineAnalysis line="46" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="            throw new InvalidOperationException(&quot;AzureOpenAI:Endpoint not configured&quot;);" />
      <LineAnalysis line="47" visits="3" coverage="Covered" coveredbranches="2" totalbranches="2" content="        if (string.IsNullOrEmpty(apiKey))" />
      <LineAnalysis line="48" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="            throw new InvalidOperationException(&quot;AzureOpenAI:ApiKey not configured&quot;);" />
      <LineAnalysis line="49" visits="2" coverage="Covered" coveredbranches="2" totalbranches="2" content="        if (string.IsNullOrEmpty(deploymentName))" />
      <LineAnalysis line="50" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="            throw new InvalidOperationException(&quot;AzureOpenAI:DeploymentName not configured&quot;);" />
      <LineAnalysis line="51" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="52" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="        _openAIClient = new AzureOpenAIClient(new Uri(endpoint), new AzureKeyCredential(apiKey));" />
      <LineAnalysis line="53" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="        _chatClient = _openAIClient.GetChatClient(deploymentName);" />
      <LineAnalysis line="54" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="55" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="56" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #region Templates" />
      <LineAnalysis line="57" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="58" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;List&lt;SummaryTemplateDto&gt;&gt; GetTemplatesAsync()" />
      <LineAnalysis line="59" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="60" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return await _context.SummaryTemplates" />
      <LineAnalysis line="61" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="62" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Where(t =&gt; t.IsSystem) // For now, only system templates" />
      <LineAnalysis line="63" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .OrderBy(t =&gt; t.Name)" />
      <LineAnalysis line="64" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Select(t =&gt; new SummaryTemplateDto" />
      <LineAnalysis line="65" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="66" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Id = t.Id," />
      <LineAnalysis line="67" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Name = t.Name," />
      <LineAnalysis line="68" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Description = t.Description," />
      <LineAnalysis line="69" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                IsSystem = t.IsSystem" />
      <LineAnalysis line="70" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            })" />
      <LineAnalysis line="71" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .ToListAsync();" />
      <LineAnalysis line="72" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="73" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="74" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #endregion" />
      <LineAnalysis line="75" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="76" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #region Article Summary" />
      <LineAnalysis line="77" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="78" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;SummaryEstimateDto&gt; EstimateArticleSummaryAsync(Guid articleId)" />
      <LineAnalysis line="79" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="80" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var article = await _context.Articles" />
      <LineAnalysis line="81" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="82" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Include(a =&gt; a.SummaryTemplate)" />
      <LineAnalysis line="83" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .FirstOrDefaultAsync(a =&gt; a.Id == articleId)" />
      <LineAnalysis line="84" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            ?? throw new InvalidOperationException($&quot;Article {articleId} not found&quot;);" />
      <LineAnalysis line="85" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="86" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var (primary, backlinks) = await GetArticleSourcesAsync(articleId);" />
      <LineAnalysis line="87" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var promptTemplate = await GetEffectivePromptAsync(" />
      <LineAnalysis line="88" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            article.SummaryTemplateId," />
      <LineAnalysis line="89" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            article.SummaryCustomPrompt," />
      <LineAnalysis line="90" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            DefaultTemplateId);" />
      <LineAnalysis line="91" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="92" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var sourceContent = FormatArticleSources(primary, backlinks);" />
      <LineAnalysis line="93" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var fullPrompt = BuildPrompt(promptTemplate, article.Title, sourceContent, &quot;&quot;);" />
      <LineAnalysis line="94" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="95" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        int estimatedInputTokens = fullPrompt.Length / CharsPerToken;" />
      <LineAnalysis line="96" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        int estimatedOutputTokens = int.Parse(_configuration[&quot;AzureOpenAI:MaxOutputTokens&quot;] ?? &quot;1500&quot;);" />
      <LineAnalysis line="97" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="98" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        decimal estimatedCost =" />
      <LineAnalysis line="99" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            (estimatedInputTokens / 1000m * InputTokenCostPer1K) +" />
      <LineAnalysis line="100" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            (estimatedOutputTokens / 1000m * OutputTokenCostPer1K);" />
      <LineAnalysis line="101" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="102" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        // Count sources: 1 for primary (if exists) + backlink count" />
      <LineAnalysis line="103" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var sourceCount = (primary != null ? 1 : 0) + backlinks.Count;" />
      <LineAnalysis line="104" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="105" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return new SummaryEstimateDto" />
      <LineAnalysis line="106" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="107" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityId = articleId," />
      <LineAnalysis line="108" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityType = &quot;Article&quot;," />
      <LineAnalysis line="109" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityName = article.Title," />
      <LineAnalysis line="110" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            SourceCount = sourceCount," />
      <LineAnalysis line="111" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EstimatedInputTokens = estimatedInputTokens," />
      <LineAnalysis line="112" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EstimatedOutputTokens = estimatedOutputTokens," />
      <LineAnalysis line="113" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EstimatedCostUSD = Math.Round(estimatedCost, 4)," />
      <LineAnalysis line="114" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            HasExistingSummary = !string.IsNullOrEmpty(article.AISummary)," />
      <LineAnalysis line="115" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            ExistingSummaryDate = article.AISummaryGeneratedAt," />
      <LineAnalysis line="116" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateId = article.SummaryTemplateId," />
      <LineAnalysis line="117" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateName = article.SummaryTemplate?.Name," />
      <LineAnalysis line="118" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            CustomPrompt = article.SummaryCustomPrompt," />
      <LineAnalysis line="119" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            IncludeWebSources = article.SummaryIncludeWebSources" />
      <LineAnalysis line="120" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        };" />
      <LineAnalysis line="121" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="122" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="123" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;SummaryGenerationDto&gt; GenerateArticleSummaryAsync(Guid articleId, GenerateSummaryRequestDto? request = null)" />
      <LineAnalysis line="124" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="125" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        try" />
      <LineAnalysis line="126" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="127" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var article = await _context.Articles" />
      <LineAnalysis line="128" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                .Include(a =&gt; a.SummaryTemplate)" />
      <LineAnalysis line="129" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                .FirstOrDefaultAsync(a =&gt; a.Id == articleId);" />
      <LineAnalysis line="130" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="131" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (article == null)" />
      <LineAnalysis line="132" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="133" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                return new SummaryGenerationDto" />
      <LineAnalysis line="134" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                {" />
      <LineAnalysis line="135" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Success = false," />
      <LineAnalysis line="136" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    ErrorMessage = $&quot;Article {articleId} not found&quot;" />
      <LineAnalysis line="137" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                };" />
      <LineAnalysis line="138" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="139" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="140" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var (primary, backlinks) = await GetArticleSourcesAsync(articleId);" />
      <LineAnalysis line="141" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="142" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            // Need at least the article's own content OR backlinks" />
      <LineAnalysis line="143" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (primary == null &amp;&amp; backlinks.Count == 0)" />
      <LineAnalysis line="144" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="145" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                return new SummaryGenerationDto" />
      <LineAnalysis line="146" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                {" />
      <LineAnalysis line="147" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Success = false," />
      <LineAnalysis line="148" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    ErrorMessage = &quot;No content available. Add content to this article or create links from other articles.&quot;" />
      <LineAnalysis line="149" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                };" />
      <LineAnalysis line="150" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="151" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="152" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            // Determine effective configuration" />
      <LineAnalysis line="153" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var templateId = request?.TemplateId ?? article.SummaryTemplateId;" />
      <LineAnalysis line="154" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var customPrompt = request?.CustomPrompt ?? article.SummaryCustomPrompt;" />
      <LineAnalysis line="155" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var includeWeb = request?.IncludeWebSources ?? article.SummaryIncludeWebSources;" />
      <LineAnalysis line="156" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="157" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            // Save configuration if requested" />
      <LineAnalysis line="158" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (request?.SaveConfiguration == true)" />
      <LineAnalysis line="159" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="160" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                article.SummaryTemplateId = request.TemplateId;" />
      <LineAnalysis line="161" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                article.SummaryCustomPrompt = request.CustomPrompt;" />
      <LineAnalysis line="162" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                article.SummaryIncludeWebSources = request.IncludeWebSources;" />
      <LineAnalysis line="163" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="164" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="165" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var promptTemplate = await GetEffectivePromptAsync(templateId, customPrompt, DefaultTemplateId);" />
      <LineAnalysis line="166" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var sourceContent = FormatArticleSources(primary, backlinks);" />
      <LineAnalysis line="167" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="168" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            // Build sources list for response" />
      <LineAnalysis line="169" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var allSources = new List&lt;SourceContent&gt;();" />
      <LineAnalysis line="170" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (primary != null)" />
      <LineAnalysis line="171" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                allSources.Add(primary);" />
      <LineAnalysis line="172" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            allSources.AddRange(backlinks);" />
      <LineAnalysis line="173" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="174" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            // TODO: Implement web search when includeWeb is true" />
      <LineAnalysis line="175" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var webContent = &quot;&quot;;" />
      <LineAnalysis line="176" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="177" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var result = await GenerateSummaryInternalAsync(" />
      <LineAnalysis line="178" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                article.Title," />
      <LineAnalysis line="179" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                promptTemplate," />
      <LineAnalysis line="180" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                sourceContent," />
      <LineAnalysis line="181" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                webContent," />
      <LineAnalysis line="182" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                allSources," />
      <LineAnalysis line="183" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                request?.MaxOutputTokens ?? 1500);" />
      <LineAnalysis line="184" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="185" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (result.Success)" />
      <LineAnalysis line="186" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="187" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                article.AISummary = result.Summary;" />
      <LineAnalysis line="188" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                article.AISummaryGeneratedAt = DateTime.UtcNow;" />
      <LineAnalysis line="189" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                await _context.SaveChangesAsync();" />
      <LineAnalysis line="190" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                result.GeneratedDate = article.AISummaryGeneratedAt.Value;" />
      <LineAnalysis line="191" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="192" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="193" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return result;" />
      <LineAnalysis line="194" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="195" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        catch (Exception ex)" />
      <LineAnalysis line="196" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="197" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            _logger.LogError(ex, &quot;Error generating AI summary for article {ArticleId}&quot;, articleId);" />
      <LineAnalysis line="198" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return new SummaryGenerationDto" />
      <LineAnalysis line="199" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="200" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Success = false," />
      <LineAnalysis line="201" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                ErrorMessage = $&quot;Error generating summary: {ex.Message}&quot;" />
      <LineAnalysis line="202" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            };" />
      <LineAnalysis line="203" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="204" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="205" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="206" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;ArticleSummaryDto?&gt; GetArticleSummaryAsync(Guid articleId)" />
      <LineAnalysis line="207" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="208" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var article = await _context.Articles" />
      <LineAnalysis line="209" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="210" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Include(a =&gt; a.SummaryTemplate)" />
      <LineAnalysis line="211" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .FirstOrDefaultAsync(a =&gt; a.Id == articleId);" />
      <LineAnalysis line="212" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="213" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (article == null)" />
      <LineAnalysis line="214" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return null;" />
      <LineAnalysis line="215" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="216" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return new ArticleSummaryDto" />
      <LineAnalysis line="217" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="218" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            ArticleId = articleId," />
      <LineAnalysis line="219" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            Summary = article.AISummary," />
      <LineAnalysis line="220" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            GeneratedAt = article.AISummaryGeneratedAt," />
      <LineAnalysis line="221" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateId = article.SummaryTemplateId," />
      <LineAnalysis line="222" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateName = article.SummaryTemplate?.Name," />
      <LineAnalysis line="223" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            CustomPrompt = article.SummaryCustomPrompt," />
      <LineAnalysis line="224" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            IncludeWebSources = article.SummaryIncludeWebSources" />
      <LineAnalysis line="225" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        };" />
      <LineAnalysis line="226" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="227" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="228" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;SummaryPreviewDto?&gt; GetArticleSummaryPreviewAsync(Guid articleId)" />
      <LineAnalysis line="229" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="230" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var article = await _context.Articles" />
      <LineAnalysis line="231" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="232" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Include(a =&gt; a.SummaryTemplate)" />
      <LineAnalysis line="233" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Where(a =&gt; a.Id == articleId)" />
      <LineAnalysis line="234" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Select(a =&gt; new SummaryPreviewDto" />
      <LineAnalysis line="235" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="236" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Title = a.Title," />
      <LineAnalysis line="237" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Summary = a.AISummary," />
      <LineAnalysis line="238" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                TemplateName = a.SummaryTemplate != null ? a.SummaryTemplate.Name : null" />
      <LineAnalysis line="239" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            })" />
      <LineAnalysis line="240" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .FirstOrDefaultAsync();" />
      <LineAnalysis line="241" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="242" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return article;" />
      <LineAnalysis line="243" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="244" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="245" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;bool&gt; ClearArticleSummaryAsync(Guid articleId)" />
      <LineAnalysis line="246" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="247" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var article = await _context.Articles.FirstOrDefaultAsync(a =&gt; a.Id == articleId);" />
      <LineAnalysis line="248" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (article == null)" />
      <LineAnalysis line="249" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return false;" />
      <LineAnalysis line="250" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="251" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        article.AISummary = null;" />
      <LineAnalysis line="252" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        article.AISummaryGeneratedAt = null;" />
      <LineAnalysis line="253" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        await _context.SaveChangesAsync();" />
      <LineAnalysis line="254" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return true;" />
      <LineAnalysis line="255" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="256" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="257" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private async Task&lt;(SourceContent? Primary, List&lt;SourceContent&gt; Backlinks)&gt; GetArticleSourcesAsync(Guid articleId)" />
      <LineAnalysis line="258" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="259" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        // Get the article's own content as the primary/canonical source" />
      <LineAnalysis line="260" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var article = await _context.Articles" />
      <LineAnalysis line="261" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="262" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .FirstOrDefaultAsync(a =&gt; a.Id == articleId);" />
      <LineAnalysis line="263" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="264" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        SourceContent? primarySource = null;" />
      <LineAnalysis line="265" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (article != null &amp;&amp; !string.IsNullOrEmpty(article.Body))" />
      <LineAnalysis line="266" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="267" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            primarySource = new SourceContent" />
      <LineAnalysis line="268" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="269" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Type = &quot;Primary&quot;," />
      <LineAnalysis line="270" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Title = article.Title," />
      <LineAnalysis line="271" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Content = article.Body," />
      <LineAnalysis line="272" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                ArticleId = article.Id" />
      <LineAnalysis line="273" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            };" />
      <LineAnalysis line="274" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="275" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="276" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        // Get all articles that link TO this article (backlinks)" />
      <LineAnalysis line="277" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var backlinks = await _context.ArticleLinks" />
      <LineAnalysis line="278" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="279" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Where(al =&gt; al.TargetArticleId == articleId)" />
      <LineAnalysis line="280" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Select(al =&gt; al.SourceArticle)" />
      <LineAnalysis line="281" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Distinct()" />
      <LineAnalysis line="282" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Where(a =&gt; !string.IsNullOrEmpty(a.Body) &amp;&amp; a.Visibility == ArticleVisibility.Public)" />
      <LineAnalysis line="283" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Select(a =&gt; new SourceContent" />
      <LineAnalysis line="284" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="285" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Type = &quot;Backlink&quot;," />
      <LineAnalysis line="286" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Title = a.Title," />
      <LineAnalysis line="287" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Content = a.Body!," />
      <LineAnalysis line="288" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                ArticleId = a.Id" />
      <LineAnalysis line="289" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            })" />
      <LineAnalysis line="290" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .ToListAsync();" />
      <LineAnalysis line="291" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="292" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return (primarySource, backlinks);" />
      <LineAnalysis line="293" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="294" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="295" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #endregion" />
      <LineAnalysis line="296" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="297" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #region Campaign Summary" />
      <LineAnalysis line="298" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="299" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;SummaryEstimateDto&gt; EstimateCampaignSummaryAsync(Guid campaignId)" />
      <LineAnalysis line="300" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="301" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var campaign = await _context.Campaigns" />
      <LineAnalysis line="302" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="303" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Include(c =&gt; c.SummaryTemplate)" />
      <LineAnalysis line="304" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .FirstOrDefaultAsync(c =&gt; c.Id == campaignId)" />
      <LineAnalysis line="305" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            ?? throw new InvalidOperationException($&quot;Campaign {campaignId} not found&quot;);" />
      <LineAnalysis line="306" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="307" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var sources = await GetCampaignSourcesAsync(campaignId);" />
      <LineAnalysis line="308" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var promptTemplate = await GetEffectivePromptAsync(" />
      <LineAnalysis line="309" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            campaign.SummaryTemplateId," />
      <LineAnalysis line="310" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            campaign.SummaryCustomPrompt," />
      <LineAnalysis line="311" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            CampaignRecapTemplateId);" />
      <LineAnalysis line="312" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="313" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var sourceContent = FormatSources(sources);" />
      <LineAnalysis line="314" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var fullPrompt = BuildPrompt(promptTemplate, campaign.Name, sourceContent, &quot;&quot;);" />
      <LineAnalysis line="315" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="316" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        int estimatedInputTokens = fullPrompt.Length / CharsPerToken;" />
      <LineAnalysis line="317" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        int estimatedOutputTokens = int.Parse(_configuration[&quot;AzureOpenAI:MaxOutputTokens&quot;] ?? &quot;1500&quot;);" />
      <LineAnalysis line="318" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="319" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        decimal estimatedCost =" />
      <LineAnalysis line="320" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            (estimatedInputTokens / 1000m * InputTokenCostPer1K) +" />
      <LineAnalysis line="321" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            (estimatedOutputTokens / 1000m * OutputTokenCostPer1K);" />
      <LineAnalysis line="322" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="323" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return new SummaryEstimateDto" />
      <LineAnalysis line="324" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="325" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityId = campaignId," />
      <LineAnalysis line="326" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityType = &quot;Campaign&quot;," />
      <LineAnalysis line="327" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityName = campaign.Name," />
      <LineAnalysis line="328" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            SourceCount = sources.Count," />
      <LineAnalysis line="329" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EstimatedInputTokens = estimatedInputTokens," />
      <LineAnalysis line="330" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EstimatedOutputTokens = estimatedOutputTokens," />
      <LineAnalysis line="331" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EstimatedCostUSD = Math.Round(estimatedCost, 4)," />
      <LineAnalysis line="332" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            HasExistingSummary = !string.IsNullOrEmpty(campaign.AISummary)," />
      <LineAnalysis line="333" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            ExistingSummaryDate = campaign.AISummaryGeneratedAt," />
      <LineAnalysis line="334" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateId = campaign.SummaryTemplateId," />
      <LineAnalysis line="335" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateName = campaign.SummaryTemplate?.Name," />
      <LineAnalysis line="336" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            CustomPrompt = campaign.SummaryCustomPrompt," />
      <LineAnalysis line="337" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            IncludeWebSources = campaign.SummaryIncludeWebSources" />
      <LineAnalysis line="338" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        };" />
      <LineAnalysis line="339" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="340" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="341" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;SummaryGenerationDto&gt; GenerateCampaignSummaryAsync(Guid campaignId, GenerateSummaryRequestDto? request = null)" />
      <LineAnalysis line="342" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="343" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        try" />
      <LineAnalysis line="344" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="345" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var campaign = await _context.Campaigns" />
      <LineAnalysis line="346" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                .Include(c =&gt; c.SummaryTemplate)" />
      <LineAnalysis line="347" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                .FirstOrDefaultAsync(c =&gt; c.Id == campaignId);" />
      <LineAnalysis line="348" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="349" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (campaign == null)" />
      <LineAnalysis line="350" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="351" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                return new SummaryGenerationDto" />
      <LineAnalysis line="352" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                {" />
      <LineAnalysis line="353" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Success = false," />
      <LineAnalysis line="354" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    ErrorMessage = $&quot;Campaign {campaignId} not found&quot;" />
      <LineAnalysis line="355" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                };" />
      <LineAnalysis line="356" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="357" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="358" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var sources = await GetCampaignSourcesAsync(campaignId);" />
      <LineAnalysis line="359" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="360" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (sources.Count == 0)" />
      <LineAnalysis line="361" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="362" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                return new SummaryGenerationDto" />
      <LineAnalysis line="363" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                {" />
      <LineAnalysis line="364" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Success = false," />
      <LineAnalysis line="365" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    ErrorMessage = &quot;No public session notes found in this campaign.&quot;" />
      <LineAnalysis line="366" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                };" />
      <LineAnalysis line="367" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="368" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="369" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var templateId = request?.TemplateId ?? campaign.SummaryTemplateId;" />
      <LineAnalysis line="370" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var customPrompt = request?.CustomPrompt ?? campaign.SummaryCustomPrompt;" />
      <LineAnalysis line="371" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var includeWeb = request?.IncludeWebSources ?? campaign.SummaryIncludeWebSources;" />
      <LineAnalysis line="372" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="373" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (request?.SaveConfiguration == true)" />
      <LineAnalysis line="374" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="375" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                campaign.SummaryTemplateId = request.TemplateId;" />
      <LineAnalysis line="376" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                campaign.SummaryCustomPrompt = request.CustomPrompt;" />
      <LineAnalysis line="377" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                campaign.SummaryIncludeWebSources = request.IncludeWebSources;" />
      <LineAnalysis line="378" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="379" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="380" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var promptTemplate = await GetEffectivePromptAsync(templateId, customPrompt, CampaignRecapTemplateId);" />
      <LineAnalysis line="381" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var sourceContent = FormatSources(sources);" />
      <LineAnalysis line="382" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var webContent = &quot;&quot;;" />
      <LineAnalysis line="383" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="384" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var result = await GenerateSummaryInternalAsync(" />
      <LineAnalysis line="385" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                campaign.Name," />
      <LineAnalysis line="386" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                promptTemplate," />
      <LineAnalysis line="387" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                sourceContent," />
      <LineAnalysis line="388" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                webContent," />
      <LineAnalysis line="389" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                sources," />
      <LineAnalysis line="390" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                request?.MaxOutputTokens ?? 1500);" />
      <LineAnalysis line="391" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="392" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (result.Success)" />
      <LineAnalysis line="393" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="394" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                campaign.AISummary = result.Summary;" />
      <LineAnalysis line="395" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                campaign.AISummaryGeneratedAt = DateTime.UtcNow;" />
      <LineAnalysis line="396" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                await _context.SaveChangesAsync();" />
      <LineAnalysis line="397" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                result.GeneratedDate = campaign.AISummaryGeneratedAt.Value;" />
      <LineAnalysis line="398" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="399" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="400" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return result;" />
      <LineAnalysis line="401" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="402" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        catch (Exception ex)" />
      <LineAnalysis line="403" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="404" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            _logger.LogError(ex, &quot;Error generating AI summary for campaign {CampaignId}&quot;, campaignId);" />
      <LineAnalysis line="405" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return new SummaryGenerationDto" />
      <LineAnalysis line="406" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="407" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Success = false," />
      <LineAnalysis line="408" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                ErrorMessage = $&quot;Error generating summary: {ex.Message}&quot;" />
      <LineAnalysis line="409" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            };" />
      <LineAnalysis line="410" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="411" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="412" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="413" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;EntitySummaryDto?&gt; GetCampaignSummaryAsync(Guid campaignId)" />
      <LineAnalysis line="414" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="415" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var campaign = await _context.Campaigns" />
      <LineAnalysis line="416" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="417" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Include(c =&gt; c.SummaryTemplate)" />
      <LineAnalysis line="418" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .FirstOrDefaultAsync(c =&gt; c.Id == campaignId);" />
      <LineAnalysis line="419" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="420" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (campaign == null)" />
      <LineAnalysis line="421" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return null;" />
      <LineAnalysis line="422" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="423" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return new EntitySummaryDto" />
      <LineAnalysis line="424" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="425" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityId = campaignId," />
      <LineAnalysis line="426" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityType = &quot;Campaign&quot;," />
      <LineAnalysis line="427" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            Summary = campaign.AISummary," />
      <LineAnalysis line="428" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            GeneratedAt = campaign.AISummaryGeneratedAt," />
      <LineAnalysis line="429" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateId = campaign.SummaryTemplateId," />
      <LineAnalysis line="430" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateName = campaign.SummaryTemplate?.Name," />
      <LineAnalysis line="431" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            CustomPrompt = campaign.SummaryCustomPrompt," />
      <LineAnalysis line="432" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            IncludeWebSources = campaign.SummaryIncludeWebSources" />
      <LineAnalysis line="433" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        };" />
      <LineAnalysis line="434" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="435" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="436" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;bool&gt; ClearCampaignSummaryAsync(Guid campaignId)" />
      <LineAnalysis line="437" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="438" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var campaign = await _context.Campaigns.FirstOrDefaultAsync(c =&gt; c.Id == campaignId);" />
      <LineAnalysis line="439" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (campaign == null)" />
      <LineAnalysis line="440" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return false;" />
      <LineAnalysis line="441" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="442" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        campaign.AISummary = null;" />
      <LineAnalysis line="443" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        campaign.AISummaryGeneratedAt = null;" />
      <LineAnalysis line="444" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        await _context.SaveChangesAsync();" />
      <LineAnalysis line="445" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return true;" />
      <LineAnalysis line="446" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="447" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="448" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private async Task&lt;List&lt;SourceContent&gt;&gt; GetCampaignSourcesAsync(Guid campaignId)" />
      <LineAnalysis line="449" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="450" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var sessions = await _context.Sessions" />
      <LineAnalysis line="451" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="452" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Where(s =&gt; s.Arc.CampaignId == campaignId)" />
      <LineAnalysis line="453" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .OrderBy(s =&gt; s.SessionDate ?? s.CreatedAt)" />
      <LineAnalysis line="454" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .ThenBy(s =&gt; s.Name)" />
      <LineAnalysis line="455" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Select(s =&gt; new SessionSourceSeed" />
      <LineAnalysis line="456" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="457" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Id = s.Id," />
      <LineAnalysis line="458" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Name = s.Name," />
      <LineAnalysis line="459" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                PublicNotes = s.PublicNotes" />
      <LineAnalysis line="460" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            })" />
      <LineAnalysis line="461" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .ToListAsync();" />
      <LineAnalysis line="462" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="463" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return await BuildSessionSourcesAsync(sessions);" />
      <LineAnalysis line="464" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="465" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="466" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #endregion" />
      <LineAnalysis line="467" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="468" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #region Arc Summary" />
      <LineAnalysis line="469" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="470" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;SummaryEstimateDto&gt; EstimateArcSummaryAsync(Guid arcId)" />
      <LineAnalysis line="471" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="472" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var arc = await _context.Arcs" />
      <LineAnalysis line="473" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="474" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Include(a =&gt; a.SummaryTemplate)" />
      <LineAnalysis line="475" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .FirstOrDefaultAsync(a =&gt; a.Id == arcId)" />
      <LineAnalysis line="476" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            ?? throw new InvalidOperationException($&quot;Arc {arcId} not found&quot;);" />
      <LineAnalysis line="477" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="478" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var sources = await GetArcSourcesAsync(arcId);" />
      <LineAnalysis line="479" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var promptTemplate = await GetEffectivePromptAsync(" />
      <LineAnalysis line="480" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            arc.SummaryTemplateId," />
      <LineAnalysis line="481" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            arc.SummaryCustomPrompt," />
      <LineAnalysis line="482" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            CampaignRecapTemplateId);" />
      <LineAnalysis line="483" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="484" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var sourceContent = FormatSources(sources);" />
      <LineAnalysis line="485" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var fullPrompt = BuildPrompt(promptTemplate, arc.Name, sourceContent, &quot;&quot;);" />
      <LineAnalysis line="486" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="487" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        int estimatedInputTokens = fullPrompt.Length / CharsPerToken;" />
      <LineAnalysis line="488" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        int estimatedOutputTokens = int.Parse(_configuration[&quot;AzureOpenAI:MaxOutputTokens&quot;] ?? &quot;1500&quot;);" />
      <LineAnalysis line="489" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="490" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        decimal estimatedCost =" />
      <LineAnalysis line="491" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            (estimatedInputTokens / 1000m * InputTokenCostPer1K) +" />
      <LineAnalysis line="492" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            (estimatedOutputTokens / 1000m * OutputTokenCostPer1K);" />
      <LineAnalysis line="493" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="494" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return new SummaryEstimateDto" />
      <LineAnalysis line="495" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="496" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityId = arcId," />
      <LineAnalysis line="497" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityType = &quot;Arc&quot;," />
      <LineAnalysis line="498" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityName = arc.Name," />
      <LineAnalysis line="499" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            SourceCount = sources.Count," />
      <LineAnalysis line="500" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EstimatedInputTokens = estimatedInputTokens," />
      <LineAnalysis line="501" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EstimatedOutputTokens = estimatedOutputTokens," />
      <LineAnalysis line="502" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EstimatedCostUSD = Math.Round(estimatedCost, 4)," />
      <LineAnalysis line="503" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            HasExistingSummary = !string.IsNullOrEmpty(arc.AISummary)," />
      <LineAnalysis line="504" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            ExistingSummaryDate = arc.AISummaryGeneratedAt," />
      <LineAnalysis line="505" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateId = arc.SummaryTemplateId," />
      <LineAnalysis line="506" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateName = arc.SummaryTemplate?.Name," />
      <LineAnalysis line="507" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            CustomPrompt = arc.SummaryCustomPrompt," />
      <LineAnalysis line="508" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            IncludeWebSources = arc.SummaryIncludeWebSources" />
      <LineAnalysis line="509" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        };" />
      <LineAnalysis line="510" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="511" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="512" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;SummaryGenerationDto&gt; GenerateArcSummaryAsync(Guid arcId, GenerateSummaryRequestDto? request = null)" />
      <LineAnalysis line="513" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="514" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        try" />
      <LineAnalysis line="515" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="516" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var arc = await _context.Arcs" />
      <LineAnalysis line="517" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                .Include(a =&gt; a.SummaryTemplate)" />
      <LineAnalysis line="518" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                .FirstOrDefaultAsync(a =&gt; a.Id == arcId);" />
      <LineAnalysis line="519" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="520" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (arc == null)" />
      <LineAnalysis line="521" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="522" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                return new SummaryGenerationDto" />
      <LineAnalysis line="523" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                {" />
      <LineAnalysis line="524" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Success = false," />
      <LineAnalysis line="525" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    ErrorMessage = $&quot;Arc {arcId} not found&quot;" />
      <LineAnalysis line="526" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                };" />
      <LineAnalysis line="527" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="528" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="529" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var sources = await GetArcSourcesAsync(arcId);" />
      <LineAnalysis line="530" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="531" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (sources.Count == 0)" />
      <LineAnalysis line="532" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="533" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                return new SummaryGenerationDto" />
      <LineAnalysis line="534" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                {" />
      <LineAnalysis line="535" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Success = false," />
      <LineAnalysis line="536" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    ErrorMessage = &quot;No public session notes found in this arc.&quot;" />
      <LineAnalysis line="537" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                };" />
      <LineAnalysis line="538" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="539" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="540" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var templateId = request?.TemplateId ?? arc.SummaryTemplateId;" />
      <LineAnalysis line="541" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var customPrompt = request?.CustomPrompt ?? arc.SummaryCustomPrompt;" />
      <LineAnalysis line="542" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var includeWeb = request?.IncludeWebSources ?? arc.SummaryIncludeWebSources;" />
      <LineAnalysis line="543" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="544" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (request?.SaveConfiguration == true)" />
      <LineAnalysis line="545" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="546" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                arc.SummaryTemplateId = request.TemplateId;" />
      <LineAnalysis line="547" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                arc.SummaryCustomPrompt = request.CustomPrompt;" />
      <LineAnalysis line="548" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                arc.SummaryIncludeWebSources = request.IncludeWebSources;" />
      <LineAnalysis line="549" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="550" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="551" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var promptTemplate = await GetEffectivePromptAsync(templateId, customPrompt, CampaignRecapTemplateId);" />
      <LineAnalysis line="552" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var sourceContent = FormatSources(sources);" />
      <LineAnalysis line="553" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var webContent = &quot;&quot;;" />
      <LineAnalysis line="554" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="555" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var result = await GenerateSummaryInternalAsync(" />
      <LineAnalysis line="556" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                arc.Name," />
      <LineAnalysis line="557" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                promptTemplate," />
      <LineAnalysis line="558" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                sourceContent," />
      <LineAnalysis line="559" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                webContent," />
      <LineAnalysis line="560" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                sources," />
      <LineAnalysis line="561" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                request?.MaxOutputTokens ?? 1500);" />
      <LineAnalysis line="562" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="563" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (result.Success)" />
      <LineAnalysis line="564" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="565" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                arc.AISummary = result.Summary;" />
      <LineAnalysis line="566" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                arc.AISummaryGeneratedAt = DateTime.UtcNow;" />
      <LineAnalysis line="567" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                await _context.SaveChangesAsync();" />
      <LineAnalysis line="568" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                result.GeneratedDate = arc.AISummaryGeneratedAt.Value;" />
      <LineAnalysis line="569" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="570" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="571" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return result;" />
      <LineAnalysis line="572" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="573" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        catch (Exception ex)" />
      <LineAnalysis line="574" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="575" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            _logger.LogError(ex, &quot;Error generating AI summary for arc {ArcId}&quot;, arcId);" />
      <LineAnalysis line="576" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return new SummaryGenerationDto" />
      <LineAnalysis line="577" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="578" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Success = false," />
      <LineAnalysis line="579" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                ErrorMessage = $&quot;Error generating summary: {ex.Message}&quot;" />
      <LineAnalysis line="580" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            };" />
      <LineAnalysis line="581" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="582" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="583" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="584" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;EntitySummaryDto?&gt; GetArcSummaryAsync(Guid arcId)" />
      <LineAnalysis line="585" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="586" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var arc = await _context.Arcs" />
      <LineAnalysis line="587" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="588" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Include(a =&gt; a.SummaryTemplate)" />
      <LineAnalysis line="589" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .FirstOrDefaultAsync(a =&gt; a.Id == arcId);" />
      <LineAnalysis line="590" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="591" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (arc == null)" />
      <LineAnalysis line="592" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return null;" />
      <LineAnalysis line="593" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="594" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return new EntitySummaryDto" />
      <LineAnalysis line="595" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="596" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityId = arcId," />
      <LineAnalysis line="597" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            EntityType = &quot;Arc&quot;," />
      <LineAnalysis line="598" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            Summary = arc.AISummary," />
      <LineAnalysis line="599" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            GeneratedAt = arc.AISummaryGeneratedAt," />
      <LineAnalysis line="600" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateId = arc.SummaryTemplateId," />
      <LineAnalysis line="601" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TemplateName = arc.SummaryTemplate?.Name," />
      <LineAnalysis line="602" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            CustomPrompt = arc.SummaryCustomPrompt," />
      <LineAnalysis line="603" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            IncludeWebSources = arc.SummaryIncludeWebSources" />
      <LineAnalysis line="604" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        };" />
      <LineAnalysis line="605" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="606" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="607" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;bool&gt; ClearArcSummaryAsync(Guid arcId)" />
      <LineAnalysis line="608" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="609" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var arc = await _context.Arcs.FirstOrDefaultAsync(a =&gt; a.Id == arcId);" />
      <LineAnalysis line="610" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (arc == null)" />
      <LineAnalysis line="611" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return false;" />
      <LineAnalysis line="612" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="613" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        arc.AISummary = null;" />
      <LineAnalysis line="614" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        arc.AISummaryGeneratedAt = null;" />
      <LineAnalysis line="615" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        await _context.SaveChangesAsync();" />
      <LineAnalysis line="616" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return true;" />
      <LineAnalysis line="617" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="618" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="619" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private async Task&lt;List&lt;SourceContent&gt;&gt; GetArcSourcesAsync(Guid arcId)" />
      <LineAnalysis line="620" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="621" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var sessions = await _context.Sessions" />
      <LineAnalysis line="622" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="623" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Where(s =&gt; s.ArcId == arcId)" />
      <LineAnalysis line="624" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .OrderBy(s =&gt; s.SessionDate ?? s.CreatedAt)" />
      <LineAnalysis line="625" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .ThenBy(s =&gt; s.Name)" />
      <LineAnalysis line="626" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Select(s =&gt; new SessionSourceSeed" />
      <LineAnalysis line="627" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="628" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Id = s.Id," />
      <LineAnalysis line="629" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Name = s.Name," />
      <LineAnalysis line="630" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                PublicNotes = s.PublicNotes" />
      <LineAnalysis line="631" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            })" />
      <LineAnalysis line="632" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .ToListAsync();" />
      <LineAnalysis line="633" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="634" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return await BuildSessionSourcesAsync(sessions);" />
      <LineAnalysis line="635" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="636" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="637" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #endregion" />
      <LineAnalysis line="638" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="639" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #region Session Summary" />
      <LineAnalysis line="640" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="641" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public async Task&lt;SummaryGenerationDto&gt; GenerateSessionSummaryFromSourcesAsync(" />
      <LineAnalysis line="642" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        string sessionName," />
      <LineAnalysis line="643" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        string sourceContent," />
      <LineAnalysis line="644" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        IReadOnlyList&lt;SummarySourceDto&gt; sources," />
      <LineAnalysis line="645" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        int maxOutputTokens = 1500)" />
      <LineAnalysis line="646" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="647" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        try" />
      <LineAnalysis line="648" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="649" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (string.IsNullOrWhiteSpace(sourceContent))" />
      <LineAnalysis line="650" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="651" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                return new SummaryGenerationDto" />
      <LineAnalysis line="652" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                {" />
      <LineAnalysis line="653" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Success = false," />
      <LineAnalysis line="654" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    ErrorMessage = &quot;No public content available for this session.&quot;" />
      <LineAnalysis line="655" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                };" />
      <LineAnalysis line="656" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="657" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="658" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var promptTemplate = await GetSessionPromptTemplateAsync();" />
      <LineAnalysis line="659" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var webContent = &quot;&quot;;" />
      <LineAnalysis line="660" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="661" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var internalSources = sources" />
      <LineAnalysis line="662" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                .Select(s =&gt; new SourceContent" />
      <LineAnalysis line="663" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                {" />
      <LineAnalysis line="664" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Type = s.Type," />
      <LineAnalysis line="665" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Title = s.Title," />
      <LineAnalysis line="666" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Content = string.Empty," />
      <LineAnalysis line="667" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    ArticleId = s.ArticleId" />
      <LineAnalysis line="668" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                })" />
      <LineAnalysis line="669" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                .ToList();" />
      <LineAnalysis line="670" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="671" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return await GenerateSummaryInternalAsync(" />
      <LineAnalysis line="672" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                sessionName," />
      <LineAnalysis line="673" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                promptTemplate," />
      <LineAnalysis line="674" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                sourceContent," />
      <LineAnalysis line="675" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                webContent," />
      <LineAnalysis line="676" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                internalSources," />
      <LineAnalysis line="677" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                maxOutputTokens);" />
      <LineAnalysis line="678" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="679" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        catch (Exception ex)" />
      <LineAnalysis line="680" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="681" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            _logger.LogError(ex, &quot;Error generating AI summary for session '{SessionName}'&quot;, sessionName);" />
      <LineAnalysis line="682" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return new SummaryGenerationDto" />
      <LineAnalysis line="683" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="684" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Success = false," />
      <LineAnalysis line="685" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                ErrorMessage = $&quot;Error generating summary: {ex.Message}&quot;" />
      <LineAnalysis line="686" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            };" />
      <LineAnalysis line="687" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="688" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="689" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="690" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #endregion" />
      <LineAnalysis line="691" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="692" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #region Internal Helpers" />
      <LineAnalysis line="693" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="694" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private async Task&lt;string&gt; GetEffectivePromptAsync(Guid? templateId, string? customPrompt, Guid defaultTemplateId)" />
      <LineAnalysis line="695" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="696" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        // Custom prompt is used as additional instructions, not a full replacement" />
      <LineAnalysis line="697" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (!string.IsNullOrWhiteSpace(customPrompt))" />
      <LineAnalysis line="698" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="699" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            // Wrap custom prompt with source content structure" />
      <LineAnalysis line="700" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return $@&quot;You are analyzing tabletop RPG campaign notes about: {{EntityName}}" />
      <LineAnalysis line="701" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="702" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="Here are the source materials. The CANONICAL CONTENT is from the article itself and should be treated as authoritative facts. The REFERENCES show how other articles mention this entity and provide additional context." />
      <LineAnalysis line="703" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="704" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="{{SourceContent}}" />
      <LineAnalysis line="705" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="706" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="{{WebContent}}" />
      <LineAnalysis line="707" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="708" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="Custom instructions from the user:" />
      <LineAnalysis line="709" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="{customPrompt}" />
      <LineAnalysis line="710" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="711" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="Based on the source materials above and following the custom instructions, provide a comprehensive summary. Treat the canonical content as the primary source of truth.&quot;;" />
      <LineAnalysis line="712" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="713" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="714" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        // Use specified template or default" />
      <LineAnalysis line="715" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var effectiveTemplateId = templateId ?? defaultTemplateId;" />
      <LineAnalysis line="716" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="717" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var template = await _context.SummaryTemplates" />
      <LineAnalysis line="718" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="719" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .FirstOrDefaultAsync(t =&gt; t.Id == effectiveTemplateId);" />
      <LineAnalysis line="720" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="721" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (template != null)" />
      <LineAnalysis line="722" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="723" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return template.PromptTemplate;" />
      <LineAnalysis line="724" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="725" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="726" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        // Fallback to default template" />
      <LineAnalysis line="727" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        template = await _context.SummaryTemplates" />
      <LineAnalysis line="728" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="729" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .FirstOrDefaultAsync(t =&gt; t.Id == defaultTemplateId);" />
      <LineAnalysis line="730" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="731" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return template?.PromptTemplate ?? throw new InvalidOperationException(&quot;Default template not found&quot;);" />
      <LineAnalysis line="732" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="733" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="734" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private async Task&lt;string&gt; GetSessionPromptTemplateAsync()" />
      <LineAnalysis line="735" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="736" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var configuredTemplate = _configuration[SessionSummaryPromptConfigKey];" />
      <LineAnalysis line="737" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (!string.IsNullOrWhiteSpace(configuredTemplate))" />
      <LineAnalysis line="738" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="739" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return configuredTemplate;" />
      <LineAnalysis line="740" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="741" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="742" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return await GetEffectivePromptAsync(null, null, CampaignRecapTemplateId);" />
      <LineAnalysis line="743" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="744" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="745" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private static string BuildPrompt(string template, string entityName, string sourceContent, string webContent)" />
      <LineAnalysis line="746" visits="2" coverage="Covered" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="747" visits="2" coverage="Covered" coveredbranches="2" totalbranches="2" content="        return template" />
      <LineAnalysis line="748" visits="2" coverage="Covered" coveredbranches="" totalbranches="" content="            .Replace(&quot;{EntityName}&quot;, entityName)" />
      <LineAnalysis line="749" visits="2" coverage="Covered" coveredbranches="" totalbranches="" content="            .Replace(&quot;{SourceContent}&quot;, sourceContent)" />
      <LineAnalysis line="750" visits="2" coverage="Covered" coveredbranches="" totalbranches="" content="            .Replace(&quot;{WebContent}&quot;, string.IsNullOrEmpty(webContent) ? &quot;&quot; : $&quot;\n\nAdditional context from external sources:\n{webContent}&quot;);" />
      <LineAnalysis line="751" visits="2" coverage="Covered" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="752" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="753" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private static string FormatSources(List&lt;SourceContent&gt; sources)" />
      <LineAnalysis line="754" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="755" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="        return string.Join(&quot;\n\n&quot;, sources.Select(s =&gt;" />
      <LineAnalysis line="756" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="            $&quot;--- From: {s.Title} ({s.Type}) ---\n{s.Content}\n---&quot;));" />
      <LineAnalysis line="757" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="758" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="759" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private static string FormatArticleSources(SourceContent? primary, List&lt;SourceContent&gt; backlinks)" />
      <LineAnalysis line="760" visits="2" coverage="Covered" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="761" visits="2" coverage="Covered" coveredbranches="" totalbranches="" content="        var parts = new List&lt;string&gt;();" />
      <LineAnalysis line="762" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="763" visits="2" coverage="Covered" coveredbranches="2" totalbranches="2" content="        if (primary != null)" />
      <LineAnalysis line="764" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="765" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="            parts.Add($&quot;=== CANONICAL CONTENT (from the article itself) ===\n{primary.Content}\n===&quot;);" />
      <LineAnalysis line="766" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="767" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="768" visits="2" coverage="Covered" coveredbranches="2" totalbranches="2" content="        if (backlinks.Any())" />
      <LineAnalysis line="769" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="770" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="            parts.Add(&quot;=== REFERENCES FROM OTHER ARTICLES ===&quot;);" />
      <LineAnalysis line="771" visits="5" coverage="Covered" coveredbranches="2" totalbranches="2" content="            foreach (var backlink in backlinks)" />
      <LineAnalysis line="772" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="773" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="                parts.Add($&quot;--- From: {backlink.Title} ---\n{backlink.Content}\n---&quot;);" />
      <LineAnalysis line="774" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="775" visits="1" coverage="Covered" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="776" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="777" visits="2" coverage="Covered" coveredbranches="" totalbranches="" content="        return string.Join(&quot;\n\n&quot;, parts);" />
      <LineAnalysis line="778" visits="2" coverage="Covered" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="779" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="780" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private async Task&lt;List&lt;SourceContent&gt;&gt; BuildSessionSourcesAsync(" />
      <LineAnalysis line="781" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        IReadOnlyList&lt;SessionSourceSeed&gt; sessions)" />
      <LineAnalysis line="782" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="783" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (sessions.Count == 0)" />
      <LineAnalysis line="784" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="785" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            return new List&lt;SourceContent&gt;();" />
      <LineAnalysis line="786" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="787" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="788" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var sessionIds = sessions.Select(s =&gt; s.Id).ToList();" />
      <LineAnalysis line="789" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="790" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var publicSessionNotes = await _context.Articles" />
      <LineAnalysis line="791" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .AsNoTracking()" />
      <LineAnalysis line="792" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Where(a =&gt; a.Type == ArticleType.SessionNote" />
      <LineAnalysis line="793" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                &amp;&amp; a.Visibility == ArticleVisibility.Public" />
      <LineAnalysis line="794" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                &amp;&amp; a.SessionId.HasValue" />
      <LineAnalysis line="795" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                &amp;&amp; sessionIds.Contains(a.SessionId.Value)" />
      <LineAnalysis line="796" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                &amp;&amp; !string.IsNullOrWhiteSpace(a.Body))" />
      <LineAnalysis line="797" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .OrderBy(a =&gt; a.CreatedAt)" />
      <LineAnalysis line="798" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .ThenBy(a =&gt; a.Title)" />
      <LineAnalysis line="799" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Select(a =&gt; new" />
      <LineAnalysis line="800" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="801" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                a.Id," />
      <LineAnalysis line="802" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                a.Title," />
      <LineAnalysis line="803" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                a.Body," />
      <LineAnalysis line="804" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                a.SessionId" />
      <LineAnalysis line="805" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            })" />
      <LineAnalysis line="806" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .ToListAsync();" />
      <LineAnalysis line="807" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="808" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var notesBySession = publicSessionNotes" />
      <LineAnalysis line="809" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .Where(n =&gt; n.SessionId.HasValue)" />
      <LineAnalysis line="810" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .GroupBy(n =&gt; n.SessionId!.Value)" />
      <LineAnalysis line="811" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            .ToDictionary(g =&gt; g.Key, g =&gt; g.ToList());" />
      <LineAnalysis line="812" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="813" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var sources = new List&lt;SourceContent&gt;();" />
      <LineAnalysis line="814" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="815" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        foreach (var session in sessions)" />
      <LineAnalysis line="816" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="817" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (!string.IsNullOrWhiteSpace(session.PublicNotes))" />
      <LineAnalysis line="818" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="819" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                sources.Add(new SourceContent" />
      <LineAnalysis line="820" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                {" />
      <LineAnalysis line="821" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Type = &quot;SessionPublicNotes&quot;," />
      <LineAnalysis line="822" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Title = $&quot;{session.Name} (Public Notes)&quot;," />
      <LineAnalysis line="823" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Content = session.PublicNotes" />
      <LineAnalysis line="824" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                });" />
      <LineAnalysis line="825" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="826" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="827" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            if (!notesBySession.TryGetValue(session.Id, out var notes))" />
      <LineAnalysis line="828" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="829" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                continue;" />
      <LineAnalysis line="830" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="831" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="832" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            foreach (var note in notes)" />
      <LineAnalysis line="833" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="834" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                sources.Add(new SourceContent" />
      <LineAnalysis line="835" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                {" />
      <LineAnalysis line="836" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Type = &quot;SessionNote&quot;," />
      <LineAnalysis line="837" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Title = note.Title," />
      <LineAnalysis line="838" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    Content = note.Body!," />
      <LineAnalysis line="839" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                    ArticleId = note.Id" />
      <LineAnalysis line="840" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                });" />
      <LineAnalysis line="841" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }" />
      <LineAnalysis line="842" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="843" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="844" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return sources;" />
      <LineAnalysis line="845" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="846" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="847" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="848" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    private async Task&lt;SummaryGenerationDto&gt; GenerateSummaryInternalAsync(" />
      <LineAnalysis line="849" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        string entityName," />
      <LineAnalysis line="850" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        string promptTemplate," />
      <LineAnalysis line="851" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        string sourceContent," />
      <LineAnalysis line="852" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        string webContent," />
      <LineAnalysis line="853" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        List&lt;SourceContent&gt; sources," />
      <LineAnalysis line="854" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        int maxOutputTokens)" />
      <LineAnalysis line="855" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    {" />
      <LineAnalysis line="856" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var prompt = BuildPrompt(promptTemplate, entityName, sourceContent, webContent);" />
      <LineAnalysis line="857" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="858" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var maxInputTokens = int.Parse(_configuration[&quot;AzureOpenAI:MaxInputTokens&quot;] ?? &quot;8000&quot;);" />
      <LineAnalysis line="859" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        if (prompt.Length / CharsPerToken &gt; maxInputTokens)" />
      <LineAnalysis line="860" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="861" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            _logger.LogWarning(&quot;Prompt exceeds max input tokens, truncating content&quot;);" />
      <LineAnalysis line="862" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var maxContentLength = maxInputTokens * CharsPerToken - (promptTemplate.Length + entityName.Length + 200);" />
      <LineAnalysis line="863" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            var truncatedSourceContent = sourceContent.Substring(0, Math.Min(sourceContent.Length, maxContentLength));" />
      <LineAnalysis line="864" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            prompt = BuildPrompt(promptTemplate, entityName, truncatedSourceContent, webContent);" />
      <LineAnalysis line="865" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        }" />
      <LineAnalysis line="866" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="867" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var messages = new List&lt;ChatMessage&gt;" />
      <LineAnalysis line="868" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="869" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            new SystemChatMessage(&quot;You are a helpful assistant that summarizes tabletop RPG campaign notes.&quot;)," />
      <LineAnalysis line="870" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            new UserChatMessage(prompt)" />
      <LineAnalysis line="871" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        };" />
      <LineAnalysis line="872" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="873" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var chatOptions = new ChatCompletionOptions" />
      <LineAnalysis line="874" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="875" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            MaxOutputTokenCount = maxOutputTokens," />
      <LineAnalysis line="876" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            Temperature = 0.7f" />
      <LineAnalysis line="877" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        };" />
      <LineAnalysis line="878" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="879" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var completion = await _chatClient.CompleteChatAsync(messages, chatOptions);" />
      <LineAnalysis line="880" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="881" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var summary = completion.Value.Content[0].Text;" />
      <LineAnalysis line="882" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var inputTokens = completion.Value.Usage.InputTokenCount;" />
      <LineAnalysis line="883" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var outputTokens = completion.Value.Usage.OutputTokenCount;" />
      <LineAnalysis line="884" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="885" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        var actualCost =" />
      <LineAnalysis line="886" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            (inputTokens / 1000m * InputTokenCostPer1K) +" />
      <LineAnalysis line="887" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            (outputTokens / 1000m * OutputTokenCostPer1K);" />
      <LineAnalysis line="888" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="889" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        return new SummaryGenerationDto" />
      <LineAnalysis line="890" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        {" />
      <LineAnalysis line="891" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            Success = true," />
      <LineAnalysis line="892" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            Summary = summary," />
      <LineAnalysis line="893" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            TokensUsed = completion.Value.Usage.TotalTokenCount," />
      <LineAnalysis line="894" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            ActualCostUSD = Math.Round(actualCost, 4)," />
      <LineAnalysis line="895" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            Sources = sources.Select(s =&gt; new SummarySourceDto" />
      <LineAnalysis line="896" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            {" />
      <LineAnalysis line="897" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Type = s.Type," />
      <LineAnalysis line="898" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                Title = s.Title," />
      <LineAnalysis line="899" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="                ArticleId = s.ArticleId" />
      <LineAnalysis line="900" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="            }).ToList()" />
      <LineAnalysis line="901" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="        };" />
      <LineAnalysis line="902" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    }" />
      <LineAnalysis line="903" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="904" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    #endregion" />
      <LineAnalysis line="905" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="}" />
      <LineAnalysis line="906" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="907" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="/// &lt;summary&gt;" />
      <LineAnalysis line="908" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="/// Internal class for holding source content during processing" />
      <LineAnalysis line="909" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="/// &lt;/summary&gt;" />
      <LineAnalysis line="910" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="internal class SourceContent" />
      <LineAnalysis line="911" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="{" />
      <LineAnalysis line="912" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public string Type { get; set; } = string.Empty;" />
      <LineAnalysis line="913" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public string Title { get; set; } = string.Empty;" />
      <LineAnalysis line="914" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public string Content { get; set; } = string.Empty;" />
      <LineAnalysis line="915" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public Guid? ArticleId { get; set; }" />
      <LineAnalysis line="916" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="}" />
      <LineAnalysis line="917" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="" />
      <LineAnalysis line="918" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="internal sealed class SessionSourceSeed" />
      <LineAnalysis line="919" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="{" />
      <LineAnalysis line="920" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public Guid Id { get; set; }" />
      <LineAnalysis line="921" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public string Name { get; set; } = string.Empty;" />
      <LineAnalysis line="922" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="    public string? PublicNotes { get; set; }" />
      <LineAnalysis line="923" visits="-1" coverage="NotCoverable" coveredbranches="" totalbranches="" content="}" />
    </File>
  </Files>
</CoverageReport>