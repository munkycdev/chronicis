@using System.Diagnostics.CodeAnalysis
@inject IArticleApiService ArticleApi
@inject ISnackbar Snackbar
@inject ILogger<FeaturedArticleDrawer> Logger
@attribute [ExcludeFromCodeCoverage]

<div class="featured-article-drawer-content chronicis-scrollbar-light">
    @if (_isLoading)
    {
        <div class="featured-article-drawer-state">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            <MudText Typo="Typo.body2" Class="mt-3">Loading article...</MudText>
        </div>
    }
    else if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Dense="true" Class="ma-2">
            @_errorMessage
        </MudAlert>
    }
    else if (_article == null)
    {
        <div class="featured-article-drawer-state">
            <MudText Typo="Typo.body1" Align="Align.Center">
                Article could not be found.
            </MudText>
        </div>
    }
    else
    {
        <div class="featured-article-drawer-panel">
            <MudText Typo="Typo.h6" Class="featured-article-drawer-title">
                @_article.Title
            </MudText>

            <div class="featured-article-drawer-actions">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="SaveAsync"
                           Disabled="_isSaving || !_hasUnsavedChanges"
                           StartIcon="@Icons.Material.Filled.Save">
                    @(_isSaving ? "Saving..." : "Save")
                </MudButton>

                @if (_hasUnsavedChanges)
                {
                    <MudText Typo="Typo.caption" Class="featured-article-drawer-dirty-state">
                        Unsaved changes
                    </MudText>
                }
            </div>

            @if (_article.WorldId.HasValue)
            {
                <PrivateNotesTipTapEditor WorldId="@_article.WorldId.Value"
                                          Value="@_editBody"
                                          ValueChanged="HandleBodyChanged"
                                          UploadContextLabel="Features article" />
            }
            else
            {
                <div class="featured-article-drawer-body">
                    <MudText Typo="Typo.body2" Class="mb-2">
                        This article is not assigned to a world, so rich editing is unavailable.
                    </MudText>
                    <MudTextField T="string"
                                  Value="@_editBody"
                                  ValueChanged="HandleBodyChanged"
                                  Lines="12"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  FullWidth="true"
                                  Immediate="true" />
                </div>
            }
        </div>
    }
</div>

@code {
    private static readonly Guid FeaturedArticleId = Guid.Parse("00d21983-dc4d-49c3-ac77-4a43943de267");

    private ArticleDto? _article;
    private string _editBody = string.Empty;
    private bool _isLoading;
    private bool _isSaving;
    private bool _hasUnsavedChanges;
    private string? _errorMessage;
    private bool _lastIsOpen;
    private int _loadVersion;

    [Parameter]
    public bool IsOpen { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        var drawerJustOpened = IsOpen && !_lastIsOpen;

        if (drawerJustOpened)
        {
            await LoadFeaturedArticleAsync();
        }

        _lastIsOpen = IsOpen;
    }

    private async Task LoadFeaturedArticleAsync()
    {
        if (!IsOpen)
        {
            return;
        }

        if (_article != null && string.IsNullOrWhiteSpace(_errorMessage))
        {
            return;
        }

        var requestVersion = ++_loadVersion;
        _isLoading = true;
        _errorMessage = null;
        await InvokeAsync(StateHasChanged);

        try
        {
            var article = await ArticleApi.GetArticleDetailAsync(FeaturedArticleId);
            if (requestVersion != _loadVersion)
            {
                return;
            }

            if (article == null)
            {
                _article = null;
                _errorMessage = "Featured article could not be loaded.";
                return;
            }

            _article = article;
            _editBody = article.Body;
            _hasUnsavedChanges = false;
        }
        catch (Exception ex)
        {
            if (requestVersion != _loadVersion)
            {
                return;
            }

            Logger.LogError(ex, "Failed to load featured article {ArticleId}", FeaturedArticleId);
            _article = null;
            _errorMessage = "Failed to load featured article.";
        }
        finally
        {
            if (requestVersion == _loadVersion)
            {
                _isLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private Task HandleBodyChanged(string value)
    {
        var normalized = value ?? string.Empty;
        if (string.Equals(_editBody, normalized, StringComparison.Ordinal))
        {
            return Task.CompletedTask;
        }

        _editBody = normalized;
        _hasUnsavedChanges = _article != null
            && !string.Equals(_article.Body ?? string.Empty, _editBody, StringComparison.Ordinal);
        return Task.CompletedTask;
    }

    private async Task SaveAsync()
    {
        if (_article == null || _isSaving || !_hasUnsavedChanges)
        {
            return;
        }

        _isSaving = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var update = new ArticleUpdateDto
            {
                Title = _article.Title,
                Body = _editBody,
                EffectiveDate = _article.EffectiveDate,
                IconEmoji = _article.IconEmoji,
                Visibility = _article.Visibility
            };

            var updated = await ArticleApi.UpdateArticleAsync(_article.Id, update);
            if (updated == null)
            {
                Snackbar.Add("Failed to save features article", Severity.Error);
                return;
            }

            _article = updated;
            _editBody = updated.Body ?? string.Empty;
            _hasUnsavedChanges = false;
            Snackbar.Add("Features article saved", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save featured article {ArticleId}", _article.Id);
            Snackbar.Add("Failed to save features article", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            await InvokeAsync(StateHasChanged);
        }
    }
}

<style>
    .featured-article-drawer-content {
        height: calc(100vh - 180px);
        overflow-y: auto;
        overflow-x: hidden;
        padding: 8px;
        color: var(--chronicis-primary);
    }

    .featured-article-drawer-state {
        display: flex;
        min-height: 100%;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 16px;
        text-align: center;
    }

    .featured-article-drawer-panel {
        padding: 4px;
    }

    .featured-article-drawer-title {
        line-height: 1.3;
        color: var(--chronicis-primary);
    }

    .featured-article-drawer-body {
        margin-top: 10px;
        padding: 10px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.7);
        color: var(--chronicis-primary);
    }

    .featured-article-drawer-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        margin-bottom: 10px;
    }

    .featured-article-drawer-dirty-state {
        color: var(--mud-palette-warning);
    }

    .featured-article-drawer-body > *:last-child {
        margin-bottom: 0 !important;
    }

    .featured-article-drawer-body img {
        max-width: 100%;
        height: auto;
    }

    .featured-article-drawer-body pre {
        overflow-x: auto;
    }
</style>
