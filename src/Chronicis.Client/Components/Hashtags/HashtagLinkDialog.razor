@inject IArticleApiService ArticleApi
@inject IHashtagApiService HashtagApi
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        
        <MudText Typo="Typo.body1" Class="mb-2">
            Hashtag: <span style="color: #C4AF8E; font-weight: 500;">#@HashtagName</span>
        </MudText>

        <MudDivider Class="my-4" />

        @if (_isLoading)
        {
            <div class="text-center py-4">
                <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                <MudText Typo="Typo.body2" Class="mt-2">Loading articles...</MudText>
            </div>
        }
        else
        {
            <MudText Typo="Typo.subtitle2" Class="mb-3">Select an article to link:</MudText>

            <!-- Search box -->
            <MudTextField @bind-Value="_searchQuery"
                          Placeholder="Search articles..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          OnKeyUp="FilterArticles"
                          Class="mb-3" />

            <!-- Article list -->
            @if (_filteredArticles?.Any() ?? false)
            {
                <MudList T="string" Dense="true" Style="max-height: 400px; overflow-y: auto;">
                    @foreach (var article in _filteredArticles)
                    {
                        <MudListItem T="string" 
                                     OnClick="@(() => SelectArticle(article))"
                                     Style="@(article.Id == _selectedArticleId ? "background-color: rgba(196, 175, 142, 0.15);" : "")">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Description" 
                                         Color="@(article.Id == _selectedArticleId ? Color.Primary : Color.Default)" 
                                         Class="mr-2" />
                                <MudText Typo="Typo.body2">
                                    @(string.IsNullOrEmpty(article.Title) ? "(Untitled)" : article.Title)
                                </MudText>
                                @if (article.Id == _selectedArticleId)
                                {
                                    <MudSpacer />
                                    <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Primary" Size="Size.Small" />
                                }
                            </div>
                        </MudListItem>
                    }
                </MudList>
            }
            else if (!string.IsNullOrEmpty(_searchQuery))
            {
                <div class="text-center py-4">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        No articles found matching "@_searchQuery"
                    </MudText>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        No articles available
                    </MudText>
                </div>
            }
        }
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled"
                   OnClick="LinkHashtag"
                   Disabled="@(!_selectedArticleId.HasValue || _isLinking)">
            @if (_isLinking)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Linking...</span>
            }
            else
            {
                <span>Link to Article</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string HashtagName { get; set; } = string.Empty;

    private List<ArticleTreeDto> _allArticles = new();
    private List<ArticleTreeDto> _filteredArticles = new();
    private string _searchQuery = string.Empty;
    private int? _selectedArticleId;
    private bool _isLoading = true;
    private bool _isLinking = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadArticles();
    }

    private async Task LoadArticles()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            // Get all root articles
            _allArticles = await ArticleApi.GetRootArticlesAsync();
            
            // Flatten the tree for easy searching
            _filteredArticles = FlattenArticleTree(_allArticles);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load articles: {ex.Message}", Severity.Error);
            _filteredArticles = new();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private List<ArticleTreeDto> FlattenArticleTree(List<ArticleTreeDto> articles)
    {
        var flattened = new List<ArticleTreeDto>();
        
        foreach (var article in articles)
        {
            flattened.Add(article);
            
            if (article.Children != null && article.Children.Any())
            {
                flattened.AddRange(FlattenArticleTree(article.Children.ToList()));
            }
        }
        
        return flattened.OrderBy(a => a.Title).ToList();
    }

    private void FilterArticles()
    {
        if (string.IsNullOrEmpty(_searchQuery))
        {
            _filteredArticles = FlattenArticleTree(_allArticles);
        }
        else
        {
            var query = _searchQuery.ToLowerInvariant();
            _filteredArticles = FlattenArticleTree(_allArticles)
                .Where(a => (a.Title ?? string.Empty).ToLowerInvariant().Contains(query))
                .ToList();
        }
        
        StateHasChanged();
    }

    private void SelectArticle(ArticleTreeDto article)
    {
        _selectedArticleId = article.Id;
        StateHasChanged();
    }

    private async Task LinkHashtag()
    {
        if (!_selectedArticleId.HasValue) return;

        _isLinking = true;
        StateHasChanged();

        try
        {
            var success = await HashtagApi.LinkHashtagAsync(HashtagName, _selectedArticleId.Value);

            if (success)
            {
                Snackbar.Add($"Hashtag #{HashtagName} linked successfully!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(_selectedArticleId.Value));
            }
            else
            {
                Snackbar.Add("Failed to link hashtag", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error linking hashtag: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLinking = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
