@using Chronicis.Shared.DTOs
@using Chronicis.Client.Components.Shared

<div class="public-tree-item @(_isExpanded ? "expanded" : "") @(IsSelected ? "selected" : "")"
     style="padding-left: @(Level * 12)px;">
    
    <div class="public-tree-item-content" @onclick="OnItemClick">
        @if (Article.HasChildren)
        {
            <span class="public-tree-expand-btn" @onclick="ToggleExpand" @onclick:stopPropagation="true">
                <MudIcon Icon="@(_isExpanded ? Icons.Material.Filled.ExpandMore : Icons.Material.Filled.ChevronRight)"
                         Size="Size.Small" />
            </span>
        }
        else
        {
            <span class="public-tree-spacer"></span>
        }

        <span class="public-tree-icon">
            <IconDisplay Icon="@Article.IconEmoji" DefaultIcon="" CssClass="tree-icon" />
        </span>

        <span class="public-tree-title" title="@Article.Title">@Article.Title</span>
    </div>

    @if (_isExpanded && Article.Children?.Any() == true)
    {
        <div class="public-tree-children">
            @foreach (var child in Article.Children.OrderBy(c => c.Title))
            {
                @* Virtual groups don't contribute to path - pass through the parent's real path *@
                <PublicArticleTreeItem Article="@child"
                                       PublicSlug="@PublicSlug"
                                       CurrentPath="@CurrentPath"
                                       ParentPath="@GetPathForChildren()"
                                       Level="@(Level + 1)"
                                       OnArticleSelected="OnArticleSelected" />
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public ArticleTreeDto Article { get; set; } = null!;

    [Parameter]
    public string PublicSlug { get; set; } = string.Empty;

    [Parameter]
    public string? CurrentPath { get; set; }

    [Parameter]
    public string? ParentPath { get; set; }

    [Parameter]
    public int Level { get; set; } = 0;

    [Parameter]
    public EventCallback<string> OnArticleSelected { get; set; }

    private bool _isExpanded = false;

    private bool IsSelected
    {
        get
        {
            // Virtual groups can't be selected
            if (Article.IsVirtualGroup) return false;
            
            var itemPath = GetArticlePath();
            return !string.IsNullOrEmpty(CurrentPath) && 
                   CurrentPath.Equals(itemPath, StringComparison.OrdinalIgnoreCase);
        }
    }

    protected override void OnParametersSet()
    {
        // Auto-expand if this node or any descendant matches the current path
        if (!string.IsNullOrEmpty(CurrentPath))
        {
            // Check if THIS node is selected (for non-virtual groups)
            if (!Article.IsVirtualGroup)
            {
                var myPath = GetArticlePath();
                if (CurrentPath.StartsWith(myPath, StringComparison.OrdinalIgnoreCase))
                {
                    // Current path starts with our path - we're on the path to the selected article
                    // Expand if we have children and the path continues past us
                    if (Article.HasChildren && 
                        (CurrentPath.Length > myPath.Length || HasMatchingDescendant()))
                    {
                        _isExpanded = true;
                    }
                }
            }
            else
            {
                // Virtual groups: check if any descendant matches
                if (HasMatchingDescendant())
                {
                    _isExpanded = true;
                }
            }
        }
    }

    private bool HasMatchingDescendant()
    {
        if (Article.Children == null || string.IsNullOrEmpty(CurrentPath)) 
            return false;
        
        // Get the path prefix for children of this node
        var childPathPrefix = GetPathForChildren() ?? "";
        
        return CheckDescendantsRecursively(Article.Children, childPathPrefix);
    }

    private bool CheckDescendantsRecursively(IEnumerable<ArticleTreeDto> children, string pathPrefix)
    {
        foreach (var child in children)
        {
            if (!child.IsVirtualGroup)
            {
                // Build the child's full path
                var childPath = string.IsNullOrEmpty(pathPrefix) 
                    ? child.Slug 
                    : $"{pathPrefix}/{child.Slug}";
                    
                if (CurrentPath!.Equals(childPath, StringComparison.OrdinalIgnoreCase) ||
                    CurrentPath.StartsWith(childPath + "/", StringComparison.OrdinalIgnoreCase))
                {
                    return true;
                }
                
                // Check this child's descendants
                if (child.Children?.Any() == true)
                {
                    if (CheckDescendantsRecursively(child.Children, childPath))
                        return true;
                }
            }
            else
            {
                // Virtual groups pass through the path prefix
                if (child.Children?.Any() == true)
                {
                    if (CheckDescendantsRecursively(child.Children, pathPrefix))
                        return true;
                }
            }
        }
        
        return false;
    }

    /// <summary>
    /// Get the path for this article (only for real articles, not virtual groups)
    /// </summary>
    private string GetArticlePath()
    {
        if (Article.IsVirtualGroup) return string.Empty;
        return BuildPathForArticle(Article);
    }

    /// <summary>
    /// Build path for a specific article, using ParentPath as base
    /// </summary>
    private string BuildPathForArticle(ArticleTreeDto article)
    {
        if (string.IsNullOrEmpty(ParentPath))
        {
            return article.Slug;
        }
        return $"{ParentPath}/{article.Slug}";
    }

    /// <summary>
    /// Get the path to pass to children.
    /// Virtual groups don't contribute to the path - pass through ParentPath.
    /// Real articles add their slug to the path.
    /// </summary>
    private string? GetPathForChildren()
    {
        if (Article.IsVirtualGroup)
        {
            // Virtual groups don't contribute to path - pass through parent's path
            return ParentPath;
        }
        
        // Real articles add their slug
        return GetArticlePath();
    }

    private void ToggleExpand()
    {
        _isExpanded = !_isExpanded;
    }

    private async Task OnItemClick()
    {
        // Virtual groups only expand/collapse, don't navigate
        if (Article.IsVirtualGroup)
        {
            _isExpanded = !_isExpanded;
            return;
        }
        
        var path = GetArticlePath();
        await OnArticleSelected.InvokeAsync(path);
    }
}
