@using Chronicis.Shared.DTOs
@inject IAISummaryApiService SummaryApi
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<div class="ai-summary-section">
    <div class="ai-summary-header" @onclick="ToggleExpanded">
        <div class="header-left">
            <MudIcon Icon="@(IsExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                     Size="Size.Small" />
            <MudText Typo="Typo.h6">AI Summary</MudText>
            @if (_summaryData?.HasSummary == true)
            {
                <MudText Typo="Typo.caption" Class="summary-timestamp">
                    Generated @GetRelativeTime(_summaryData.GeneratedAt!.Value)
                </MudText>
            }
        </div>
        @if (!IsExpanded && _summaryData?.HasSummary == true)
        {
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" 
                     Color="Color.Success" 
                     Size="Size.Small" />
        }
    </div>

    @if (IsExpanded)
    {
        <div class="ai-summary-content">
            @if (_isLoading)
            {
                <div class="loading-container">
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                    <MudText Typo="Typo.body2">@_loadingMessage</MudText>
                </div>
            }
            else if (_summaryData?.HasSummary == true)
            {
                <div class="summary-text">
                    <MudText Typo="Typo.body1">@_summaryData.Summary</MudText>
                </div>
                @if (!string.IsNullOrEmpty(_summaryData.TemplateName))
                {
                    <MudText Typo="Typo.caption" Class="template-info">
                        Template: @_summaryData.TemplateName
                    </MudText>
                }
                <div class="summary-actions">
                    <MudButton StartIcon="@Icons.Material.Filled.Refresh"
                               Size="Size.Small"
                               Variant="Variant.Text"
                               Color="Color.Primary"
                               OnClick="RegenerateSummary">
                        Regenerate
                    </MudButton>
                    <MudButton StartIcon="@Icons.Material.Filled.ContentCopy"
                               Size="Size.Small"
                               Variant="Variant.Text"
                               OnClick="CopySummary">
                        Copy
                    </MudButton>
                    <MudButton StartIcon="@Icons.Material.Filled.Delete"
                               Size="Size.Small"
                               Variant="Variant.Text"
                               Color="Color.Error"
                               OnClick="ClearSummary">
                        Clear
                    </MudButton>
                </div>
            }
            else if (_estimate != null)
            {
                <div class="generate-prompt">
                    <MudText Typo="Typo.body2" Class="mb-2">
                        No summary generated yet.
                    </MudText>
                    
                    @if (_estimate.SourceCount == 0)
                    {
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                            @NoSourcesMessage
                        </MudAlert>
                    }
                    else
                    {
                        @* Template Selection *@
                        <div class="template-selection mb-3">
                            <MudSelect T="Guid?" 
                                       Label="Summary Template" 
                                       @bind-Value="_selectedTemplateId"
                                       Variant="Variant.Outlined"
                                       Dense="true"
                                       AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem T="Guid?" Value="@((Guid?)null)">Default</MudSelectItem>
                                @foreach (var template in _templates)
                                {
                                    <MudSelectItem T="Guid?" Value="@template.Id">
                                        @template.Name
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </div>

                        @* Custom Prompt (expandable) *@
                        <MudExpansionPanels Class="mb-3">
                            <MudExpansionPanel Text="Custom Instructions (Optional)" Dense="true">
                                <MudTextField T="string"
                                              @bind-Value="_customPrompt"
                                              Label="Custom prompt (overrides template)"
                                              Variant="Variant.Outlined"
                                              Lines="3"
                                              Placeholder="@CustomPromptPlaceholder"
                                              HelperText="Leave blank to use selected template" />
                            </MudExpansionPanel>
                        </MudExpansionPanels>

                        <div class="estimate-info">
                            <MudText Typo="Typo.caption">
                                <strong>Sources:</strong> @_estimate.SourceCount @SourceLabel@(_estimate.SourceCount == 1 ? "" : "s")
                            </MudText>
                            <MudText Typo="Typo.caption">
                                <strong>Estimated tokens:</strong> ~@_estimate.EstimatedInputTokens input, ~@_estimate.EstimatedOutputTokens output
                            </MudText>
                            <MudText Typo="Typo.caption">
                                <strong>Estimated cost:</strong> ~$@_estimate.EstimatedCostUSD.ToString("F4")
                            </MudText>
                        </div>

                        <div class="generate-actions mt-3">
                            <MudButton StartIcon="@Icons.Material.Filled.Psychology"
                                       Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       OnClick="GenerateSummary"
                                       Disabled="_isLoading">
                                Generate AI Summary
                            </MudButton>
                            
                            <MudCheckBox T="bool" 
                                         @bind-Value="_saveConfiguration"
                                         Label="Remember these settings"
                                         Dense="true"
                                         Class="ml-3" />
                        </div>
                    }
                </div>
            }
            else if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Dense="true">
                    @_errorMessage
                </MudAlert>
            }
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public Guid EntityId { get; set; }

    [Parameter, EditorRequired]
    public string EntityType { get; set; } = "Campaign"; // "Campaign" or "Arc"

    [Parameter]
    public bool IsExpanded { get; set; } = false;

    [Parameter]
    public EventCallback<bool> IsExpandedChanged { get; set; }

    private EntitySummaryDto? _summaryData;
    private SummaryEstimateDto? _estimate;
    private List<SummaryTemplateDto> _templates = new();
    private bool _isLoading = false;
    private string _loadingMessage = "";
    private string _errorMessage = "";
    
    // Generation options
    private Guid? _selectedTemplateId;
    private string? _customPrompt;
    private bool _saveConfiguration = false;

    private string NoSourcesMessage => EntityType == "Campaign" 
        ? "No public session notes found in this campaign yet. Add sessions to generate a summary."
        : "No public session notes found in this arc yet. Add sessions to generate a summary.";

    private string SourceLabel => "session";

    private string CustomPromptPlaceholder => EntityType == "Campaign"
        ? "e.g., Focus on the main plot threads and character development..."
        : "e.g., Summarize the key events and how they connect to the overall story...";

    protected override async Task OnInitializedAsync()
    {
        _templates = await SummaryApi.GetTemplatesAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadSummaryData();
    }

    private async Task LoadSummaryData()
    {
        _errorMessage = "";
        
        _summaryData = await SummaryApi.GetEntitySummaryAsync(EntityType, EntityId);
        
        if (_summaryData?.HasSummary != true)
        {
            _estimate = await SummaryApi.GetEntityEstimateAsync(EntityType, EntityId);
            
            if (_estimate != null)
            {
                _selectedTemplateId = _estimate.TemplateId;
                _customPrompt = _estimate.CustomPrompt;
            }
        }
        else
        {
            _selectedTemplateId = _summaryData.TemplateId;
            _customPrompt = _summaryData.CustomPrompt;
        }
    }

    private async Task GenerateSummary()
    {
        _isLoading = true;
        _loadingMessage = "Analyzing sessions and generating summary...";
        _errorMessage = "";
        StateHasChanged();

        try
        {
            var request = new GenerateSummaryRequestDto
            {
                TemplateId = _selectedTemplateId,
                CustomPrompt = string.IsNullOrWhiteSpace(_customPrompt) ? null : _customPrompt,
                SaveConfiguration = _saveConfiguration
            };
            
            var result = await SummaryApi.GenerateEntitySummaryAsync(EntityType, EntityId, request);
            
            if (result?.Success == true)
            {
                _summaryData = new EntitySummaryDto
                {
                    EntityId = EntityId,
                    EntityType = EntityType,
                    Summary = result.Summary,
                    GeneratedAt = result.GeneratedDate,
                    TemplateId = _selectedTemplateId,
                    TemplateName = _templates.FirstOrDefault(t => t.Id == _selectedTemplateId)?.Name
                };
                
                Snackbar.Add(
                    $"Summary generated! Tokens: {result.TokensUsed}, Cost: ${result.ActualCostUSD:F4}", 
                    Severity.Success);
            }
            else
            {
                _errorMessage = result?.ErrorMessage ?? "Unknown error occurred";
                Snackbar.Add(_errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RegenerateSummary()
    {
        await ClearSummary();
        await GenerateSummary();
    }

    private async Task ClearSummary()
    {
        var success = await SummaryApi.ClearEntitySummaryAsync(EntityType, EntityId);
        if (success)
        {
            _summaryData = null;
            await LoadSummaryData();
            Snackbar.Add("Summary cleared", Severity.Info);
        }
        else
        {
            Snackbar.Add("Error clearing summary", Severity.Error);
        }
    }

    private async Task CopySummary()
    {
        if (_summaryData?.Summary != null)
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _summaryData.Summary);
            Snackbar.Add("Summary copied to clipboard", Severity.Success);
        }
    }

    private async Task ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
        await IsExpandedChanged.InvokeAsync(IsExpanded);
    }

    private string GetRelativeTime(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        
        if (span.TotalMinutes < 1) return "just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7) return $"{(int)span.TotalDays}d ago";
        
        return date.ToLocalTime().ToString("MMM d, yyyy");
    }
}
