@using Chronicis.Shared.DTOs
@inject IArticleExternalLinkApiService ExternalLinkApiService
@inject ILogger<ExternalLinksPanel> Logger

<div class="links-panel">
    <div class="links-panel-header">
        <span class="links-panel-title">External Resources</span>
        @if (_loading)
        {
            <span class="links-panel-loading">...</span>
        }
        <span class="links-panel-count">@_externalLinks.Count</span>
    </div>

    @if (_externalLinks.Any())
    {
        <div class="external-links-container">
            @foreach (var group in _externalLinks.GroupBy(el => el.Source))
            {
                <div class="external-links-source-group">
                    <div class="external-links-source-badge">@GetSourceDisplayName(group.Key)</div>
                    <div class="links-chip-container">
                        @foreach (var link in group)
                        {
                            <span class="external-link-chip" 
                                  title="@($"{link.DisplayTitle} ({link.Source})")">
                                @link.DisplayTitle
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else if (!_loading)
    {
        <div class="links-panel-empty">No external resources</div>
    }
</div>

@code {
    [Parameter]
    public Guid ArticleId { get; set; }

    [Parameter]
    public bool IsOpen { get; set; }

    private List<ArticleExternalLinkDto> _externalLinks = new();
    private bool _loading = false;
    private Guid _lastArticleId = Guid.Empty;
    private bool _wasOpen = false;
    private bool _hasLoaded = false;

    protected override async Task OnParametersSetAsync()
    {
        var articleChanged = ArticleId != _lastArticleId;
        var drawerOpened = IsOpen && !_wasOpen;
        
        if (articleChanged)
        {
            _lastArticleId = ArticleId;
            _hasLoaded = false;
            _externalLinks = new();
        }
        
        // Load when drawer opens for the first time, or when article changes and drawer is already open
        if ((drawerOpened || (articleChanged && IsOpen)) && !_hasLoaded)
        {
            await LoadAsync();
        }
        
        _wasOpen = IsOpen;
    }

    /// <summary>
    /// Public method to refresh the external links (called after save).
    /// </summary>
    public async Task RefreshAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        _hasLoaded = true;
        StateHasChanged();

        try
        {
            _externalLinks = await ExternalLinkApiService.GetExternalLinksAsync(ArticleId);
            Logger.LogDebug("Loaded {Count} external links for article {ArticleId}", _externalLinks.Count, ArticleId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading external links for article {ArticleId}", ArticleId);
            _externalLinks = new List<ArticleExternalLinkDto>();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private static string GetSourceDisplayName(string source)
    {
        return source.ToUpperInvariant() switch
        {
            "SRD" => "SRD",
            "SRD14" => "SRD 1.4",
            "SRD24" => "SRD 2.4",
            "OPEN5E" => "Open5e",
            "ROS" => "Ruins of Symbaroum",
            _ => source.ToUpperInvariant()
        };
    }
}

<style>
.links-panel {
    padding: 12px 16px;
}

.links-panel-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.links-panel-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--mud-palette-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.links-panel-loading {
    font-size: 12px;
    color: #C4AF8E;
}

.links-panel-count {
    font-size: 11px;
    background: rgba(196, 175, 142, 0.2);
    color: var(--mud-palette-text-secondary);
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: auto;
}

.external-links-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.external-links-source-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.external-links-source-badge {
    font-size: 10px;
    font-weight: 600;
    color: var(--mud-palette-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    padding: 2px 6px;
    background: rgba(196, 175, 142, 0.15);
    border-radius: 3px;
    width: fit-content;
}

.links-chip-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.external-link-chip {
    display: inline-block;
    padding: 4px 10px;
    font-size: 12px;
    background: rgba(100, 150, 200, 0.1);
    border: 1px solid rgba(100, 150, 200, 0.25);
    border-radius: 12px;
    color: var(--mud-palette-text-primary);
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.external-link-chip:hover {
    background: rgba(100, 150, 200, 0.2);
    border-color: rgba(100, 150, 200, 0.4);
}

.links-panel-empty {
    font-size: 12px;
    color: var(--mud-palette-text-secondary);
    opacity: 0.6;
    font-style: italic;
}
</style>
