@using Chronicis.Shared.DTOs
@using Chronicis.Shared.Models
@using Chronicis.Client.Services
@inject ArticleApiService ArticleApi
@inject TreeStateService TreeState
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ILogger<ArticleDetail> Logger
@implements IDisposable

<MudPaper Elevation="0" Class="article-detail-container">
    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" />
        <MudSkeleton SkeletonType="SkeletonType.Text" Height="60px" Class="mt-4" />
        <MudSkeleton SkeletonType="SkeletonType.Text" Height="40px" Class="mt-2" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" Class="mt-4" />
    }
    else if (_error != null)
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }
    else if (_article == null)
    {
        <MudText Typo="Typo.h5" Class="mb-4">Welcome to Chronicis</MudText>
        <MudText Typo="Typo.body1" Class="mb-2">
            Select an article from the navigation tree to view its details.
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Default">
            Or create a new article to start building your campaign knowledge base.
        </MudText>
    }
    else
    {
        @* Breadcrumb Navigation *@
        <MudBreadcrumbs Items="_breadcrumbItems" Class="mb-4">
            <ItemTemplate Context="item">
                <MudLink Href="#" OnClick="@(() => NavigateToBreadcrumb(item))">
                    @item.Text
                </MudLink>
            </ItemTemplate>
        </MudBreadcrumbs>

        @* Article Title - Always Editable *@
        <MudTextField @bind-Value="_editTitle"
                      Variant="Variant.Text"
                      Margin="Margin.Dense"
                      Immediate="true"
                      Placeholder="Article Title"
                      Class="article-title-input mb-2"
                      OnKeyUp="OnFieldChanged"
                      Style="font-size: 2.5rem; font-weight: 500;" />

        @* Metadata & Save Status *@
        <div class="d-flex justify-space-between align-center mb-4">
            <MudText Typo="Typo.body2" Color="Color.Default">
                Created: @_article.CreatedDate.ToLocalTime().ToString("MMM dd, yyyy 'at' h:mm tt")
                @if (_article.ModifiedDate.HasValue)
                {
                    <span> â€¢ Modified: @_article.ModifiedDate.Value.ToLocalTime().ToString("MMM dd, yyyy 'at' h:mm tt")</span>
                }
            </MudText>
            
            @* Save Status Indicator *@
            <MudText Typo="Typo.caption" Color="@GetSaveStatusColor()" Class="save-status">
                @_saveStatus
            </MudText>
        </div>

        @* Article Body - Always Editable *@
        <MudDivider Class="mb-4" />
        
        <MudTextField @bind-Value="_editBody"
                      Variant="Variant.Outlined"
                      Lines="20"
                      Immediate="true"
                      Placeholder="Write your article content here..."
                      Class="article-body-input mb-4"
                      OnKeyUp="OnFieldChanged" />

        @* Action Buttons *@
        <div class="d-flex justify-end gap-2">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Error"
                       StartIcon="@Icons.Material.Filled.Delete"
                       OnClick="OnDelete"
                       Disabled="_isSaving">
                Delete
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Save"
                       OnClick="SaveNow"
                       Disabled="_isSaving || !_hasUnsavedChanges">
                @(_isSaving ? "Saving..." : "Save")
            </MudButton>
        </div>
    }
</MudPaper>

@code {
    private ArticleDetailDto? _article;
    private List<BreadcrumbItem> _breadcrumbItems = new();
    private bool _isLoading;
    private string? _error;

    // Editing state
    private string _editTitle = string.Empty;
    private string _editBody = string.Empty;
    private bool _hasUnsavedChanges = false;
    private bool _isSaving = false;
    private string _saveStatus = string.Empty;
    private System.Threading.Timer? _autoSaveTimer;

    protected override void OnInitialized()
    {
        TreeState.OnStateChanged += OnTreeStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && TreeState.SelectedArticle != null)
        {
            await LoadArticleAsync(TreeState.SelectedArticle.Id);
        }
    }

    private async void OnTreeStateChanged()
    {
        if (TreeState.SelectedArticle != null)
        {
            // Only reload if it's a different article
            if (_article == null || _article.Id != TreeState.SelectedArticle.Id)
            {
                await LoadArticleAsync(TreeState.SelectedArticle.Id);
            }
            // If it's the same article, just update the state without reloading
            else
            {
                StateHasChanged();
            }
        }
        else
        {
            _article = null;
            StateHasChanged();
        }
    }

    private async Task LoadArticleAsync(int articleId)
    {
        try
        {
            // Cancel any pending auto-save
            _autoSaveTimer?.Dispose();
            
            _isLoading = true;
            _error = null;
            _hasUnsavedChanges = false;
            StateHasChanged();

            _article = await ArticleApi.GetArticleDetailAsync(articleId);
            
            if (_article != null)
            {
                // Initialize edit fields
                _editTitle = _article.Title;
                _editBody = _article.Body ?? string.Empty;
                _saveStatus = string.Empty;
                
                BuildBreadcrumbs();
            }
            else
            {
                _error = "Article not found.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load article {ArticleId}", articleId);
            _error = "Failed to load article. Please try again.";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void BuildBreadcrumbs()
    {
        _breadcrumbItems = _article?.Breadcrumbs
            .Select(b => new BreadcrumbItem(b.Title, null, false, b.Id.ToString()))
            .ToList() ?? new();
    }

    private void NavigateToBreadcrumb(BreadcrumbItem item)
    {
        if (int.TryParse(item.Href, out var articleId))
        {
            var articleToSelect = FindArticleInTree(TreeState.RootItems, articleId);
            if (articleToSelect != null)
            {
                TreeState.SelectArticle(articleToSelect);
            }
        }
    }

    private ViewModels.ArticleTreeItemViewModel? FindArticleInTree(List<ViewModels.ArticleTreeItemViewModel> items, int id)
    {
        foreach (var item in items)
        {
            if (item.Id == id)
                return item;

            var found = FindArticleInTree(item.Children, id);
            if (found != null)
                return found;
        }
        return null;
    }

    private void OnFieldChanged()
    {
        // Check if there are actual changes
        var titleChanged = _editTitle != _article?.Title;
        var bodyChanged = _editBody != (_article?.Body ?? string.Empty);
        
        _hasUnsavedChanges = titleChanged || bodyChanged;

        if (_hasUnsavedChanges)
        {
            _saveStatus = "Unsaved changes";
            
            // Reset auto-save timer
            _autoSaveTimer?.Dispose();
            _autoSaveTimer = new System.Threading.Timer(async _ => await AutoSave(), null, 500, Timeout.Infinite);
        }

        StateHasChanged();
    }

    private async Task AutoSave()
    {
        if (_hasUnsavedChanges && !_isSaving && _article != null)
        {
            await InvokeAsync(async () =>
            {
                await SaveArticle();
            });
        }
    }

    private async Task SaveNow()
    {
        if (_article != null)
        {
            await SaveArticle();
        }
    }

    private async Task SaveArticle()
    {
        if (_article == null || _isSaving) return;

        try
        {
            _isSaving = true;
            _saveStatus = "Saving...";
            StateHasChanged();

            var updateDto = new ArticleUpdateDto
            {
                Title = _editTitle.Trim(),
                Body = _editBody
            };

            var updated = await ArticleApi.UpdateArticleAsync(_article.Id, updateDto);

            // Update only the necessary fields
            var titleChanged = _article.Title != updated.Title;
            _article.Title = updated.Title;
            _article.Body = updated.Body;
            _article.ModifiedDate = updated.ModifiedDate;
            
            _hasUnsavedChanges = false;
            _saveStatus = $"Saved {GetTimeAgo(DateTime.Now)}";

            // Update tree state (this will trigger OnTreeStateChanged, but we handle that now)
            await TreeState.UpdateArticleAsync(updated);

            // Only reload breadcrumbs if title actually changed
            if (titleChanged)
            {
                await ReloadBreadcrumbs();
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save article {ArticleId}", _article.Id);
            _saveStatus = "Error saving";
            Snackbar.Add("Failed to save article", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task ReloadBreadcrumbs()
    {
        if (_article == null) return;

        try
        {
            // Reload article to get updated breadcrumbs
            var refreshed = await ArticleApi.GetArticleDetailAsync(_article.Id);
            if (refreshed != null)
            {
                _article.Breadcrumbs = refreshed.Breadcrumbs;
                BuildBreadcrumbs();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to reload breadcrumbs for article {ArticleId}", _article.Id);
        }
    }

    private async Task OnDelete()
    {
        if (_article == null) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Delete Article",
            $"Are you sure you want to delete '{_article.Title}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                await ArticleApi.DeleteArticleAsync(_article.Id);
                await TreeState.RemoveArticleAsync(_article.Id);
                Snackbar.Add("Article deleted successfully", Severity.Success);
                
                // Clear the view
                _article = null;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to delete article {ArticleId}", _article.Id);
                Snackbar.Add("Failed to delete article", Severity.Error);
            }
        }
    }

    private Color GetSaveStatusColor()
    {
        if (_saveStatus.StartsWith("Error")) return Color.Error;
        if (_saveStatus.StartsWith("Saving")) return Color.Info;
        if (_saveStatus.StartsWith("Saved")) return Color.Success;
        if (_saveStatus.StartsWith("Unsaved")) return Color.Warning;
        return Color.Default;
    }

    private string GetTimeAgo(DateTime time)
    {
        return "just now";
    }

    public void Dispose()
    {
        TreeState.OnStateChanged -= OnTreeStateChanged;
        _autoSaveTimer?.Dispose();
    }
}
