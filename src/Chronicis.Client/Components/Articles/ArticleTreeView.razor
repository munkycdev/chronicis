@using Chronicis.Shared.Models
@using Chronicis.Client.ViewModels
@inject IJSRuntime JSRuntime
@inject ArticleApiService ArticleApiService
@inject TreeStateService TreeStateService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudTreeView T="ArticleTreeItemViewModel" 
             Items="@GetTreeItemData()"
             Hover="true"
             Dense="true"
             Class="article-tree">
    <ItemTemplate Context="item">
        <div class="tree-item-content">
            <span class="@(item.Value?.IsSelected == true ? "selected-item" : "")" 
                  @onclick="@(() => OnArticleSelectedInternal(item.Value))">
                @item.Value?.Title
            </span>
            <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                     Size="Size.Small" 
                     Class="tree-item-menu"
                     AnchorOrigin="Origin.BottomRight"
                     TransformOrigin="Origin.TopRight">
                <MudMenuItem OnClick="@(() => OnAddChild(item.Value))">
                    <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" Class="mr-2" />
                    Add Child
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => OnEdit(item.Value))">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="mr-2" />
                    Edit
                </MudMenuItem>
                <MudDivider />
                <MudMenuItem OnClick="@(() => OnDelete(item.Value))">
                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" Class="mr-2" />
                    <span style="color: var(--mud-palette-error);">Delete</span>
                </MudMenuItem>
            </MudMenu>
        </div>
    </ItemTemplate>
</MudTreeView>

@code {
    [Parameter]
    public List<ArticleTreeItemViewModel> TreeItems { get; set; } = new();

    [Parameter]
    public EventCallback<ArticleTreeItemViewModel> OnArticleSelected { get; set; }

    private List<TreeItemData<ArticleTreeItemViewModel>> GetTreeItemData()
    {
        var treeItemData = new List<TreeItemData<ArticleTreeItemViewModel>>();
        
        foreach (var item in TreeItems)
        {
            treeItemData.Add(ConvertToTreeItemData(item));
        }
        
        return treeItemData;
    }

    private TreeItemData<ArticleTreeItemViewModel> ConvertToTreeItemData(ArticleTreeItemViewModel viewModel)
    {
        var treeItem = new TreeItemData<ArticleTreeItemViewModel>
        {
            Value = viewModel,
            Expanded = viewModel.IsExpanded,
            Children = new List<TreeItemData<ArticleTreeItemViewModel>>()
        };

        if (viewModel.Children?.Any() == true)
        {
            foreach (var child in viewModel.Children)
            {
                treeItem.Children.Add(ConvertToTreeItemData(child));
            }
        }

        return treeItem;
    }

    private async Task OnArticleSelectedInternal(ArticleTreeItemViewModel? item)
    {
        if (item != null)
        {
            await OnArticleSelected.InvokeAsync(item);
        }
    }

    private async Task OnAddChild(ArticleTreeItemViewModel? parent)
    {
        if (parent == null) return;

        var parameters = new DialogParameters
        {
            { "Mode", ArticleEditor.EditorMode.Create },
            { "ParentId", parent.Id },
            { "OnSaved", EventCallback.Factory.Create<(string Title, string Body)>(this, async (data) => 
            {
                try
                {
                    var created = await ArticleApiService.CreateArticleAsync(new ArticleCreateDto
                    {
                        Title = data.Title,
                        ParentId = parent.Id,
                        Body = data.Body
                    });
                    
                    await TreeStateService.AddArticleAsync(created);
                    Snackbar.Add("Article created successfully!", Severity.Success);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Failed to create article: {ex.Message}", Severity.Error);
                }
            }) }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true 
        };

        await DialogService.ShowAsync<ArticleEditor>("Create Article", parameters, options);
    }

    private async Task OnEdit(ArticleTreeItemViewModel? item)
    {
        if (item == null) return;

        var parameters = new DialogParameters
        {
            { "Mode", ArticleEditor.EditorMode.Edit },
            { "Article", new ArticleDto 
            { 
                Id = item.Id, 
                Title = item.Title,
                Body = item.Body ?? string.Empty,
                ParentId = item.ParentId
            } },
            { "OnSaved", EventCallback.Factory.Create<(string Title, string Body)>(this, async (data) => 
            {
                try
                {
                    var updated = await ArticleApiService.UpdateArticleAsync(item.Id, new ArticleUpdateDto
                    {
                        Title = data.Title,
                        Body = data.Body
                    });
                    
                    await TreeStateService.UpdateArticleAsync(updated);
                    Snackbar.Add("Article updated successfully!", Severity.Success);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Failed to update article: {ex.Message}", Severity.Error);
                }
            }) }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true 
        };

        await DialogService.ShowAsync<ArticleEditor>("Edit Article", parameters, options);
    }

    private async Task OnDelete(ArticleTreeItemViewModel? item)
    {
        if (item == null) return;

        var result = await DialogService.ShowMessageBox(
            "Delete Article",
            $"Are you sure you want to delete '{item.Title}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");
        
        if (result == true)
        {
            try
            {
                await ArticleApiService.DeleteArticleAsync(item.Id);
                await TreeStateService.RemoveArticleAsync(item.Id);
                Snackbar.Add("Article deleted successfully!", Severity.Success);
            }
            catch (HttpRequestException ex)
            {
                if (ex.StatusCode == System.Net.HttpStatusCode.BadRequest)
                {
                    Snackbar.Add("Cannot delete article with children. Delete child articles first.", Severity.Warning);
                }
                else
                {
                    Snackbar.Add("Failed to delete article.", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to delete article: {ex.Message}", Severity.Error);
            }
        }
    }
}
@code {
    protected override void OnInitialized()
    {
        // Register keyboard shortcuts
        JSRuntime.InvokeVoidAsync("registerKeyboardShortcuts");
    }
}