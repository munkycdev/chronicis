<style>
    .article-tree {
        width: 100%;
    }

    .tree-item {
        width: 100%;
    }

    .tree-item-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
        font-size: 1.5rem;
    }

        .tree-item-content:hover {
            background-color: rgba(196, 175, 142, 0.1); /* Beige-gold with opacity */
        }

        .tree-item-content .selected-item {
            font-weight: 600;
            color: #C4AF8E; /* Beige-gold */
            background-color: rgba(196, 175, 142, 0.2);
        }

    .tree-item-menu {
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .tree-item:hover .tree-item-menu,
    .tree-item-content:hover .tree-item-menu {
        opacity: 1;
    }

    /* Ensure menu button is small and unobtrusive */
    .tree-item-menu button {
        padding: 4px;
        min-width: unset;
    }

    /* Add subtle hover glow effect */
    .tree-item-content:hover {
        box-shadow: 0 0 8px rgba(196, 175, 142, 0.3);
    }
</style>
@using Chronicis.Shared.Models
@using Chronicis.Client.ViewModels
@inject IJSRuntime JSRuntime
@inject ArticleApiService ArticleApiService
@inject TreeStateService TreeStateService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@implements IDisposable

<MudTreeView T="ArticleTreeItemViewModel" 
             Items="@GetTreeItemData()"
             Hover="true"
             Dense="false"
             Class="article-tree">
    <ItemTemplate>
        <MudTreeViewItem @bind-Expanded="@context.Expanded"
                         Value="@context.Value"
                         Items="@context.Children"
                         Selected="@(context.Value?.IsSelected == true)"
                         Class="article-tree-view-item"
        >
            <Content>
                <div class="tree-item-content" @onclick ="@(() => OnArticleSelectedInternal(context.Value))">
                    <span>
                        <MudMenu Icon="@GetTreeViewIcon(context.Expanded)"
                                 Color="Color.Primary" />
                        @context.Value?.Title
                    </span>
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                             Color=Color.Primary
                             Size="Size.Small"
                             Class="tree-item-menu"
                             AnchorOrigin="Origin.BottomRight"
                             TransformOrigin="Origin.TopRight"
                             @onclick:stopPropagation="true">
                        <MudMenuItem OnClick="@(() => OnAddChild(context.Value))">
                            <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" Class="mr-2" />
                            Add Child
                        </MudMenuItem>
                        <MudMenuItem OnClick="@(() => OnEdit(context.Value))">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="mr-2" />
                            Edit
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem OnClick="@(() => OnDelete(context.Value))">
                            <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" Class="mr-2" />
                            <span style="color: var(--mud-palette-error);">Delete</span>
                        </MudMenuItem>
                    </MudMenu>
                </div>
            </Content>
        </MudTreeViewItem>
    </ItemTemplate>
</MudTreeView>

@code {
        [Parameter]
        public List<ArticleTreeItemViewModel> TreeItems { get; set; } = new();

        [Parameter]
        public EventCallback<ArticleTreeItemViewModel> OnArticleSelected { get; set; }

    protected override void OnInitialized()
    {
        // Register keyboard shortcuts
        JSRuntime.InvokeVoidAsync("registerKeyboardShortcuts");
        TreeStateService.OnStateChanged += StateHasChanged;
    }

    public void Dispose()
    {
        TreeStateService.OnStateChanged -= StateHasChanged;
    }

    private string GetTreeViewIcon(bool expanded)
    {
        if (expanded)
        {
            return Icons.Material.Filled.ArrowDropDown;
        }
        else
        {
            return Icons.Material.Filled.ArrowRight;
        }
    }

    private List<TreeItemData<ArticleTreeItemViewModel>> GetTreeItemData()
    {
        var treeItemData = new List<TreeItemData<ArticleTreeItemViewModel>>();

        foreach (var item in TreeItems)
        {
            treeItemData.Add(ConvertToTreeItemData(item));
        }

        return treeItemData;
    }

    private TreeItemData<ArticleTreeItemViewModel> ConvertToTreeItemData(ArticleTreeItemViewModel viewModel)
    {
        var children = new List<TreeItemData<ArticleTreeItemViewModel>>();

        // Recursively convert all children that are already loaded
        if (viewModel.Children?.Any() == true)
        {
            foreach (var child in viewModel.Children)
            {
                children.Add(ConvertToTreeItemData(child));
            }
        }

        var treeItem = new TreeItemData<ArticleTreeItemViewModel>
        {
            Value = viewModel,
            Expanded = viewModel.IsSelected,
            Expandable = viewModel.HasChildren || viewModel.Children.Any(),
            Children = children
        };

        return treeItem;
    }

    private async Task OnArticleSelectedInternal(ArticleTreeItemViewModel? item)
    {
        if (item != null)
        {
            await OnArticleSelected.InvokeAsync(item);
        }
    }

    private async Task OnAddChild(ArticleTreeItemViewModel? parent)
    {
        if (parent == null) return;

        var parameters = new DialogParameters
        {
            { "Mode", ArticleEditor.EditorMode.Create },
            { "ParentId", parent.Id },
            { "OnSaved", EventCallback.Factory.Create<(string Title, string Body)>(this, async (data) => 
            {
                try
                {
                    var created = await ArticleApiService.CreateArticleAsync(new ArticleCreateDto
                    {
                        Title = data.Title,
                        ParentId = parent.Id,
                        Body = data.Body
                    });
                    
                    await TreeStateService.AddArticleAsync(created);
                    Snackbar.Add("Article created successfully!", Severity.Success);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Failed to create article: {ex.Message}", Severity.Error);
                }
            }) }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true 
        };

        await DialogService.ShowAsync<ArticleEditor>("Create Article", parameters, options);
    }

    private async Task OnEdit(ArticleTreeItemViewModel? item)
    {
        if (item == null) return;

        var parameters = new DialogParameters
        {
            { "Mode", ArticleEditor.EditorMode.Edit },
            { "Article", new ArticleDto 
            { 
                Id = item.Id, 
                Title = item.Title,
                Body = item.Body ?? string.Empty,
                ParentId = item.ParentId
            } },
            { "OnSaved", EventCallback.Factory.Create<(string Title, string Body)>(this, async (data) => 
            {
                try
                {
                    var updated = await ArticleApiService.UpdateArticleAsync(item.Id, new ArticleUpdateDto
                    {
                        Title = data.Title,
                        Body = data.Body
                    });
                    
                    await TreeStateService.UpdateArticleAsync(updated);
                    Snackbar.Add("Article updated successfully!", Severity.Success);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Failed to update article: {ex.Message}", Severity.Error);
                }
            }) }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true 
        };

        await DialogService.ShowAsync<ArticleEditor>("Edit Article", parameters, options);
    }

    private async Task OnDelete(ArticleTreeItemViewModel? item)
    {
        if (item == null) return;

        string message;
        if (item.Children?.Any() == true)
        {
            message = $"'{item.Title}' has {item.Children.Count} child article(s). Deleting it will also delete all children. This action cannot be undone. Are you sure?";
        }
        else
        {
            message = $"Are you sure you want to delete '{item.Title}'? This action cannot be undone.";
        }

        var result = await DialogService.ShowMessageBox(
            "Delete Article",
            message,
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                await ArticleApiService.DeleteArticleAsync(item.Id);
                await TreeStateService.RemoveArticleAsync(item.Id);
                Snackbar.Add("Article deleted successfully!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to delete article: {ex.Message}", Severity.Error);
            }
        }
    }
}