@using Chronicis.Shared.DTOs
@using Chronicis.Client.Services
@inject ArticleApiService ArticleApi
@inject TreeStateService TreeState
@inject ILogger<ArticleTreeView> Logger

<MudPaper Class="pa-4" Elevation="0">
    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" />
        <MudText Typo="Typo.body2" Class="mt-2">Loading articles...</MudText>
    }
    else if (_error != null)
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }
    else if (!_rootArticles.Any())
    {
        <MudText Typo="Typo.body2" Color="Color.Default">No articles found. Create your first article to get started!</MudText>
    }
    else
    {
        <MudList Dense="true">
            @foreach (var article in _rootArticles)
            {
                <ArticleTreeNode Article="@article" 
                                Level="0"
                                OnArticleSelected="@OnArticleSelected"
                                OnLoadChildren="@LoadChildrenAsync"
                                ExpandedNodes="@_expandedNodes"
                                SelectedId="@TreeState.SelectedArticleId"
                                ChildrenCache="@_childrenCache" />
            }
        </MudList>
    }
</MudPaper>

@code {
    private List<ArticleTreeDto> _rootArticles = new();
    private Dictionary<int, List<ArticleTreeDto>> _childrenCache = new();
    private HashSet<int> _expandedNodes = new();
    private bool _isLoading = true;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        await LoadRootArticlesAsync();
    }

    private async Task LoadRootArticlesAsync()
    {
        try
        {
            _isLoading = true;
            _error = null;
            _rootArticles = await ArticleApi.GetRootArticlesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load root articles");
            _error = "Failed to load articles. Please try again.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnArticleSelected(int articleId)
    {
        TreeState.SelectedArticleId = articleId;
        StateHasChanged();
    }

    private async Task LoadChildrenAsync(int parentId)
    {
        if (_childrenCache.ContainsKey(parentId))
            return;

        try
        {
            var children = await ArticleApi.GetChildrenAsync(parentId);
            _childrenCache[parentId] = children;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load children for article {ParentId}", parentId);
        }
    }
}
