@* 
    ArticleDetailWikiLinkAutocomplete Component
    
    This is a legacy autocomplete implementation specifically for ArticleDetail.razor.
    It differs from the newer WikiLinkAutocomplete component (in Shared) which uses
    WikiLinkAutocompleteService for centralized state management.
    
    Key differences:
    - Direct parameter-based control (no service dependency)
    - Custom positioning logic for inline editing
    - Create-new-article option in the autocomplete dropdown
    
    TODO: Consider migrating ArticleDetail to use the service-based approach
*@

@using System.Diagnostics.CodeAnalysis
@attribute [ExcludeFromCodeCoverage]
@inject ILogger<WikiLinkAutocomplete> Logger

<div class="wiki-link-autocomplete" 
     style="left: @($"{Position.X}px"); top: @($"{Position.Y}px");">
    
    @if (Loading)
    {
        <div class="wiki-link-loading">
            Searching...
        </div>
    }
    else if (!Suggestions.Any())
    {        
        <div class="wiki-link-no-results">
            @if (Query.Length < 3)
            {
                <text>Type at least 3 characters to search</text>
            }
            else
            {
                @if (IsExternalQuery)
                {
                    <text>No results found</text>
                }
                else
                {
                    <text>No articles found</text>
                    <div class="wiki-link-create-option" @onclick="OnCreateClick">
                        <span class="wiki-link-create-icon">+</span>
                        Create "@GetArticleName()" in Wiki root
                    </div>
                }
            }
        </div>
    }
    else
    {
        @for (int i = 0; i < Suggestions.Count; i++)
        {
            var suggestion = Suggestions[i];
            var index = i;
            var isSelected = index == SelectedIndex;
            
            <div class="wiki-link-suggestion @(isSelected ? "selected" : "")"
                 @onclick="() => OnSuggestionClick(suggestion)"
                 @onmouseenter="() => OnSuggestionHover(index)">
                <div class="wiki-link-suggestion-title">
                    @suggestion.DisplayTitle
                    @if (suggestion.IsExternal && !string.IsNullOrWhiteSpace(suggestion.SourceBadge))
                    {
                        <span class="wiki-link-suggestion-badge">@suggestion.SourceBadge</span>
                    }
                </div>
                @if (!string.IsNullOrWhiteSpace(suggestion.SecondaryText))
                {
                    <div class="wiki-link-suggestion-path">@suggestion.SecondaryText</div>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public List<WikiLinkAutocompleteItem> Suggestions { get; set; } = new();

    [Parameter]
    public bool Loading { get; set; }

    [Parameter]
    public int SelectedIndex { get; set; }

    [Parameter]
    public EventCallback<int> SelectedIndexChanged { get; set; }

    [Parameter]
    public EventCallback<WikiLinkAutocompleteItem> OnSelect { get; set; }

    [Parameter]
    public (double X, double Y) Position { get; set; }

    [Parameter]
    public string Query { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> OnCreate { get; set; }

    [Parameter]
    public bool IsExternalQuery { get; set; }

    private async Task OnSuggestionClick(WikiLinkAutocompleteItem suggestion)
    {
        Logger.LogDebug("WikiLinkAutocomplete: OnSuggestionClick called for {Title}", suggestion.Title);
        await OnSelect.InvokeAsync(suggestion);
        Logger.LogDebug("WikiLinkAutocomplete: OnSelect.InvokeAsync completed");
    }

    private async Task OnSuggestionHover(int index)
    {
        if (SelectedIndex != index)
        {
            await SelectedIndexChanged.InvokeAsync(index);
        }
    }

    private async Task OnCreateClick()
    {
        var articleName = GetArticleName();
        Logger.LogDebug("WikiLinkAutocomplete: OnCreateClick called for {Name}", articleName);
        await OnCreate.InvokeAsync(articleName);
    }

    private string GetArticleName()
    {
        // If query contains path separators, extract just the article name (last segment)
        var segments = Query.Split('/');
        var name = segments.Last().Trim();
        
        // Capitalize first letter
        if (!string.IsNullOrEmpty(name))
        {
            name = char.ToUpper(name[0]) + name.Substring(1);
        }
        
        return name;
    }
}
