@* ArticleMetadataDrawer.razor - Right-side metadata panel for articles *@
@* REFACTORED: Now manages data loading for backlinks, outgoing links, and external links *@

@using Chronicis.Shared.Enums
@using Chronicis.Shared.DTOs
@using System.Diagnostics.CodeAnalysis
@attribute [ExcludeFromCodeCoverage]
@inject IArticleApiService ArticleApi
@inject ILinkApiService LinkApi
@inject IArticleExternalLinkApiService ExternalLinkApi
@inject IArticleCacheService ArticleCache
@inject IUserApiService UserApi
@inject ITreeStateService TreeState
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<style>
    .metadata-drawer .mud-drawer-content {
        padding: 8px;
    }
    .metadata-drawer.mud-drawer-persistent {
        height: auto !important;
    }
    .metadata-drawer p {
        font-size: 0.8rem;
    }

    /* Scrollable metadata drawer */
    .metadata-drawer-scrollable {
        height: calc(100vh - 180px);
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 24px;
    }
    
    /* Section styling */
    .metadata-section {
        margin-bottom: 8px;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px 8px 16px;
    }
    
    .section-icon {
        color: var(--chronicis-beige-gold);
    }
    
    .section-title {
        color: var(--mud-palette-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.75px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    /* Metadata row styling */
    .metadata-row {
        display: flex;
        align-items: flex-start;
        padding: 8px 16px;
        gap: 12px;
    }
    
    .metadata-row .mud-icon-root {
        color: var(--mud-palette-text-secondary);
        margin-top: 2px;
    }
    
    .metadata-content {
        flex: 1;
        min-width: 0;
    }
    
    .metadata-label {
        font-size: 0.7rem;
        color: var(--mud-palette-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
        font-weight: 500;
    }
    
    .metadata-value {
        font-size: 0.875rem;
        color: var(--mud-palette-text-primary);
        word-break: break-word;
    }
    
    .metadata-value-secondary {
        font-size: 0.75rem;
        color: var(--mud-palette-text-secondary);
        margin-top: 2px;
    }
</style>

<MudDrawer @bind-Open="IsOpen"
           @bind-Open:after="OnOpenChangedInternal"
           Fixed="true"
           Anchor="Anchor.End"
           Elevation="9999"
           Variant="@DrawerVariant.Persistent"
           ClipMode="@DrawerClipMode.Always"
           Class="metadata-drawer">
    <MudDrawerHeader Class="backlinks-header">
        <MudText Typo="Typo.h6" Class="backlinks-title">
            <MudIcon Icon="@Icons.Material.Filled.IntegrationInstructions" Size="Size.Small" />
            Metadata
        </MudText>
    </MudDrawerHeader>
    <MudDrawerContainer Class="metadata-drawer-scrollable chronicis-scrollbar-light">
        
        <!-- ========================================= -->
        <!-- SECTION 1: LINKS & CONNECTIONS           -->
        <!-- ========================================= -->
        <div class="metadata-section">
            <div class="section-header">
                <MudIcon Icon="@Icons.Material.Filled.AccountTree" Size="Size.Small" Class="section-icon" />
                <MudText Typo="Typo.subtitle2" Class="section-title">Links & Connections</MudText>
            </div>
        </div>
        
        <!-- Outgoing Links Panel - REFACTORED to use data parameters -->
        <OutgoingLinksPanel OutgoingLinks="_outgoingLinks"
                            IsLoading="_loadingOutgoingLinks"
                            OnNavigateToArticle="HandleNavigateToArticle" />
        
        <MudDivider Class="my-2" Style="opacity: 0.2;" />
        
        <!-- Backlinks Panel - REFACTORED to use data parameters -->
        <BacklinksPanel Backlinks="_backlinks"
                        IsLoading="_loadingBacklinks"
                        OnNavigateToArticle="HandleNavigateToArticle" />
        
        <MudDivider Class="my-2" Style="opacity: 0.2;" />
        
        <!-- External Links Panel - REFACTORED to use data parameters -->
        <ExternalLinksPanel ExternalLinks="_externalLinks"
                            IsLoading="_loadingExternalLinks" />
        
        <MudDivider Class="my-4" Style="opacity: 0.3;" />
        
        <!-- ========================================= -->
        <!-- SECTION 2: QUICK ACTIONS (Creator Only)  -->
        <!-- ========================================= -->
        @if (_isCreator)
        {
            <!-- Visibility Section -->
            <div class="metadata-section">
                <div class="section-header">
                    <MudIcon Icon="@GetVisibilityIcon(_currentVisibility)" Size="Size.Small" Class="section-icon" />
                    <MudText Typo="Typo.subtitle2" Class="section-title">Visibility</MudText>
                </div>
                
                <div class="px-4 pb-3">
                    <MudSelect T="ArticleVisibility" 
                               Value="@_currentVisibility"
                               ValueChanged="@HandleVisibilityChanged"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Disabled="_isSavingVisibility"
                               AnchorOrigin="Origin.BottomCenter"
                               TransformOrigin="Origin.TopCenter">
                        <MudSelectItem Value="ArticleVisibility.Public">
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                                <span>Public</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="ArticleVisibility.MembersOnly">
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.Group" Size="Size.Small" />
                                <span>Members Only</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="ArticleVisibility.Private">
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" />
                                <span>Private</span>
                            </div>
                        </MudSelectItem>
                    </MudSelect>
                    <MudText Typo="Typo.caption" Class="mt-1" Style="color: var(--mud-palette-text-secondary); font-size: 0.7rem;">
                        @GetVisibilityDescription(_currentVisibility)
                    </MudText>
                </div>
            </div>
            
            <!-- Aliases Section -->
            <div class="metadata-section">
                <div class="section-header">
                    <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Class="section-icon" />
                    <MudText Typo="Typo.subtitle2" Class="section-title">Aliases</MudText>
                </div>
                
                <div class="px-4 pb-3">
                    <MudTextField @bind-Value="_aliasesText"
                                  Placeholder="Enter aliases, separated by commas"
                                  Variant="Variant.Outlined"
                                  Lines="2"
                                  HelperText="Alternative names for linking"
                                  Disabled="_isSavingAliases"
                                  Immediate="false"
                                  DebounceInterval="500"
                                  OnBlur="HandleAliasesBlur" />
                    @if (_isSavingAliases)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-1" />
                    }
                </div>
            </div>
            
            <MudDivider Class="my-4" Style="opacity: 0.3;" />
        }
        
        <!-- ========================================= -->
        <!-- SECTION 3: ARTICLE INFORMATION           -->
        <!-- ========================================= -->
        <div class="metadata-section">
            <div class="section-header">
                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="section-icon" />
                <MudText Typo="Typo.subtitle2" Class="section-title">Article Information</MudText>
            </div>
        </div>
        
        <!-- Article Type -->
        <div class="metadata-row">
            <MudIcon Icon="@GetArticleTypeIcon(Article.Type)" Size="Size.Small" />
            <div class="metadata-content">
                <div class="metadata-label">Type</div>
                <div class="metadata-value">@GetArticleTypeLabel(Article.Type)</div>
            </div>
        </div>
        
        <!-- Visibility (for non-creators, read-only) -->
        @if (!_isCreator)
        {
            <div class="metadata-row">
                <MudIcon Icon="@GetVisibilityIcon(Article.Visibility)" Size="Size.Small" />
                <div class="metadata-content">
                    <div class="metadata-label">Visibility</div>
                    <div class="metadata-value">@GetVisibilityLabel(Article.Visibility)</div>
                </div>
            </div>
        }
        
        <!-- Effective Date -->
        <div class="metadata-row">
            <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" />
            <div class="metadata-content">
                <div class="metadata-label">Effective Date</div>
                <div class="metadata-value">@Article.EffectiveDate.ToString("MMMM d, yyyy")</div>
                <div class="metadata-value-secondary">@Article.EffectiveDate.ToString("h:mm tt")</div>
            </div>
        </div>
        
        <!-- Created By -->
        <div class="metadata-row">
            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Size="Size.Small" />
            <div class="metadata-content">
                <div class="metadata-label">Created By</div>
                <div class="metadata-value">@(Article.CreatedByName ?? "Unknown")</div>
                <div class="metadata-value-secondary">@Article.CreatedAt.ToString("MMM d, yyyy 'at' h:mm tt")</div>
            </div>
        </div>
        
        <!-- Last Modified By (only show if modified) -->
        @if (Article.ModifiedAt.HasValue)
        {
            <div class="metadata-row">
                <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                <div class="metadata-content">
                    <div class="metadata-label">Last Modified By</div>
                    <div class="metadata-value">@(Article.LastModifiedByName ?? Article.CreatedByName ?? "Unknown")</div>
                    <div class="metadata-value-secondary">@Article.ModifiedAt.Value.ToString("MMM d, yyyy 'at' h:mm tt")</div>
                </div>
            </div>
        }
        
        <!-- Article ID -->
        <div class="metadata-row">
            <MudIcon Icon="@Icons.Material.Filled.Fingerprint" Size="Size.Small" />
            <div class="metadata-content">
                <div class="metadata-label">Article ID</div>
                <div class="metadata-value" style="font-family: monospace; font-size: 0.7rem;">@Article.Id</div>
            </div>
        </div>
        
        <!-- World ID -->
        @if (Article.WorldId.HasValue)
        {
            <div class="metadata-row">
                <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                <div class="metadata-content">
                    <div class="metadata-label">World ID</div>
                    <div class="metadata-value" style="font-family: monospace; font-size: 0.7rem;">@Article.WorldId</div>
                </div>
            </div>
        }
        
        <!-- Campaign ID -->
        @if (Article.CampaignId.HasValue)
        {
            <div class="metadata-row">
                <MudIcon Icon="@Icons.Material.Filled.Map" Size="Size.Small" />
                <div class="metadata-content">
                    <div class="metadata-label">Campaign ID</div>
                    <div class="metadata-value" style="font-family: monospace; font-size: 0.7rem;">@Article.CampaignId</div>
                </div>
            </div>
        }
        
        <!-- Arc ID -->
        @if (Article.ArcId.HasValue)
        {
            <div class="metadata-row">
                <MudIcon Icon="@Icons.Material.Filled.Timeline" Size="Size.Small" />
                <div class="metadata-content">
                    <div class="metadata-label">Arc ID</div>
                    <div class="metadata-value" style="font-family: monospace; font-size: 0.7rem;">@Article.ArcId</div>
                </div>
            </div>
        }
        
    </MudDrawerContainer>
</MudDrawer>

@code {
    // Link panel state - managed by THIS component
    private List<BacklinkDto> _backlinks = new();
    private bool _loadingBacklinks = false;
    
    private List<BacklinkDto> _outgoingLinks = new();
    private bool _loadingOutgoingLinks = false;
    
    private List<ArticleExternalLinkDto> _externalLinks = new();
    private bool _loadingExternalLinks = false;
    
    private Guid _lastArticleId = Guid.Empty;
    private bool _isCreator;
    private ArticleVisibility _currentVisibility;
    private bool _isSavingVisibility;
    private Guid? _currentUserId;
    
    // Aliases
    private string _aliasesText = string.Empty;
    private string _originalAliasesText = string.Empty;
    private bool _isSavingAliases;

    [Parameter]
    public ArticleDto Article { get; set; } = null!;

    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter]
    public EventCallback OnArticleVisibilityChanged { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var user = await UserApi.GetUserProfileAsync();
        _currentUserId = user?.Id;
    }

    protected override async Task OnParametersSetAsync()
    {
        _isCreator = _currentUserId.HasValue && Article.CreatedBy == _currentUserId.Value;
        _currentVisibility = Article.Visibility;
        
        // Initialize aliases text from Article
        var newAliasesText = Article.Aliases != null && Article.Aliases.Any()
            ? string.Join(", ", Article.Aliases.Select(a => a.AliasText))
            : string.Empty;
        
        // Only update if the article changed (not just user editing)
        if (_originalAliasesText != newAliasesText || string.IsNullOrEmpty(_aliasesText))
        {
            _aliasesText = newAliasesText;
            _originalAliasesText = newAliasesText;
        }
        
        // Load links when article changes
        var articleChanged = Article.Id != _lastArticleId;
        if (articleChanged)
        {
            _lastArticleId = Article.Id;
            _backlinks = new();
            _outgoingLinks = new();
            _externalLinks = new();
            
            // Only load if drawer is already open
            if (IsOpen)
            {
                await Task.WhenAll(
                    LoadBacklinksAsync(),
                    LoadOutgoingLinksAsync(),
                    LoadExternalLinksAsync()
                );
            }
        }
    }

    private async Task HandleVisibilityChanged(ArticleVisibility newVisibility)
    {
        if (_isSavingVisibility || newVisibility == _currentVisibility) return;

        var previousVisibility = _currentVisibility;
        _isSavingVisibility = true;
        _currentVisibility = newVisibility; // Optimistic update
        StateHasChanged();

        try
        {
            var updateDto = new ArticleUpdateDto
            {
                Title = Article.Title,
                Body = Article.Body,
                Visibility = newVisibility
            };

            await ArticleApi.UpdateArticleAsync(Article.Id, updateDto);
            
            Article.Visibility = newVisibility;
            TreeState.UpdateNodeVisibility(Article.Id, newVisibility);
            
            Snackbar.Add($"Visibility changed to {GetVisibilityLabel(newVisibility)}", Severity.Success);
            
            await OnArticleVisibilityChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update visibility: {ex.Message}", Severity.Error);
            _currentVisibility = previousVisibility; // Revert on failure
        }
        finally
        {
            _isSavingVisibility = false;
            StateHasChanged();
        }
    }

    private static string GetVisibilityIcon(ArticleVisibility visibility) => visibility switch
    {
        ArticleVisibility.Public => Icons.Material.Filled.Public,
        ArticleVisibility.MembersOnly => Icons.Material.Filled.Group,
        ArticleVisibility.Private => Icons.Material.Filled.Lock,
        _ => Icons.Material.Filled.Help
    };

    private static string GetVisibilityLabel(ArticleVisibility visibility) => visibility switch
    {
        ArticleVisibility.Public => "Public",
        ArticleVisibility.MembersOnly => "Members Only",
        ArticleVisibility.Private => "Private",
        _ => "Unknown"
    };

    private static string GetVisibilityDescription(ArticleVisibility visibility) => visibility switch
    {
        ArticleVisibility.Public => "Anyone can view this article, including visitors to public worlds.",
        ArticleVisibility.MembersOnly => "Only members of this world can view this article.",
        ArticleVisibility.Private => "Only you can view this article. Hidden from all other users.",
        _ => ""
    };

    private static string GetArticleTypeIcon(ArticleType type) => type switch
    {
        ArticleType.WikiArticle => Icons.Material.Filled.Article,
        ArticleType.Character => Icons.Material.Filled.Person,
        ArticleType.CharacterNote => Icons.Material.Filled.Note,
        ArticleType.Session => Icons.Material.Filled.Casino,
        ArticleType.SessionNote => Icons.Material.Filled.EditNote,
        ArticleType.Legacy => Icons.Material.Filled.History,
        _ => Icons.Material.Filled.Description
    };

    private static string GetArticleTypeLabel(ArticleType type) => type switch
    {
        ArticleType.WikiArticle => "Wiki Article",
        ArticleType.Character => "Character",
        ArticleType.CharacterNote => "Character Note",
        ArticleType.Session => "Session",
        ArticleType.SessionNote => "Session Note",
        ArticleType.Legacy => "Legacy Article",
        _ => "Article"
    };

    private async Task HandleAliasesBlur()
    {
        // Normalize for comparison: trim, dedupe, sort
        var normalizedNew = NormalizeAliasesText(_aliasesText);
        var normalizedOriginal = NormalizeAliasesText(_originalAliasesText);
        
        if (normalizedNew == normalizedOriginal || _isSavingAliases)
        {
            return;
        }

        _isSavingAliases = true;
        StateHasChanged();

        try
        {
            var result = await ArticleApi.UpdateAliasesAsync(Article.Id, _aliasesText);
            
            if (result != null)
            {
                // Update the article's aliases from the response
                Article.Aliases = result.Aliases;
                
                // Update our tracking
                _originalAliasesText = _aliasesText;
                
                Snackbar.Add("Aliases updated", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to update aliases", Severity.Error);
                // Revert to original
                _aliasesText = _originalAliasesText;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update aliases: {ex.Message}", Severity.Error);
            _aliasesText = _originalAliasesText;
        }
        finally
        {
            _isSavingAliases = false;
            StateHasChanged();
        }
    }

    private static string NormalizeAliasesText(string? text)
    {
        if (string.IsNullOrWhiteSpace(text))
            return string.Empty;
            
        var aliases = text
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(a => a.Trim().ToLowerInvariant())
            .Where(a => !string.IsNullOrWhiteSpace(a))
            .Distinct()
            .OrderBy(a => a);
            
        return string.Join(",", aliases);
    }

    public async Task RefreshPanelsAsync()
    {
        await Task.WhenAll(
            LoadBacklinksAsync(),
            LoadOutgoingLinksAsync(),
            LoadExternalLinksAsync()
        );
    }

    private async Task OnOpenChangedInternal()
    {
        await IsOpenChanged.InvokeAsync(IsOpen);
        
        // Load links when drawer opens (if not already loaded)
        if (IsOpen)
        {
            var tasks = new List<Task>();
            
            if (!_backlinks.Any() && !_loadingBacklinks)
                tasks.Add(LoadBacklinksAsync());
                
            if (!_outgoingLinks.Any() && !_loadingOutgoingLinks)
                tasks.Add(LoadOutgoingLinksAsync());
                
            if (!_externalLinks.Any() && !_loadingExternalLinks)
                tasks.Add(LoadExternalLinksAsync());
            
            if (tasks.Any())
                await Task.WhenAll(tasks);
        }
    }

    private async Task LoadBacklinksAsync()
    {
        _loadingBacklinks = true;
        StateHasChanged();

        try
        {
            _backlinks = await LinkApi.GetBacklinksAsync(Article.Id);
        }
        catch (Exception)
        {
            _backlinks = new List<BacklinkDto>();
        }
        finally
        {
            _loadingBacklinks = false;
            StateHasChanged();
        }
    }

    private async Task LoadOutgoingLinksAsync()
    {
        _loadingOutgoingLinks = true;
        StateHasChanged();

        try
        {
            _outgoingLinks = await LinkApi.GetOutgoingLinksAsync(Article.Id);
        }
        catch (Exception)
        {
            _outgoingLinks = new List<BacklinkDto>();
        }
        finally
        {
            _loadingOutgoingLinks = false;
            StateHasChanged();
        }
    }

    private async Task LoadExternalLinksAsync()
    {
        _loadingExternalLinks = true;
        StateHasChanged();

        try
        {
            _externalLinks = await ExternalLinkApi.GetExternalLinksAsync(Article.Id);
        }
        catch (Exception)
        {
            _externalLinks = new List<ArticleExternalLinkDto>();
        }
        finally
        {
            _loadingExternalLinks = false;
            StateHasChanged();
        }
    }

    private async Task HandleNavigateToArticle(Guid articleId)
    {
        try
        {
            var path = await ArticleCache.GetNavigationPathAsync(articleId);
            
            if (!string.IsNullOrEmpty(path))
            {
                Navigation.NavigateTo($"/article/{path}");
            }
        }
        catch (Exception)
        {
            // Navigation failed - could log or show error
        }
    }
}
