@* ArticleMetadataDrawer.razor - Right-side metadata panel for articles *@
@* Includes outgoing links, backlinks, and article info *@

@using Chronicis.Shared.Enums
@using Chronicis.Shared.DTOs
@inject IArticleApiService ArticleApi
@inject IUserApiService UserApi
@inject ITreeStateService TreeState
@inject ISnackbar Snackbar

<style>
    .metadata-drawer,
    .metadata-drawer .mud-drawer-content {
        background-color: transparent !important;
        border-right-color: transparent;
    }
    .metadata-drawer .mud-drawer-content {
        padding: 8px;
        background-color: var(--chronicis-soft-off-white) !important;
    }
    .metadata-drawer.mud-drawer-persistent {
        height: auto !important;
    }
    .metadata-drawer p {
        font-size: 0.8rem;
    }

    /* Scrollable metadata drawer */
    .metadata-drawer-scrollable {
        height: calc(100vh - 180px);
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 24px;
    }
    
    /* Metadata row styling */
    .metadata-row {
        display: flex;
        align-items: flex-start;
        padding: 8px 16px;
        gap: 12px;
    }
    
    .metadata-row .mud-icon-root {
        color: var(--mud-palette-text-secondary);
        margin-top: 2px;
    }
    
    .metadata-content {
        flex: 1;
        min-width: 0;
    }
    
    .metadata-label {
        font-size: 0.75rem;
        color: var(--mud-palette-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
    }
    
    .metadata-value {
        font-size: 0.875rem;
        color: var(--mud-palette-text-primary);
        word-break: break-word;
    }
    
    .metadata-value-secondary {
        font-size: 0.75rem;
        color: var(--mud-palette-text-secondary);
    }
    
    /* Visibility selector styling */
    .visibility-section {
        padding: 12px 16px;
    }
    
    .visibility-option {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.15s;
    }
    
    .visibility-option:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    
    .visibility-option.selected {
        background-color: var(--mud-palette-primary-lighten);
    }
    
    .visibility-description {
        font-size: 0.75rem;
        color: var(--mud-palette-text-secondary);
        margin-top: 2px;
    }
</style>

<MudDrawer @bind-Open="IsOpen"
           @bind-Open:after="OnOpenChangedInternal"
           Fixed="true"
           Anchor="Anchor.End"
           Elevation="9999"
           Variant="@DrawerVariant.Persistent"
           ClipMode="@DrawerClipMode.Always"
           Class="metadata-drawer">
    <MudDrawerHeader Class="backlinks-header">
        <MudText Typo="Typo.h6" Class="backlinks-title">
            <MudIcon Icon="@Icons.Material.Filled.IntegrationInstructions" Size="Size.Small" />
            Metadata
        </MudText>
    </MudDrawerHeader>
    <MudDrawerContainer Class="metadata-drawer-scrollable chronicis-scrollbar-light">
        <!-- Outgoing Links Panel -->
        <OutgoingLinksPanel @ref="_outgoingLinksPanel" ArticleId="@Article.Id" IsOpen="@IsOpen" />
        
        <MudDivider Class="my-3" />
        
        <!-- Backlinks Panel -->
        <BacklinksPanel @ref="_backlinksPanel" ArticleId="@Article.Id" IsOpen="@IsOpen" />
        
        <MudDivider Class="my-3" />
        
        <!-- External Links Panel -->
        <ExternalLinksPanel @ref="_externalLinksPanel" ArticleId="@Article.Id" IsOpen="@IsOpen" />
        
        <MudDivider Class="my-3" />
        
        <!-- Visibility Section -->
        <MudText Typo="Typo.subtitle2" Class="px-4 py-2" Style="color: var(--mud-palette-text-secondary);">
            Visibility
        </MudText>
        
        <div class="visibility-section">
            @if (_isCreator)
            {
                <MudSelect T="ArticleVisibility" 
                           Value="@_currentVisibility"
                           ValueChanged="@HandleVisibilityChanged"
                           Label="Who can see this article"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Disabled="_isSavingVisibility"
                           AnchorOrigin="Origin.BottomCenter"
                           TransformOrigin="Origin.TopCenter">
                    <MudSelectItem Value="ArticleVisibility.Public">
                        <div class="d-flex align-center gap-2">
                            <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                            <span>Public</span>
                        </div>
                    </MudSelectItem>
                    <MudSelectItem Value="ArticleVisibility.MembersOnly">
                        <div class="d-flex align-center gap-2">
                            <MudIcon Icon="@Icons.Material.Filled.Group" Size="Size.Small" />
                            <span>Members Only</span>
                        </div>
                    </MudSelectItem>
                    <MudSelectItem Value="ArticleVisibility.Private">
                        <div class="d-flex align-center gap-2">
                            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" />
                            <span>Private</span>
                        </div>
                    </MudSelectItem>
                </MudSelect>
                <MudText Typo="Typo.caption" Class="mt-2" Style="color: var(--mud-palette-text-secondary);">
                    @GetVisibilityDescription(_currentVisibility)
                </MudText>
            }
            else
            {
                <div class="d-flex align-center gap-2">
                    <MudIcon Icon="@GetVisibilityIcon(Article.Visibility)" Size="Size.Small" 
                             Style="color: var(--mud-palette-text-secondary);" />
                    <div>
                        <MudText Typo="Typo.body2">@GetVisibilityLabel(Article.Visibility)</MudText>
                        <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-secondary);">
                            @GetVisibilityDescription(Article.Visibility)
                        </MudText>
                    </div>
                </div>
            }
        </div>
        
        <MudDivider Class="my-3" />
        
        <!-- Aliases Section -->
        <MudText Typo="Typo.subtitle2" Class="px-4 py-2" Style="color: var(--mud-palette-text-secondary);">
            Aliases
        </MudText>
        
        <div class="px-4 pb-3">
            <MudTextField @bind-Value="_aliasesText"
                          Placeholder="Enter aliases, separated by commas"
                          Variant="Variant.Outlined"
                          Lines="2"
                          HelperText="Alternative names for linking (e.g., Icara, The Wanderer)"
                          Disabled="_isSavingAliases"
                          Immediate="false"
                          DebounceInterval="500"
                          OnBlur="HandleAliasesBlur" />
            @if (_isSavingAliases)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-1" />
            }
        </div>
        
        <MudDivider Class="my-3" />
        
        <!-- Article Info Section -->
        <MudText Typo="Typo.subtitle2" Class="px-4 py-2" Style="color: var(--mud-palette-text-secondary);">
            Article Info
        </MudText>
        
        <!-- Article Type -->
        <div class="metadata-row">
            <MudIcon Icon="@GetArticleTypeIcon(Article.Type)" Size="Size.Small" />
            <div class="metadata-content">
                <div class="metadata-label">Type</div>
                <div class="metadata-value">@GetArticleTypeLabel(Article.Type)</div>
            </div>
        </div>
        
        <!-- Created By -->
        <div class="metadata-row">
            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Size="Size.Small" />
            <div class="metadata-content">
                <div class="metadata-label">Created</div>
                <div class="metadata-value">@(Article.CreatedByName ?? "Unknown")</div>
                <div class="metadata-value-secondary">@Article.CreatedAt.ToString("MMM d, yyyy 'at' h:mm tt")</div>
            </div>
        </div>
        
        <!-- Last Modified By (only show if different from created or has been modified) -->
        @if (Article.ModifiedAt.HasValue)
        {
            <div class="metadata-row">
                <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                <div class="metadata-content">
                    <div class="metadata-label">Last Modified</div>
                    <div class="metadata-value">@(Article.LastModifiedByName ?? Article.CreatedByName ?? "Unknown")</div>
                    <div class="metadata-value-secondary">@Article.ModifiedAt.Value.ToString("MMM d, yyyy 'at' h:mm tt")</div>
                </div>
            </div>
        }
        
        <!-- Effective Date -->
        <div class="metadata-row">
            <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" />
            <div class="metadata-content">
                <div class="metadata-label">Effective Date</div>
                <div class="metadata-value">@Article.EffectiveDate.ToString("MMMM d, yyyy")</div>
                <div class="metadata-value-secondary">@Article.EffectiveDate.ToString("h:mm tt")</div>
            </div>
        </div>
        
        <MudDivider Class="my-3" />
        
        <!-- Technical IDs (collapsed by default) -->
        <MudExpansionPanels Elevation="0" Dense="true">
            <MudExpansionPanel Text="Technical Details" Style="background: transparent;">
                <div class="metadata-row">
                    <MudIcon Icon="@Icons.Material.Filled.Fingerprint" Size="Size.Small" />
                    <div class="metadata-content">
                        <div class="metadata-label">Article ID</div>
                        <div class="metadata-value" style="font-family: monospace; font-size: 0.7rem;">@Article.Id</div>
                    </div>
                </div>
                @if (Article.WorldId.HasValue)
                {
                    <div class="metadata-row">
                        <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                        <div class="metadata-content">
                            <div class="metadata-label">World ID</div>
                            <div class="metadata-value" style="font-family: monospace; font-size: 0.7rem;">@Article.WorldId</div>
                        </div>
                    </div>
                }
                @if (Article.CampaignId.HasValue)
                {
                    <div class="metadata-row">
                        <MudIcon Icon="@Icons.Material.Filled.Map" Size="Size.Small" />
                        <div class="metadata-content">
                            <div class="metadata-label">Campaign ID</div>
                            <div class="metadata-value" style="font-family: monospace; font-size: 0.7rem;">@Article.CampaignId</div>
                        </div>
                    </div>
                }
                @if (Article.ArcId.HasValue)
                {
                    <div class="metadata-row">
                        <MudIcon Icon="@Icons.Material.Filled.Timeline" Size="Size.Small" />
                        <div class="metadata-content">
                            <div class="metadata-label">Arc ID</div>
                            <div class="metadata-value" style="font-family: monospace; font-size: 0.7rem;">@Article.ArcId</div>
                        </div>
                    </div>
                }
            </MudExpansionPanel>
        </MudExpansionPanels>
    </MudDrawerContainer>
</MudDrawer>

@code {
    private OutgoingLinksPanel? _outgoingLinksPanel;
    private BacklinksPanel? _backlinksPanel;
    private ExternalLinksPanel? _externalLinksPanel;
    private bool _isCreator;
    private ArticleVisibility _currentVisibility;
    private bool _isSavingVisibility;
    private Guid? _currentUserId;
    
    // Aliases
    private string _aliasesText = string.Empty;
    private string _originalAliasesText = string.Empty;
    private bool _isSavingAliases;

    [Parameter]
    public ArticleDto Article { get; set; } = null!;

    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter]
    public EventCallback OnArticleVisibilityChanged { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var user = await UserApi.GetUserProfileAsync();
        _currentUserId = user?.Id;
    }

    protected override void OnParametersSet()
    {
        _isCreator = _currentUserId.HasValue && Article.CreatedBy == _currentUserId.Value;
        _currentVisibility = Article.Visibility;
        
        // Initialize aliases text from Article
        var newAliasesText = Article.Aliases != null && Article.Aliases.Any()
            ? string.Join(", ", Article.Aliases.Select(a => a.AliasText))
            : string.Empty;
        
        // Only update if the article changed (not just user editing)
        if (_originalAliasesText != newAliasesText || string.IsNullOrEmpty(_aliasesText))
        {
            _aliasesText = newAliasesText;
            _originalAliasesText = newAliasesText;
        }
    }

    private async Task HandleVisibilityChanged(ArticleVisibility newVisibility)
    {
        if (_isSavingVisibility || newVisibility == _currentVisibility) return;

        var previousVisibility = _currentVisibility;
        _isSavingVisibility = true;
        _currentVisibility = newVisibility; // Optimistic update
        StateHasChanged();

        try
        {
            var updateDto = new ArticleUpdateDto
            {
                Title = Article.Title,
                Body = Article.Body,
                Visibility = newVisibility
            };

            await ArticleApi.UpdateArticleAsync(Article.Id, updateDto);
            
            Article.Visibility = newVisibility;
            TreeState.UpdateNodeVisibility(Article.Id, newVisibility);
            
            Snackbar.Add($"Visibility changed to {GetVisibilityLabel(newVisibility)}", Severity.Success);
            
            await OnArticleVisibilityChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update visibility: {ex.Message}", Severity.Error);
            _currentVisibility = previousVisibility; // Revert on failure
        }
        finally
        {
            _isSavingVisibility = false;
            StateHasChanged();
        }
    }

    private static string GetVisibilityIcon(ArticleVisibility visibility) => visibility switch
    {
        ArticleVisibility.Public => Icons.Material.Filled.Public,
        ArticleVisibility.MembersOnly => Icons.Material.Filled.Group,
        ArticleVisibility.Private => Icons.Material.Filled.Lock,
        _ => Icons.Material.Filled.Help
    };

    private static string GetVisibilityLabel(ArticleVisibility visibility) => visibility switch
    {
        ArticleVisibility.Public => "Public",
        ArticleVisibility.MembersOnly => "Members Only",
        ArticleVisibility.Private => "Private",
        _ => "Unknown"
    };

    private static string GetVisibilityDescription(ArticleVisibility visibility) => visibility switch
    {
        ArticleVisibility.Public => "Anyone can view this article, including visitors to public worlds.",
        ArticleVisibility.MembersOnly => "Only members of this world can view this article.",
        ArticleVisibility.Private => "Only you can view this article. Hidden from all other users.",
        _ => ""
    };

    private static string GetArticleTypeIcon(ArticleType type) => type switch
    {
        ArticleType.WikiArticle => Icons.Material.Filled.Article,
        ArticleType.Character => Icons.Material.Filled.Person,
        ArticleType.CharacterNote => Icons.Material.Filled.Note,
        ArticleType.Session => Icons.Material.Filled.Casino,
        ArticleType.SessionNote => Icons.Material.Filled.EditNote,
        ArticleType.Legacy => Icons.Material.Filled.History,
        _ => Icons.Material.Filled.Description
    };

    private static string GetArticleTypeLabel(ArticleType type) => type switch
    {
        ArticleType.WikiArticle => "Wiki Article",
        ArticleType.Character => "Character",
        ArticleType.CharacterNote => "Character Note",
        ArticleType.Session => "Session",
        ArticleType.SessionNote => "Session Note",
        ArticleType.Legacy => "Legacy Article",
        _ => "Article"
    };

    private async Task HandleAliasesBlur()
    {
        // Normalize for comparison: trim, dedupe, sort
        var normalizedNew = NormalizeAliasesText(_aliasesText);
        var normalizedOriginal = NormalizeAliasesText(_originalAliasesText);
        
        if (normalizedNew == normalizedOriginal || _isSavingAliases)
        {
            return;
        }

        _isSavingAliases = true;
        StateHasChanged();

        try
        {
            var result = await ArticleApi.UpdateAliasesAsync(Article.Id, _aliasesText);
            
            if (result != null)
            {
                // Update the article's aliases from the response
                Article.Aliases = result.Aliases;
                
                // Update our tracking
                _originalAliasesText = _aliasesText;
                
                Snackbar.Add("Aliases updated", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to update aliases", Severity.Error);
                // Revert to original
                _aliasesText = _originalAliasesText;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update aliases: {ex.Message}", Severity.Error);
            _aliasesText = _originalAliasesText;
        }
        finally
        {
            _isSavingAliases = false;
            StateHasChanged();
        }
    }

    private static string NormalizeAliasesText(string? text)
    {
        if (string.IsNullOrWhiteSpace(text))
            return string.Empty;
            
        var aliases = text
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(a => a.Trim().ToLowerInvariant())
            .Where(a => !string.IsNullOrWhiteSpace(a))
            .Distinct()
            .OrderBy(a => a);
            
        return string.Join(",", aliases);
    }

    public async Task RefreshPanelsAsync()
    {
        if (_outgoingLinksPanel != null)
        {
            await _outgoingLinksPanel.RefreshAsync();
        }
        
        if (_backlinksPanel != null)
        {
            await _backlinksPanel.RefreshAsync();
        }
        
        if (_externalLinksPanel != null)
        {
            await _externalLinksPanel.RefreshAsync();
        }
    }

    private async Task OnOpenChangedInternal()
    {
        await IsOpenChanged.InvokeAsync(IsOpen);
    }
}
