@page "/article/{*Path}"
@attribute [Authorize]
@inject ITreeStateService TreeStateService
@inject IArticleApiService ArticleApi
@inject IQuoteService QuoteService
@inject NavigationManager Navigation
@implements IDisposable

@if (TreeStateService.SelectedArticleId.HasValue && TreeStateService.SelectedArticleId.Value > 0)
{
    <ArticleDetail />
}
else
{
    <MudPaper Elevation="2" Class="chronicis-article-card chronicis-fade-in">
        <h6>Loading article...</h6>
    </MudPaper>
}

@code {
    [Parameter]
    public string? Path { get; set; }

    protected override async Task OnInitializedAsync()
    {
        TreeStateService.OnStateChanged += OnTreeStateChanged;
        
        // If URL has article path, load it
        if (!string.IsNullOrEmpty(Path))
        {
            await LoadArticleByPath(Path);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Handle URL changes (browser back/forward)
        if (!string.IsNullOrEmpty(Path))
        {
            await LoadArticleByPath(Path);
        }
    }
    
    private async Task LoadArticleByPath(string path)
    {
        try
        {
            var article = await ArticleApi.GetArticleByPathAsync(path);
            
            if (article != null)
            {
                if (article.Id != TreeStateService.SelectedArticleId)
                {
                    TreeStateService.NotifySelectionChanged(article.Id);
                }
            }
            else
            {
                // Article not found
                if (!TreeStateService.SelectedArticleId.HasValue)
                {
                    Console.Error.WriteLine($"Article not found for path: {path}");
                    Navigation.NavigateTo("/", replace: true);
                }
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading article by path: {ex.Message}");
            if (!TreeStateService.SelectedArticleId.HasValue)
            {
                Navigation.NavigateTo("/", replace: true);
            }
        }
    }

    private async Task NavigateToArticle(int articleId)
    {
        // Get the full article details to build path from breadcrumbs
        var article = await ArticleApi.GetArticleDetailAsync(articleId);
        if (article != null && article.Breadcrumbs.Any())
        {
            var path = string.Join("/", article.Breadcrumbs.Select(b => b.Slug));
            Navigation.NavigateTo($"/article/{path}");
        }
    }    

    private void OnTreeStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        TreeStateService.OnStateChanged -= OnTreeStateChanged;
    }
}
