@page "/dashboard"
@attribute [Authorize]
@implements IDisposable
@using Chronicis.Client.Components.Shared
@using Chronicis.Client.Components.Dialogs
@inject DashboardViewModel ViewModel

<PageTitle>Dashboard - Chronicis</PageTitle>

@if (ViewModel.IsLoading)
{
    <MudPaper Elevation="2" Class="dashboard-container">
        <div class="dashboard-loading">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-4">Loading your chronicle...</MudText>
        </div>
    </MudPaper>
}
else if (ViewModel.Dashboard == null)
{
    <MudPaper Elevation="2" Class="dashboard-container">
        <div class="dashboard-error">
            <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Color="Color.Error" />
            <MudText Typo="Typo.h6" Class="mt-4">Unable to load dashboard</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => ViewModel.LoadDashboardAsync())" Class="mt-4">
                Try Again
            </MudButton>
        </div>
    </MudPaper>
}
else
{
    <div class="dashboard-wrapper">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="hero-content">
                <div class="hero-text">
                    <MudText Typo="Typo.h3" Class="hero-title">
                        Welcome back, <span class="user-name">@ViewModel.Dashboard.UserDisplayName</span>
                    </MudText>
                    <MudText Typo="Typo.body1" Class="hero-subtitle">
                        Your chronicle awaits. What story will you tell today?
                    </MudText>
                    @if (ViewModel.Quote != null)
                    {
                        <div class="hero-quote">
                            <MudText Typo="Typo.body2" Class="quote-text">
                                "@ViewModel.Quote.Content"
                            </MudText>
                            <MudText Typo="Typo.caption" Class="quote-author">
                                ‚Äî @ViewModel.Quote.Author
                            </MudText>
                        </div>
                    }
                </div>
                <div class="hero-actions">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               OnClick="@(() => ViewModel.CreateNewWorldAsync())"
                               Class="hero-button">
                        Create New World
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               Size="Size.Large"
                               OnClick="@(() => ViewModel.JoinWorldAsync())"
                               Class="hero-button">
                        Join a World
                    </MudButton>
                </div>
            </div>

            <!-- Prompts in Hero -->
            @if (ViewModel.Dashboard.Prompts.Any())
            {
                <div class="hero-prompts">
                    @foreach (var prompt in ViewModel.Dashboard.Prompts.Take(3))
                    {
                        <div class="hero-prompt-card @DashboardViewModel.GetCategoryClass(prompt.Category)" @onclick="() => ViewModel.HandlePromptClick(prompt)">
                            <div class="prompt-icon">
                                <IconDisplay Icon="@prompt.Icon" DefaultIcon="üí°" />
                            </div>
                            <div class="prompt-content">
                                <span class="prompt-title">@prompt.Title</span>
                                <span class="prompt-message">@prompt.Message</span>
                            </div>
                            @if (!string.IsNullOrEmpty(prompt.ActionUrl))
                            {
                                <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Class="prompt-arrow" />
                            }
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Main Content -->
        <MudPaper Elevation="2" Class="dashboard-container">
            <div class="chronicis-dashboard">
                <MudGrid>
                    <!-- Main Content: World Panels -->
                    <MudItem xs="12" md="8">
                        @if (ViewModel.OrderedWorlds.Any())
                        {
                            <!-- Primary World -->
                            <WorldPanel World="@ViewModel.OrderedWorlds.First()"
                                        IsExpanded="true" />

                            <!-- Other Worlds -->
                            @if (ViewModel.OrderedWorlds.Count > 1)
                            {
                                <MudText Typo="Typo.overline" Class="other-worlds-header">
                                    Other Worlds
                                </MudText>
                                @foreach (var world in ViewModel.OrderedWorlds.Skip(1))
                                {
                                    <WorldPanel World="@world"
                                                IsExpanded="false"
                                                Class="mb-3" />
                                }
                            }
                        }
                        else
                        {
                            <!-- Empty State: No Worlds -->
                            <MudPaper Elevation="0" Class="empty-state-panel">
                                <div class="empty-state-content">
                                    <div class="empty-icon">üåç</div>
                                    <MudText Typo="Typo.h5" Class="empty-title">
                                        Begin Your Chronicle
                                    </MudText>
                                    <MudText Typo="Typo.body1" Class="empty-message">
                                        Create your first world to start organizing your campaign knowledge.
                                        Every great adventure needs a home.
                                    </MudText>
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               Size="Size.Large"
                                               StartIcon="@Icons.Material.Filled.Add"
                                               OnClick="@(() => ViewModel.CreateNewWorldAsync())"
                                               Class="mt-4">
                                        Create Your First World
                                    </MudButton>
                                </div>
                            </MudPaper>
                        }
                    </MudItem>

                    <!-- Sidebar -->
                    <MudItem xs="12" md="4">
                        <!-- My Characters Summary -->
                        @if (ViewModel.Dashboard.ClaimedCharacters.Any())
                        {
                            <MudPaper Elevation="1" Class="sidebar-panel mb-4">
                                <MudText Typo="Typo.h6" Class="panel-title">
                                    <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                                    My Characters
                                </MudText>
                                <div class="characters-summary">
                                    @foreach (var character in ViewModel.Dashboard.ClaimedCharacters.Take(5))
                                    {
                                        <div class="character-item" @onclick="async () => await ViewModel.NavigateToCharacterAsync(character.Id)">
                                            <IconDisplay Icon="@character.IconEmoji" DefaultIcon="üë§" CssClass="character-icon" />
                                            <div class="character-info">
                                                <span class="character-name">@character.Title</span>
                                                <span class="character-world">@character.WorldName</span>
                                            </div>
                                        </div>
                                    }
                                    @if (ViewModel.Dashboard.ClaimedCharacters.Count > 5)
                                    {
                                        <MudText Typo="Typo.caption" Class="more-characters">
                                            +@(ViewModel.Dashboard.ClaimedCharacters.Count - 5) more characters
                                        </MudText>
                                    }
                                </div>
                            </MudPaper>
                        }

                        <!-- Quick Stats -->
                        <MudPaper Elevation="1" Class="sidebar-panel stats-panel">
                            <MudText Typo="Typo.h6" Class="panel-title">
                                <MudIcon Icon="@Icons.Material.Filled.Analytics" Class="mr-2" />
                                Your Chronicle
                            </MudText>
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <span class="stat-number">@ViewModel.Dashboard.Worlds.Count</span>
                                    <span class="stat-label">Worlds</span>
                                </div>
                                <div class="stat-box">
                                    <span class="stat-number">@ViewModel.Dashboard.Worlds.Sum(w => w.Campaigns.Count)</span>
                                    <span class="stat-label">Campaigns</span>
                                </div>
                                <div class="stat-box">
                                    <span class="stat-number">@ViewModel.Dashboard.Worlds.Sum(w => w.ArticleCount)</span>
                                    <span class="stat-label">Articles</span>
                                </div>
                                <div class="stat-box">
                                    <span class="stat-number">@ViewModel.Dashboard.ClaimedCharacters.Count</span>
                                    <span class="stat-label">Characters</span>
                                </div>
                            </div>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </div>
        </MudPaper>
    </div>
}

@code {
    protected override async Task OnInitializedAsync()
    {
        ViewModel.PropertyChanged += OnViewModelChanged;
        await ViewModel.InitializeAsync();
    }

    private void OnViewModelChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
        => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        ViewModel.PropertyChanged -= OnViewModelChanged;
        ViewModel.Dispose();
    }
}
