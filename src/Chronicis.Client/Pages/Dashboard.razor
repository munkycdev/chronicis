@page "/dashboard"
@attribute [Authorize]
@using Chronicis.Client.Components.Shared
@inject IDashboardApiService DashboardApi
@inject IUserApiService UserApi
@inject IWorldApiService WorldApi
@inject IQuoteService QuoteService
@inject ITreeStateService TreeStateService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Dashboard - Chronicis</PageTitle>

@if (_isLoading)
{
    <MudPaper Elevation="2" Class="dashboard-container">
        <div class="dashboard-loading">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-4">Loading your chronicle...</MudText>
        </div>
    </MudPaper>
}
else if (_dashboard == null)
{
    <MudPaper Elevation="2" Class="dashboard-container">
        <div class="dashboard-error">
            <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Color="Color.Error" />
            <MudText Typo="Typo.h6" Class="mt-4">Unable to load dashboard</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadDashboard" Class="mt-4">
                Try Again
            </MudButton>
        </div>
    </MudPaper>
}
else
{
    <MudPaper Elevation="2" Class="dashboard-container">
        <div class="chronicis-dashboard">
            <!-- Welcome Header -->
            <div class="dashboard-header">
                <div class="welcome-section">
                    <MudText Typo="Typo.h4" Class="welcome-text">
                        Welcome back, <span class="user-name">@_dashboard.UserDisplayName</span>!
                    </MudText>
                    <MudText Typo="Typo.body2" Class="welcome-subtitle">
                        Your chronicle awaits. What story will you tell today?
                    </MudText>
                </div>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="CreateNewWorld">
                    + New World
                </MudButton>
            </div>

            <MudGrid>
                <!-- Main Content: World Panels -->
                <MudItem xs="12" md="8">
                    @if (_orderedWorlds.Any())
                    {
                        <!-- Primary World (world with active campaign, or most recent) -->
                        <WorldPanel World="@_orderedWorlds.First()" 
                                    IsExpanded="true" />

                        <!-- Other Worlds (collapsed by default) -->
                        @if (_orderedWorlds.Count > 1)
                        {
                            <MudText Typo="Typo.subtitle1" Class="other-worlds-header">
                                Other Worlds
                            </MudText>
                            @foreach (var world in _orderedWorlds.Skip(1))
                            {
                                <WorldPanel World="@world" 
                                            IsExpanded="false"
                                            Class="mb-3" />
                            }
                        }
                    }
                    else
                    {
                        <!-- Empty State: No Worlds -->
                        <MudPaper Elevation="0" Class="empty-state-panel">
                            <div class="empty-state-content">
                                <div class="empty-icon">üåç</div>
                                <MudText Typo="Typo.h5" Class="empty-title">
                                    Begin Your Chronicle
                                </MudText>
                                <MudText Typo="Typo.body1" Class="empty-message">
                                    Create your first world to start organizing your campaign knowledge.
                                    Every great adventure needs a home.
                                </MudText>
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           Size="Size.Large"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           OnClick="CreateNewWorld"
                                           Class="mt-4">
                                    Create Your First World
                                </MudButton>
                            </div>
                        </MudPaper>
                    }
                </MudItem>

                <!-- Sidebar: Quick Tips & Actions -->
                <MudItem xs="12" md="4">
                    <!-- My Characters Summary (if any) -->
                    @if (_dashboard.ClaimedCharacters.Any())
                    {
                        <MudPaper Elevation="1" Class="sidebar-panel mb-4">
                            <MudText Typo="Typo.h6" Class="panel-title">
                                <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                                My Characters
                            </MudText>
                            <div class="characters-summary">
                                @foreach (var character in _dashboard.ClaimedCharacters.Take(5))
                                {
                                    <div class="character-item" @onclick="() => NavigateToCharacter(character.Id)">
                                        <IconDisplay Icon="@character.IconEmoji" DefaultIcon="üë§" CssClass="character-icon" />
                                        <div class="character-info">
                                            <span class="character-name">@character.Title</span>
                                            <span class="character-world">@character.WorldName</span>
                                        </div>
                                    </div>
                                }
                                @if (_dashboard.ClaimedCharacters.Count > 5)
                                {
                                    <MudText Typo="Typo.caption" Class="more-characters">
                                        +@(_dashboard.ClaimedCharacters.Count - 5) more characters
                                    </MudText>
                                }
                            </div>
                        </MudPaper>
                    }

                    <!-- Quick Tips -->
                    <MudPaper Elevation="1" Class="sidebar-panel tips-panel">
                        <MudText Typo="Typo.h6" Class="panel-title">
                            <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Class="mr-2" />
                            Quick Tips
                        </MudText>
                        <div class="tips-list">
                            <div class="tip-item">
                                <strong>Wiki Links</strong>
                                <p>Use [[Article Name]] to link articles together</p>
                            </div>
                            <MudDivider Class="my-2" />
                            <div class="tip-item">
                                <strong>Claim Characters</strong>
                                <p>Mark characters as yours to see them on your dashboard</p>
                            </div>
                            <MudDivider Class="my-2" />
                            <div class="tip-item">
                                <strong>AI Summaries</strong>
                                <p>Generate summaries from linked content automatically</p>
                            </div>
                        </div>
                    </MudPaper>

                    <!-- Inspirational Quote -->
                    @if (_quote != null)
                    {
                        <MudPaper Elevation="0" Class="quote-panel mt-4">
                            <MudText Typo="Typo.body2" Class="quote-text">
                                "@_quote.Content"
                            </MudText>
                            <MudText Typo="Typo.caption" Class="quote-author">
                                ‚Äî @_quote.Author
                            </MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                           Size="Size.Small"
                                           OnClick="LoadNewQuote"
                                           Class="quote-refresh" />
                        </MudPaper>
                    }
                </MudItem>
            </MudGrid>
        </div>
    </MudPaper>
}

<style>
    .dashboard-container {
        margin: var(--chronicis-space-lg);
        border-radius: var(--chronicis-radius-lg);
        min-height: calc(100vh - 100px);
    }

    .dashboard-loading, .dashboard-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        text-align: center;
    }

    .chronicis-dashboard {
        padding: var(--chronicis-space-xl);
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--chronicis-space-xl);
        padding-bottom: var(--chronicis-space-lg);
        border-bottom: 1px solid rgba(196, 175, 142, 0.2);
    }

    .welcome-text {
        font-family: var(--chronicis-font-heading);
        color: var(--chronicis-charcoal);
        margin: 0;
    }

    .user-name {
        color: var(--chronicis-beige-gold);
    }

    .welcome-subtitle {
        color: var(--chronicis-slate-grey);
        margin-top: var(--chronicis-space-xs);
    }

    .other-worlds-header {
        color: var(--chronicis-slate-grey);
        margin: var(--chronicis-space-lg) 0 var(--chronicis-space-md) 0;
        font-weight: 500;
    }

    .empty-state-panel {
        padding: var(--chronicis-space-xl);
        text-align: center;
        background: linear-gradient(135deg, rgba(196, 175, 142, 0.05) 0%, rgba(31, 42, 51, 0.02) 100%);
        border-radius: var(--chronicis-radius-lg);
    }

    .empty-state-content {
        max-width: 400px;
        margin: 0 auto;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: var(--chronicis-space-md);
    }

    .empty-title {
        font-family: var(--chronicis-font-heading);
        color: var(--chronicis-charcoal);
        margin-bottom: var(--chronicis-space-sm);
    }

    .empty-message {
        color: var(--chronicis-slate-grey);
    }

    .sidebar-panel {
        padding: var(--chronicis-space-lg);
        border-radius: var(--chronicis-radius-lg);
    }

    .panel-title {
        display: flex;
        align-items: center;
        margin-bottom: var(--chronicis-space-md);
        color: var(--chronicis-charcoal);
    }

    .characters-summary {
        display: flex;
        flex-direction: column;
        gap: var(--chronicis-space-sm);
    }

    .character-item {
        display: flex;
        align-items: center;
        gap: var(--chronicis-space-sm);
        padding: var(--chronicis-space-sm);
        border-radius: var(--chronicis-radius-sm);
        cursor: pointer;
        transition: background var(--chronicis-transition-fast);
    }

    .character-item:hover {
        background: rgba(196, 175, 142, 0.1);
    }

    .character-icon {
        font-size: 1.5rem;
        width: 32px;
        text-align: center;
    }

    .character-info {
        display: flex;
        flex-direction: column;
    }

    .character-name {
        font-weight: 500;
        color: var(--chronicis-charcoal);
    }

    .character-world {
        font-size: 0.75rem;
        color: var(--chronicis-slate-grey);
    }

    .more-characters {
        color: var(--chronicis-slate-grey);
        text-align: center;
        margin-top: var(--chronicis-space-sm);
    }

    .tips-panel {
        background: linear-gradient(135deg, rgba(196, 175, 142, 0.08) 0%, rgba(196, 175, 142, 0.03) 100%);
    }

    .tips-list {
        font-size: 0.875rem;
    }

    .tip-item strong {
        color: var(--chronicis-charcoal);
        display: block;
        margin-bottom: var(--chronicis-space-xs);
    }

    .tip-item p {
        color: var(--chronicis-slate-grey);
        margin: 0;
        font-size: 0.8rem;
    }

    .quote-panel {
        padding: var(--chronicis-space-lg);
        background: rgba(196, 175, 142, 0.05);
        border: 1px solid rgba(196, 175, 142, 0.15);
        border-radius: var(--chronicis-radius-lg);
        position: relative;
    }

    .quote-text {
        font-style: italic;
        color: var(--chronicis-slate-grey);
        margin-bottom: var(--chronicis-space-sm);
    }

    .quote-author {
        color: var(--chronicis-charcoal);
    }

    .quote-refresh {
        position: absolute;
        top: var(--chronicis-space-sm);
        right: var(--chronicis-space-sm);
        opacity: 0.5;
    }

    .quote-refresh:hover {
        opacity: 1;
    }

    @@media (max-width: 960px) {
        .dashboard-header {
            flex-direction: column;
            gap: var(--chronicis-space-md);
        }
        
        .dashboard-container {
            margin: var(--chronicis-space-sm);
        }
    }
</style>

@code {
    private DashboardDto? _dashboard;
    private List<DashboardWorldDto> _orderedWorlds = new();
    private Quote? _quote;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        // Check if user needs onboarding
        var profile = await UserApi.GetUserProfileAsync();
        if (profile != null && !profile.HasCompletedOnboarding)
        {
            Navigation.NavigateTo("/getting-started", replace: true);
            return;
        }

        TreeStateService.OnStateChanged += OnTreeStateChanged;

        await Task.WhenAll(
            LoadDashboard(),
            LoadQuote()
        );
    }

    private async Task LoadDashboard()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _dashboard = await DashboardApi.GetDashboardAsync();
            
            if (_dashboard != null)
            {
                // Order worlds: prioritize those with active campaigns, then by most recent activity
                _orderedWorlds = _dashboard.Worlds
                    .OrderByDescending(w => w.Campaigns.Any(c => c.IsActive)) // Active campaign first
                    .ThenByDescending(w => w.Campaigns
                        .Where(c => c.CurrentArc?.LatestSessionDate != null)
                        .Select(c => c.CurrentArc!.LatestSessionDate)
                        .DefaultIfEmpty(DateTime.MinValue)
                        .Max()) // Most recent session
                    .ThenByDescending(w => w.CreatedAt) // Newest world
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading dashboard: {ex.Message}");
            Snackbar.Add("Failed to load dashboard", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadQuote()
    {
        try
        {
            _quote = await QuoteService.GetRandomQuoteAsync();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading quote: {ex.Message}");
        }
    }

    private async Task LoadNewQuote()
    {
        await LoadQuote();
        StateHasChanged();
    }

    private async Task CreateNewWorld()
    {
        try
        {
            var createDto = new WorldCreateDto
            {
                Name = "New World",
                Description = "A new world for your adventures"
            };

            var world = await WorldApi.CreateWorldAsync(createDto);

            if (world != null)
            {
                Snackbar.Add($"World '{world.Name}' created!", Severity.Success);
                await TreeStateService.RefreshAsync();

                // Navigate to the new world
                if (world.WorldRootArticleId.HasValue)
                {
                    TreeStateService.ShouldFocusTitle = true;
                    Navigation.NavigateTo($"/world/{world.Slug}");
                }
                else
                {
                    await LoadDashboard();
                }
            }
            else
            {
                Snackbar.Add("Failed to create world", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error creating world: {ex.Message}");
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void NavigateToCharacter(Guid characterId)
    {
        // For now, just navigate by ID - we can improve path building later
        Navigation.NavigateTo($"/article/{characterId}");
    }

    private void OnTreeStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        TreeStateService.OnStateChanged -= OnTreeStateChanged;
    }
}
