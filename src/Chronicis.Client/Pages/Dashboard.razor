@page "/dashboard"
@attribute [Authorize]
@inject ITreeStateService TreeStateService
@inject IArticleApiService ArticleApi
@inject IQuoteService QuoteService
@inject NavigationManager Navigation
@implements IDisposable

<div class="chronicis-welcome-page">
    <!-- Hero Section -->
    <MudPaper Elevation="0" Class="chronicis-hero pa-8 mb-6" Style="background: linear-gradient(135deg, rgba(31, 42, 51, 0.95) 0%, rgba(58, 71, 80, 0.95) 100%); color: #F4F0EA; border-radius: 12px;">
        <div class="text-center">
            <div style="font-size: 4rem; margin-bottom: 16px;">üìñ‚ú®</div>
            <MudText Typo="Typo.h2" Class="mb-3" Style="font-family: 'Spellweaver Display', serif; color: #C4AF8E;">
                Your Chronicle Awaits
            </MudText>
            <MudText Typo="Typo.h6" Class="mb-4" Style="opacity: 0.9; max-width: 600px; margin: 0 auto;">
                Every great campaign deserves a legendary chronicle. Organize your world, track your story, and never forget a detail.
            </MudText>
            <MudButton Variant="Variant.Filled"
                        Color="Color.Primary"
                        Size="Size.Large"
                        OnClick="CreateFirstArticle"
                        Class="mt-2">
                + Create a New World
            </MudButton>
        </div>
    </MudPaper>

    <!-- Stats Cards -->
    @if (_stats != null)
    {
        <MudGrid Class="mb-6">
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                    <div style="font-size: 2.5rem;">üìö</div>
                    <MudText Typo="Typo.h4" Class="mt-2">@_stats.TotalArticles</MudText>
                    <MudText Typo="Typo.body2">Total Articles</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                    <div style="font-size: 2.5rem;">üóÇÔ∏è</div>
                    <MudText Typo="Typo.h4" Class="mt-2">@_stats.RootArticles</MudText>
                    <MudText Typo="Typo.body2">Top-Level Topics</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                    <div style="font-size: 2.5rem;">‚úçÔ∏è</div>
                    <MudText Typo="Typo.h4" Class="mt-2">@_stats.RecentlyModified</MudText>
                    <MudText Typo="Typo.body2">Edited This Week</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                    <div style="font-size: 2.5rem;">üé≤</div>
                    <MudText Typo="Typo.h4" Class="mt-2">@_stats.DaysSinceStart</MudText>
                    <MudText Typo="Typo.body2">Days Chronicling</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }

    <!-- Main Content Grid -->
    <MudGrid>
        <!-- Recent Articles -->
        <MudItem xs="12" md="8">
            <MudPaper Elevation="2" Class="pa-6">
                <div class="d-flex align-center justify-space-between mb-4">
                    <MudText Typo="Typo.h5">
                        üìú Recent Articles
                    </MudText>
                </div>

                @if (_isLoadingRecent)
                {
                    <div class="text-center py-4">
                        <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                    </div>
                }
                else if (_allArticles?.Any() ?? false)
                {
                    <MudList T="string">
                        @foreach (var article in _allArticles.Take(7))
                        {
                            <MudListItem T="string" OnClick="@(() => NavigateToArticle(article.Id))">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@(string.IsNullOrEmpty(article.IconEmoji) ? Icons.Material.Filled.Description : article.IconEmoji)"
                                                Color="Color.Primary"
                                                Class="mr-3" />
                                    <div style="flex: 1;">
                                        <MudText Typo="Typo.body1">
                                            @(string.IsNullOrEmpty(article.Title) ? "(Untitled)" : article.Title)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Modified @FormatRelativeTime(article.CreatedDate)
                                        </MudText>
                                    </div>
                                    <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" />
                                </div>
                            </MudListItem>
                            <MudDivider />
                        }
                    </MudList>
                }
                else
                {
                    <div class="text-center py-6" style="opacity: 0.6;">
                        <div style="font-size: 3rem; margin-bottom: 12px;">üìù</div>
                        <MudText Typo="Typo.body1" Color="Color.Secondary">
                            No articles yet. Start building your chronicle!
                        </MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Quick Actions & Tips -->
        <MudItem xs="12" md="4">
            <!-- Quick Actions -->
            <MudPaper Elevation="2" Class="pa-6 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">
                    ‚ö° Quick Actions
                </MudText>
                <MudStack Spacing="2">
                    <MudButton Variant="Variant.Outlined"
                                Color="Color.Primary"
                                FullWidth="true"
                                StartIcon="@Icons.Material.Filled.PersonAdd"
                                OnClick="@(() => CreateArticleWithTitle("New Character"))">
                        Create Character
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                                Color="Color.Primary"
                                FullWidth="true"
                                StartIcon="@Icons.Material.Filled.Place"
                                OnClick="@(() => CreateArticleWithTitle("New Location"))">
                        Add Location
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                                Color="Color.Primary"
                                FullWidth="true"
                                StartIcon="@Icons.Material.Filled.CalendarToday"
                                OnClick="@(() => CreateArticleWithTitle("Session Notes"))">
                        Session Notes
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                                Color="Color.Primary"
                                FullWidth="true"
                                StartIcon="@Icons.Material.Filled.AutoStories"
                                OnClick="@(() => CreateArticleWithTitle("Lore Entry"))">
                        Lore Entry
                    </MudButton>
                </MudStack>
            </MudPaper>

            <!-- Tips Card -->
            <MudPaper Elevation="2" Class="pa-6" Style="background: linear-gradient(135deg, rgba(196, 175, 142, 0.1) 0%, rgba(196, 175, 142, 0.05) 100%);">
                <MudText Typo="Typo.h6" Class="mb-3">
                    üí° Pro Tips
                </MudText>
                <MudStack Spacing="3">
                    <div>
                        <MudText Typo="Typo.body2" Class="mb-1">
                            <strong>Search Tree:</strong>
                        </MudText>
                        <MudText Typo="Typo.caption">
                            Use the search box in the sidebar to filter articles by title
                        </MudText>
                    </div>
                    <MudDivider />
                    <div>
                        <MudText Typo="Typo.body2" Class="mb-1">
                            <strong>Organize with Hierarchy:</strong>
                        </MudText>
                        <MudText Typo="Typo.caption">
                            Use the three-dot menu to add child articles and build your knowledge tree
                        </MudText>
                    </div>
                    <MudDivider />
                    <div>
                        <MudText Typo="Typo.body2" Class="mb-1">
                            <strong>Auto-Save:</strong>
                        </MudText>
                        <MudText Typo="Typo.caption">
                            Your work saves automatically as you type‚Äîno need to click Save!
                        </MudText>
                    </div>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Inspirational Quote Footer -->
    <MudPaper Elevation="0" Class="pa-6 mt-6 text-center chronicis-quote-footer" Style="background: rgba(196, 175, 142, 0.05); border: 1px solid rgba(196, 175, 142, 0.2); border-radius: 8px;">
        @if (_loadingQuote)
        {
            <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
        }
        else if (_quote != null)
        {
            <MudText Typo="Typo.body1" Style="font-style: italic; color: #3A4750;">
                "@_quote.Content"
            </MudText>
            <MudText Typo="Typo.caption" Class="mt-2">
                ‚Äî @_quote.Author
            </MudText>
            <MudTooltip Text="Get a new quote">
                <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                Size="Size.Small"
                                Color="Color.Primary"
                                OnClick="LoadNewQuote"
                                Class="mt-2"
                                Style="opacity: 0.6;" />
            </MudTooltip>
        }
    </MudPaper>
</div>

@code {
    [Parameter]
    public string? ArticleSlug { get; set; }

    private CampaignStats? _stats;
    private List<ArticleTreeDto>? _allArticles;
    private bool _isLoadingRecent = true;
    private Quote? _quote;
    private bool _loadingQuote = true;

    protected override async Task OnInitializedAsync()
    {
        TreeStateService.OnStateChanged += OnTreeStateChanged;

        // If URL has article slug, find and load it
        if (!string.IsNullOrEmpty(ArticleSlug))
        {
            await LoadArticleBySlug(ArticleSlug);
        }

        await Task.WhenAll(
            LoadDashboardData(),
            LoadQuote()
        );
    }

    protected override void OnParametersSet()
    {
        // Handle URL changes (browser back/forward)
        // Only load if the slug changed AND it's different from what we have selected
        if (!string.IsNullOrEmpty(ArticleSlug))
        {
            var currentSlug = TreeStateService.SelectedArticleId.HasValue
                ? CreateSlug(GetArticleTitleById(TreeStateService.SelectedArticleId.Value))
                : null;

            // Only load if slug actually changed (not from our own navigation)
            if (currentSlug != ArticleSlug)
            {
                _ = LoadArticleBySlug(ArticleSlug);
            }
        }
    }

    private string? GetArticleTitleById(int articleId)
    {
        // Try to find title in recent articles cache
        return _allArticles?.FirstOrDefault(a => a.Id == articleId)?.Title;
    }

    private async Task LoadArticleBySlug(string slug)
    {
        try
        {
            // Search for article by title
            var results = await ArticleApi.SearchArticlesAsync(slug);

            // Try exact match first (case-insensitive)
            var exactMatch = results.FirstOrDefault(r =>
                CreateSlug(r.Title) == slug.ToLowerInvariant());

            if (exactMatch != null)
            {
                if (exactMatch.Id != TreeStateService.SelectedArticleId)
                {
                    TreeStateService.NotifySelectionChanged(exactMatch.Id);
                }
            }
            else
            {
                // Article not found by search
                // Only redirect if we don't already have an article selected
                // (This prevents flickering when the article is already loaded)
                if (!TreeStateService.SelectedArticleId.HasValue)
                {
                    Console.Error.WriteLine($"Article not found for slug: {slug}");
                    Navigation.NavigateTo("/", replace: true);
                }
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading article by slug: {ex.Message}");
            // Only redirect on error if no article is selected
            if (!TreeStateService.SelectedArticleId.HasValue)
            {
                Navigation.NavigateTo("/", replace: true);
            }
        }
    }

    private static string CreateSlug(string? title)
    {
        if (string.IsNullOrEmpty(title))
            return "untitled";

        // Convert to lowercase
        var slug = title.ToLowerInvariant();

        // Replace spaces with hyphens
        slug = slug.Replace(" ", "-");

        // Remove invalid characters (keep only letters, numbers, hyphens)
        slug = new string(slug.Where(c => char.IsLetterOrDigit(c) || c == '-').ToArray());

        // Replace multiple consecutive hyphens with single hyphen
        while (slug.Contains("--"))
        {
            slug = slug.Replace("--", "-");
        }

        // Trim hyphens from start and end
        slug = slug.Trim('-');

        return string.IsNullOrEmpty(slug) ? "untitled" : slug;
    }

    private async Task LoadQuote()
    {
        _loadingQuote = true;
        StateHasChanged();

        try
        {
            _quote = await QuoteService.GetRandomQuoteAsync();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading quote: {ex.Message}");
            // Fallback quote already handled in service
        }
        finally
        {
            _loadingQuote = false;
            StateHasChanged();
        }
    }

    private async Task LoadNewQuote()
    {
        await LoadQuote();
    }

    private async Task LoadDashboardData()
    {
        _isLoadingRecent = true;
        StateHasChanged();

        try
        {
            // Load recent articles (top 5 by modified date)
            _allArticles = await ArticleApi.GetAllArticlesAsync();

            // Calculate stats
            _stats = new CampaignStats
            {
                TotalArticles = CountTotalArticles(_allArticles),
                RootArticles = _allArticles.Count(a => !a.ParentId.HasValue),
                RecentlyModified = _allArticles.Count(a =>
                    (a.CreatedDate) > DateTime.Now.AddDays(-7)),
                DaysSinceStart = _allArticles.Any()
                    ? (int)(DateTime.Now - _allArticles.Min(a => a.CreatedDate)).TotalDays
                    : 0
            };
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            _isLoadingRecent = false;
            StateHasChanged();
        }
    }

    private int CountTotalArticles(List<ArticleTreeDto> articles)
    {
        int count = articles.Count;
        foreach (var article in articles)
        {
            if (article.Children != null)
            {
                count += CountTotalArticles(article.Children.ToList());
            }
        }
        return count;
    }

    private void NavigateToArticle(int articleId)
    {
        // Find the article to get its title for the slug
        var article = _allArticles?.FirstOrDefault(a => a.Id == articleId);
        if (article != null)
        {
            var slug = CreateSlug(article.Title);
            Navigation.NavigateTo($"/article/{slug}");
        }
    }

    private async Task CreateFirstArticle()
    {
        await CreateArticleWithTitle(string.Empty);
    }

    private async Task CreateArticleWithTitle(string title)
    {
        try
        {
            var createDto = new ArticleCreateDto
            {
                Title = title,
                Body = string.Empty,
                ParentId = null,
                EffectiveDate = DateTime.Now
            };

            var created = await ArticleApi.CreateArticleAsync(createDto);
            TreeStateService.RefreshTree();

            // Small delay to let tree refresh, then select
            await Task.Delay(300);
            TreeStateService.NotifySelectionChanged(created.Id);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error creating article: {ex.Message}");
        }
    }

    private string FormatRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)}w ago";

        return dateTime.ToString("MMM d, yyyy");
    }

    private void OnTreeStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        TreeStateService.OnStateChanged -= OnTreeStateChanged;
    }

    private class CampaignStats
    {
        public int TotalArticles { get; set; }
        public int RootArticles { get; set; }
        public int RecentlyModified { get; set; }
        public int DaysSinceStart { get; set; }
    }
}
