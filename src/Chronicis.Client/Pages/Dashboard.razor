@page "/dashboard"
@attribute [Authorize]
@using Chronicis.Client.Components.Shared
@using Chronicis.Client.Components.Dialogs
@inject IDashboardApiService DashboardApi
@inject IUserApiService UserApi
@inject IWorldApiService WorldApi
@inject IQuoteService QuoteService
@inject ITreeStateService TreeStateService
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Dashboard - Chronicis</PageTitle>

@if (_isLoading)
{
    <MudPaper Elevation="2" Class="dashboard-container">
        <div class="dashboard-loading">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-4">Loading your chronicle...</MudText>
        </div>
    </MudPaper>
}
else if (_dashboard == null)
{
    <MudPaper Elevation="2" Class="dashboard-container">
        <div class="dashboard-error">
            <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Color="Color.Error" />
            <MudText Typo="Typo.h6" Class="mt-4">Unable to load dashboard</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadDashboard" Class="mt-4">
                Try Again
            </MudButton>
        </div>
    </MudPaper>
}
else
{
    <div class="dashboard-wrapper">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="hero-content">
                <div class="hero-text">
                    <MudText Typo="Typo.h3" Class="hero-title">
                        Welcome back, <span class="user-name">@_dashboard.UserDisplayName</span>
                    </MudText>
                    <MudText Typo="Typo.body1" Class="hero-subtitle">
                        Your chronicle awaits. What story will you tell today?
                    </MudText>
                    @if (_quote != null)
                    {
                        <div class="hero-quote">
                            <MudText Typo="Typo.body2" Class="quote-text">
                                "@_quote.Content"
                            </MudText>
                            <MudText Typo="Typo.caption" Class="quote-author">
                                ‚Äî @_quote.Author
                            </MudText>
                        </div>
                    }
                </div>
                <div class="hero-actions">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               OnClick="CreateNewWorld"
                               Class="hero-button">
                        Create New World
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               Size="Size.Large"
                               OnClick="JoinWorld"
                               Class="hero-button">
                        Join a World
                    </MudButton>
                </div>
            </div>
            
            <!-- Prompts in Hero -->
            @if (_dashboard.Prompts.Any())
            {
                <div class="hero-prompts">
                    @foreach (var prompt in _dashboard.Prompts.Take(3))
                    {
                        <div class="hero-prompt-card @GetCategoryClass(prompt.Category)" @onclick="() => HandlePromptClick(prompt)">
                            <div class="prompt-icon">
                                <IconDisplay Icon="@prompt.Icon" DefaultIcon="üí°" />
                            </div>
                            <div class="prompt-content">
                                <span class="prompt-title">@prompt.Title</span>
                                <span class="prompt-message">@prompt.Message</span>
                            </div>
                            @if (!string.IsNullOrEmpty(prompt.ActionUrl))
                            {
                                <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Class="prompt-arrow" />
                            }
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Main Content -->
        <MudPaper Elevation="2" Class="dashboard-container">
            <div class="chronicis-dashboard">
                <MudGrid>
                    <!-- Main Content: World Panels -->
                    <MudItem xs="12" md="8">
                        @if (_orderedWorlds.Any())
                        {
                            <!-- Primary World -->
                            <WorldPanel World="@_orderedWorlds.First()" 
                                        IsExpanded="true" />

                            <!-- Other Worlds -->
                            @if (_orderedWorlds.Count > 1)
                            {
                                <MudText Typo="Typo.overline" Class="other-worlds-header">
                                    Other Worlds
                                </MudText>
                                @foreach (var world in _orderedWorlds.Skip(1))
                                {
                                    <WorldPanel World="@world" 
                                                IsExpanded="false"
                                                Class="mb-3" />
                                }
                            }
                        }
                        else
                        {
                            <!-- Empty State: No Worlds -->
                            <MudPaper Elevation="0" Class="empty-state-panel">
                                <div class="empty-state-content">
                                    <div class="empty-icon">üåç</div>
                                    <MudText Typo="Typo.h5" Class="empty-title">
                                        Begin Your Chronicle
                                    </MudText>
                                    <MudText Typo="Typo.body1" Class="empty-message">
                                        Create your first world to start organizing your campaign knowledge.
                                        Every great adventure needs a home.
                                    </MudText>
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               Size="Size.Large"
                                               StartIcon="@Icons.Material.Filled.Add"
                                               OnClick="CreateNewWorld"
                                               Class="mt-4">
                                        Create Your First World
                                    </MudButton>
                                </div>
                            </MudPaper>
                        }
                    </MudItem>

                    <!-- Sidebar -->
                    <MudItem xs="12" md="4">
                        <!-- My Characters Summary -->
                        @if (_dashboard.ClaimedCharacters.Any())
                        {
                            <MudPaper Elevation="1" Class="sidebar-panel mb-4">
                                <MudText Typo="Typo.h6" Class="panel-title">
                                    <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                                    My Characters
                                </MudText>
                                <div class="characters-summary">
                                    @foreach (var character in _dashboard.ClaimedCharacters.Take(5))
                                    {
                                        <div class="character-item" @onclick="() => NavigateToCharacter(character.Id)">
                                            <IconDisplay Icon="@character.IconEmoji" DefaultIcon="üë§" CssClass="character-icon" />
                                            <div class="character-info">
                                                <span class="character-name">@character.Title</span>
                                                <span class="character-world">@character.WorldName</span>
                                            </div>
                                        </div>
                                    }
                                    @if (_dashboard.ClaimedCharacters.Count > 5)
                                    {
                                        <MudText Typo="Typo.caption" Class="more-characters">
                                            +@(_dashboard.ClaimedCharacters.Count - 5) more characters
                                        </MudText>
                                    }
                                </div>
                            </MudPaper>
                        }

                        <!-- Quick Stats -->
                        <MudPaper Elevation="1" Class="sidebar-panel stats-panel">
                            <MudText Typo="Typo.h6" Class="panel-title">
                                <MudIcon Icon="@Icons.Material.Filled.Analytics" Class="mr-2" />
                                Your Chronicle
                            </MudText>
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <span class="stat-number">@_dashboard.Worlds.Count</span>
                                    <span class="stat-label">Worlds</span>
                                </div>
                                <div class="stat-box">
                                    <span class="stat-number">@_dashboard.Worlds.Sum(w => w.Campaigns.Count)</span>
                                    <span class="stat-label">Campaigns</span>
                                </div>
                                <div class="stat-box">
                                    <span class="stat-number">@_dashboard.Worlds.Sum(w => w.ArticleCount)</span>
                                    <span class="stat-label">Articles</span>
                                </div>
                                <div class="stat-box">
                                    <span class="stat-number">@_dashboard.ClaimedCharacters.Count</span>
                                    <span class="stat-label">Characters</span>
                                </div>
                            </div>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </div>
        </MudPaper>
    </div>
}

@code {
    private DashboardDto? _dashboard;
    private List<DashboardWorldDto> _orderedWorlds = new();
    private Quote? _quote;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        // Check if user needs onboarding
        var profile = await UserApi.GetUserProfileAsync();
        if (profile != null && !profile.HasCompletedOnboarding)
        {
            Navigation.NavigateTo("/getting-started", replace: true);
            return;
        }

        TreeStateService.OnStateChanged += OnTreeStateChanged;

        await Task.WhenAll(
            LoadDashboard(),
            LoadQuote()
        );
    }

    private async Task LoadDashboard()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _dashboard = await DashboardApi.GetDashboardAsync();
            
            if (_dashboard != null)
            {
                // Order worlds: prioritize those with active campaigns, then by most recent activity
                _orderedWorlds = _dashboard.Worlds
                    .OrderByDescending(w => w.Campaigns.Any(c => c.IsActive))
                    .ThenByDescending(w => w.Campaigns
                        .Where(c => c.CurrentArc?.LatestSessionDate != null)
                        .Select(c => c.CurrentArc!.LatestSessionDate)
                        .DefaultIfEmpty(DateTime.MinValue)
                        .Max())
                    .ThenByDescending(w => w.CreatedAt)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading dashboard: {ex.Message}");
            Snackbar.Add("Failed to load dashboard", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadQuote()
    {
        try
        {
            _quote = await QuoteService.GetRandomQuoteAsync();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading quote: {ex.Message}");
        }
    }

    private async Task CreateNewWorld()
    {
        try
        {
            var createDto = new WorldCreateDto
            {
                Name = "New World",
                Description = "A new world for your adventures"
            };

            var world = await WorldApi.CreateWorldAsync(createDto);

            if (world != null)
            {
                Snackbar.Add($"World '{world.Name}' created!", Severity.Success);
                await TreeStateService.RefreshAsync();

                if (world.WorldRootArticleId.HasValue)
                {
                    TreeStateService.ShouldFocusTitle = true;
                    Navigation.NavigateTo($"/world/{world.Slug}");
                }
                else
                {
                    await LoadDashboard();
                }
            }
            else
            {
                Snackbar.Add("Failed to create world", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error creating world: {ex.Message}");
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task JoinWorld()
    {
        var dialog = await DialogService.ShowAsync<JoinWorldDialog>("Join a World");
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is Chronicis.Shared.DTOs.WorldJoinResultDto joinResult)
        {
            Snackbar.Add($"Welcome to {joinResult.WorldName}!", Severity.Success);
            await TreeStateService.RefreshAsync();
            await LoadDashboard();
            
            if (joinResult.WorldId.HasValue)
            {
                Navigation.NavigateTo($"/world/{joinResult.WorldId}");
            }
        }
    }

    private void NavigateToCharacter(Guid characterId)
    {
        Navigation.NavigateTo($"/article/{characterId}", forceLoad: true);
    }

    private void HandlePromptClick(PromptDto prompt)
    {
        if (!string.IsNullOrEmpty(prompt.ActionUrl))
        {
            Navigation.NavigateTo(prompt.ActionUrl, forceLoad: true);
        }
    }

    private string GetCategoryClass(PromptCategory category)
    {
        return category switch
        {
            PromptCategory.MissingFundamental => "missing-fundamental",
            PromptCategory.NeedsAttention => "needs-attention",
            PromptCategory.Suggestion => "suggestion",
            _ => ""
        };
    }

    private void OnTreeStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        TreeStateService.OnStateChanged -= OnTreeStateChanged;
    }
}
