@page "/campaign/{CampaignId:guid}"
@attribute [Authorize]
@implements IDisposable
@using Chronicis.Client.Components.Dialogs
@using Chronicis.Client.Components.Shared
@inject CampaignDetailViewModel ViewModel

@if (ViewModel.IsLoading)
{
    <LoadingSkeleton />
}
else if (ViewModel.Campaign != null)
{
    <MudPaper Elevation="2" Class="chronicis-article-card chronicis-fade-in">
        <DetailPageHeader Breadcrumbs="ViewModel.Breadcrumbs"
                          Icon="@Icons.Material.Filled.AutoStories"
                          Title="@ViewModel.EditName"
                          TitleChanged="@(v => ViewModel.EditName = v)"
                          Placeholder="Campaign Name"
                          OnTitleEdited="@(() => {})"
                          OnEnterPressed="@(() => ViewModel.SaveAsync())" />

        <MudTextField Value="@ViewModel.EditDescription"
                      ValueChanged="@((string v) => ViewModel.EditDescription = v)"
                      Label="Description"
                      Variant="Variant.Outlined"
                      Lines="3"
                      Placeholder="Describe your campaign..."
                      Class="mb-4"
                      Immediate="true" />

        <div class="d-flex align-center justify-space-between mb-3">
            <MudText Typo="Typo.h6" Style="color: var(--chronicis-beige-gold);">
                <MudIcon Icon="@Icons.Material.Filled.Bookmark" Size="Size.Small" Class="mr-2" />
                Arcs / Acts
            </MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@(() => ViewModel.CreateArcAsync())">
                New Arc
            </MudButton>
        </div>

        @if (ViewModel.Arcs.Any())
        {
            <MudList T="ArcDto" Dense="true" Class="mb-4">
                @foreach (var arc in ViewModel.Arcs.OrderBy(a => a.SortOrder))
                {
                    <EntityListItem Icon="@Icons.Material.Filled.Bookmark"
                                    Title="@arc.Name"
                                    OnClick="@(() => ViewModel.NavigateToArc(arc.Id))">
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                            @arc.SessionCount sessions
                        </MudChip>
                    </EntityListItem>
                }
            </MudList>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                No arcs yet. Create your first arc to organize your sessions!
            </MudAlert>
        }

        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--chronicis-beige-gold);">
            Campaign Info
        </MudText>

        <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
            <tbody>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.PlayCircle" Size="Size.Small" Class="mr-2" />Active Campaign</td>
                    <td>
                        <MudSwitch T="bool"
                                   Value="ViewModel.Campaign.IsActive"
                                   ValueChanged="@((bool v) => ViewModel.OnActiveToggleAsync(v))"
                                   Color="Color.Success"
                                   Size="Size.Small"
                                   Disabled="ViewModel.IsTogglingActive" />
                    </td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.Layers" Size="Size.Small" Class="mr-2" />Arcs</td>
                    <td>@ViewModel.Campaign.ArcCount</td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-2" />Owner</td>
                    <td>@ViewModel.Campaign.OwnerName</td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-2" />Created</td>
                    <td>@ViewModel.Campaign.CreatedAt.ToString("MMMM d, yyyy")</td>
                </tr>
                @if (ViewModel.Campaign.StartedAt.HasValue)
                {
                    <tr>
                        <td><MudIcon Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Small" Class="mr-2" />Started</td>
                        <td>@ViewModel.Campaign.StartedAt.Value.ToString("MMMM d, yyyy")</td>
                    </tr>
                }
            </tbody>
        </MudSimpleTable>

        <AISummarySection EntityId="CampaignId"
                          EntityType="Campaign"
                          IsExpanded="ViewModel.SummaryExpanded"
                          IsExpandedChanged="@((bool v) => ViewModel.SummaryExpanded = v)" />

        <div class="chronicis-flex-between mt-4">
            <SaveStatusIndicator IsSaving="ViewModel.IsSaving" HasUnsavedChanges="ViewModel.HasUnsavedChanges" />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@(() => ViewModel.SaveAsync())"
                       Disabled="ViewModel.IsSaving"
                       StartIcon="@Icons.Material.Filled.Save">
                Save
            </MudButton>
        </div>
    </MudPaper>
}

@code {
    [Parameter]
    public Guid CampaignId { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        ViewModel.PropertyChanged += OnViewModelChanged;
        await ViewModel.LoadAsync(CampaignId);
    }

    private void OnViewModelChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
        => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        ViewModel.PropertyChanged -= OnViewModelChanged;
    }
}
