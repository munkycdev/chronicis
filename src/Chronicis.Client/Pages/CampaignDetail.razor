@page "/campaign/{CampaignId:guid}"
@attribute [Authorize]
@using Chronicis.Shared.DTOs
@using Chronicis.Client.Components.Dialogs
@using Chronicis.Client.Components.Shared
@using Chronicis.Client.Utilities
@inject ICampaignApiService CampaignApi
@inject IArcApiService ArcApi
@inject IWorldApiService WorldApi
@inject ITreeStateService TreeState
@inject IBreadcrumbService BreadcrumbService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@if (_isLoading)
{
    <LoadingSkeleton />
}
else if (_campaign == null)
{
    <NotFoundAlert EntityType="Campaign" />
}
else
{
    <MudPaper Elevation="2" Class="chronicis-article-card chronicis-fade-in">
        <DetailPageHeader Breadcrumbs="_breadcrumbs"
                          Icon="@Icons.Material.Filled.AutoStories"
                          @bind-Title="_editName"
                          Placeholder="Campaign Name"
                          OnTitleEdited="OnNameChanged"
                          OnEnterPressed="SaveCampaign" />

        <!-- Description -->
        <MudTextField @bind-Value="_editDescription"
                      Label="Description"
                      Variant="Variant.Outlined"
                      Lines="3"
                      Placeholder="Describe your campaign..."
                      Class="mb-4"
                      Immediate="true"
                      @onkeyup="OnDescriptionChanged" />

        <!-- Arcs Section -->
        <div class="d-flex align-center justify-space-between mb-3">
            <MudText Typo="Typo.h6" Style="color: var(--chronicis-beige-gold);">
                <MudIcon Icon="@Icons.Material.Filled.Bookmark" Size="Size.Small" Class="mr-2" />
                Arcs / Acts
            </MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="CreateArc">
                New Arc
            </MudButton>
        </div>

        @if (_arcs.Any())
        {
            <MudList T="ArcDto" Dense="true" Class="mb-4">
                @foreach (var arc in _arcs.OrderBy(a => a.SortOrder))
                {
                    <EntityListItem Icon="@Icons.Material.Filled.Bookmark"
                                    Title="@arc.Name"
                                    OnClick="@(() => NavigateToArc(arc.Id))">
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                            @arc.SessionCount sessions
                        </MudChip>
                    </EntityListItem>
                }
            </MudList>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                No arcs yet. Create your first arc to organize your sessions!
            </MudAlert>
        }

        <!-- Campaign Info -->
        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--chronicis-beige-gold);">
            Campaign Info
        </MudText>
        
        <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
            <tbody>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.Group" Size="Size.Small" Class="mr-2" />Members</td>
                    <td>@_campaign.MemberCount</td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-2" />Owner</td>
                    <td>@_campaign.OwnerName</td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-2" />Created</td>
                    <td>@_campaign.CreatedAt.ToString("MMMM d, yyyy")</td>
                </tr>
                @if (_campaign.StartedAt.HasValue)
                {
                    <tr>
                        <td><MudIcon Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Small" Class="mr-2" />Started</td>
                        <td>@_campaign.StartedAt.Value.ToString("MMMM d, yyyy")</td>
                    </tr>
                }
            </tbody>
        </MudSimpleTable>

        <!-- AI Summary Section -->
        <AISummarySection EntityId="CampaignId" 
                          EntityType="Campaign" 
                          @bind-IsExpanded="_summaryExpanded" />

        <!-- Save Status -->
        <div class="chronicis-flex-between mt-4">
            <SaveStatusIndicator IsSaving="_isSaving" HasUnsavedChanges="_hasUnsavedChanges" />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="SaveCampaign"
                       Disabled="_isSaving"
                       StartIcon="@Icons.Material.Filled.Save">
                Save
            </MudButton>
        </div>
    </MudPaper>
}

@code {
    [Parameter]
    public Guid CampaignId { get; set; }

    private CampaignDetailDto? _campaign;
    private List<ArcDto> _arcs = new();
    private WorldDto? _world;
    private string _editName = string.Empty;
    private string _editDescription = string.Empty;
    private bool _isLoading = true;
    private bool _isSaving = false;
    private bool _hasUnsavedChanges = false;
    private bool _summaryExpanded = false;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnParametersSetAsync()
    {
        await LoadCampaignAsync();
    }

    private async Task LoadCampaignAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _campaign = await CampaignApi.GetCampaignAsync(CampaignId);
            if (_campaign != null)
            {
                _editName = _campaign.Name;
                _editDescription = _campaign.Description ?? string.Empty;
                _hasUnsavedChanges = false;

                // Load arcs
                _arcs = await ArcApi.GetArcsByCampaignAsync(CampaignId);

                // Load world for breadcrumbs
                _world = (await WorldApi.GetWorldAsync(_campaign.WorldId)) as WorldDto;

                if (_world != null)
                {
                    _breadcrumbs = BreadcrumbService.ForCampaign(_campaign, _world);
                }
                else
                {
                    // Fallback if world not loaded
                    _breadcrumbs = new List<BreadcrumbItem>
                    {
                        new("Dashboard", href: "/dashboard"),
                        new(_campaign.Name, href: null, disabled: true)
                    };
                }

                await JSRuntime.InvokeVoidAsync("eval", $"document.title = '{JsUtilities.EscapeForJs(_campaign.Name)} - Chronicis'");
                
                // Highlight in tree
                TreeState.ExpandPathToAndSelect(CampaignId);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load campaign: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnNameChanged() => _hasUnsavedChanges = true;
    private void OnDescriptionChanged() => _hasUnsavedChanges = true;

    private async Task SaveCampaign()
    {
        if (_campaign == null || _isSaving) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            var updateDto = new CampaignUpdateDto
            {
                Name = _editName.Trim(),
                Description = string.IsNullOrWhiteSpace(_editDescription) ? null : _editDescription.Trim()
            };

            var updated = await CampaignApi.UpdateCampaignAsync(CampaignId, updateDto);
            if (updated != null)
            {
                _campaign.Name = updated.Name;
                _campaign.Description = updated.Description;
                _hasUnsavedChanges = false;

                await TreeState.RefreshAsync();
                await JSRuntime.InvokeVoidAsync("eval", $"document.title = '{JsUtilities.EscapeForJs(_editName)} - Chronicis'");
                
                Snackbar.Add("Campaign saved", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task CreateArc()
    {
        var parameters = new DialogParameters
        {
            { "CampaignId", CampaignId }
        };

        var dialog = await DialogService.ShowAsync<CreateArcDialog>("New Arc", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ArcDto arc)
        {
            await TreeState.RefreshAsync();
            await LoadCampaignAsync();
            Navigation.NavigateTo($"/arc/{arc.Id}");
            Snackbar.Add("Arc created", Severity.Success);
        }
    }

    private void NavigateToArc(Guid arcId)
    {
        Navigation.NavigateTo($"/arc/{arcId}");
    }

}
