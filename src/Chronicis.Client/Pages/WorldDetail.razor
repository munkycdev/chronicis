@page "/world/{WorldId:guid}"
@attribute [Authorize]
@implements IDisposable
@using Chronicis.Client.Components.Dialogs
@using Chronicis.Client.Components.Shared
@using Chronicis.Client.Components.World
@using Chronicis.Client.Components.Settings
@inject WorldDetailViewModel ViewModel
@inject WorldLinksViewModel LinksViewModel
@inject WorldDocumentsViewModel DocumentsViewModel
@inject WorldSharingViewModel SharingViewModel
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

@if (ViewModel.IsLoading)
{
    <LoadingSkeleton />
}
else if (ViewModel.World != null)
{
    <MudPaper Elevation="2" Class="chronicis-article-card chronicis-fade-in">
        <DetailPageHeader Breadcrumbs="ViewModel.Breadcrumbs"
                          Icon="@Icons.Material.Filled.Public"
                          Title="@ViewModel.EditName"
                          TitleChanged="@(v => ViewModel.EditName = v)"
                          Placeholder="World Name"
                          OnTitleEdited="@(() => {})"
                          OnEnterPressed="@(() => ViewModel.SaveAsync(SharingViewModel))" />

        <!-- Description -->
        <MudTextField Value="@ViewModel.EditDescription"
                      ValueChanged="@((string v) => ViewModel.EditDescription = v)"
                      Label="Description"
                      Variant="Variant.Outlined"
                      Lines="5"
                      AutoGrow="true"
                      MaxLines="20"
                      Placeholder="Describe your world..."
                      Class="mb-4"
                      Immediate="true" />

        <!-- Overview Section: Stats + Quick Actions -->
        <div class="world-overview mb-4">
            <div class="world-stats-grid">
                <div class="stat-card">
                    <MudIcon Icon="@Icons.Material.Filled.AutoStories" Class="stat-icon" />
                    <div class="stat-content">
                        <div class="stat-value">@ViewModel.World.CampaignCount</div>
                        <div class="stat-label">Campaigns</div>
                    </div>
                </div>
                <div class="stat-card">
                    <MudIcon Icon="@Icons.Material.Filled.Group" Class="stat-icon" />
                    <div class="stat-content">
                        <div class="stat-value">@ViewModel.World.MemberCount</div>
                        <div class="stat-label">Members</div>
                    </div>
                </div>
                <div class="stat-card">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Class="stat-icon" />
                    <div class="stat-content">
                        <div class="stat-value">@ViewModel.World.CreatedAt.ToString("MMM yyyy")</div>
                        <div class="stat-label">Created</div>
                    </div>
                </div>
            </div>

            <div class="quick-actions-compact">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.AutoStories"
                           OnClick="@(() => ViewModel.CreateCampaignAsync())"
                           Size="Size.Small">
                    New Campaign
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Person"
                           OnClick="@(() => ViewModel.CreateCharacterAsync())"
                           Size="Size.Small">
                    New Character
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.MenuBook"
                           OnClick="@(() => ViewModel.CreateWikiArticleAsync())"
                           Size="Size.Small">
                    New Article
                </MudButton>
            </div>
        </div>

        <!-- Tabbed Content -->
        <MudTabs Elevation="0"
                 Rounded="true"
                 ApplyEffectsToContainer="true"
                 PanelClass="pa-4">

            <!-- Resources Tab -->
            <MudTabPanel Text="Resources" Icon="@Icons.Material.Filled.Folder">
                <div class="resources-section">
                    <!-- Links Subsection -->
                    <div class="resource-subsection mb-4">
                        <div class="d-flex align-center justify-space-between mb-2">
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">External Links</MudText>
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       OnClick="@(() => LinksViewModel.StartAddLink())"
                                       Size="Size.Small">
                                Add Link
                            </MudButton>
                        </div>

                        @if (LinksViewModel.Links.Count == 0 && !LinksViewModel.IsAddingLink)
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                No external links yet. Add links to Roll20, D&amp;D Beyond, or other resources.
                            </MudText>
                        }

                        @foreach (var link in LinksViewModel.Links)
                        {
                            <div class="resource-item">
                                @if (LinksViewModel.EditingLinkId == link.Id)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Style="color: var(--chronicis-beige-gold); flex-shrink: 0;" />
                                    <MudTextField Value="@LinksViewModel.EditLinkTitle"
                                                  ValueChanged="@((string v) => LinksViewModel.EditLinkTitle = v)"
                                                  Placeholder="Title" Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 150px;" />
                                    <MudTextField Value="@LinksViewModel.EditLinkUrl"
                                                  ValueChanged="@((string v) => LinksViewModel.EditLinkUrl = v)"
                                                  Placeholder="URL" Variant="Variant.Outlined" Margin="Margin.Dense" Class="flex-grow-1" />
                                    <MudTextField Value="@LinksViewModel.EditLinkDescription"
                                                  ValueChanged="@((string v) => LinksViewModel.EditLinkDescription = v)"
                                                  Placeholder="Description (optional)" Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 150px;" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small"
                                                   OnClick="@(() => LinksViewModel.SaveEditLinkAsync())" Disabled="LinksViewModel.IsSavingLink" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small"
                                                   OnClick="@(() => LinksViewModel.CancelEditLink())" />
                                }
                                else
                                {
                                    <img src="@WorldLinksViewModel.GetFaviconUrl(link.Url)" alt="" style="width: 20px; height: 20px; flex-shrink: 0;" />
                                    <div class="flex-grow-1">
                                        <MudLink Href="@link.Url" Target="_blank" Typo="Typo.body1" Style="color: var(--chronicis-beige-gold);">
                                            @link.Title
                                            <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Style="font-size: 14px; vertical-align: middle; margin-left: 4px;" />
                                        </MudLink>
                                        @if (!string.IsNullOrWhiteSpace(link.Description))
                                        {
                                            <MudText Typo="Typo.caption" Class="mud-text-secondary">@link.Description</MudText>
                                        }
                                    </div>
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small" OnClick="@(() => LinksViewModel.StartEditLink(link))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => LinksViewModel.DeleteLinkAsync(link))" />
                                }
                            </div>
                        }

                        @if (LinksViewModel.IsAddingLink)
                        {
                            <div class="resource-item">
                                <MudIcon Icon="@Icons.Material.Filled.AddLink" Size="Size.Small" Style="color: var(--chronicis-beige-gold); flex-shrink: 0;" />
                                <MudTextField Value="@LinksViewModel.NewLinkTitle"
                                              ValueChanged="@((string v) => LinksViewModel.NewLinkTitle = v)"
                                              Placeholder="Title (e.g., Roll20 Campaign)" Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 150px;" />
                                <MudTextField Value="@LinksViewModel.NewLinkUrl"
                                              ValueChanged="@((string v) => LinksViewModel.NewLinkUrl = v)"
                                              Placeholder="URL (e.g., https://roll20.net/...)" Variant="Variant.Outlined" Margin="Margin.Dense" Class="flex-grow-1" />
                                <MudTextField Value="@LinksViewModel.NewLinkDescription"
                                              ValueChanged="@((string v) => LinksViewModel.NewLinkDescription = v)"
                                              Placeholder="Description (optional)" Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 150px;" />
                                <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small"
                                               OnClick="@(() => LinksViewModel.SaveNewLinkAsync())" Disabled="LinksViewModel.IsSavingLink" />
                                <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small"
                                               OnClick="@(() => LinksViewModel.CancelAddLink())" />
                            </div>
                        }
                    </div>

                    <MudDivider Class="my-4" />

                    <!-- Documents Subsection -->
                    <div class="resource-subsection">
                        <div class="d-flex align-center justify-space-between mb-2">
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Documents</MudText>
                            @if (ViewModel.IsCurrentUserGm)
                            {
                                <MudButton Variant="Variant.Text"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Upload"
                                           OnClick="@(() => DocumentsViewModel.OpenUploadDialogAsync(WorldId))"
                                           Size="Size.Small">
                                    Upload
                                </MudButton>
                            }
                        </div>

                        @if (DocumentsViewModel.Documents.Count == 0)
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                No documents uploaded yet. Upload PDFs, Office files, images, or other documents.
                            </MudText>
                        }
                        else
                        {
                            @foreach (var doc in DocumentsViewModel.Documents.OrderBy(d => d.Title))
                            {
                                <div class="resource-item">
                                    @if (DocumentsViewModel.EditingDocumentId == doc.Id)
                                    {
                                        <MudIcon Icon="@WorldDocumentsViewModel.GetDocumentIcon(doc.ContentType)" Size="Size.Small" Style="color: var(--chronicis-beige-gold); flex-shrink: 0;" />
                                        <MudTextField Value="@DocumentsViewModel.EditDocumentTitle"
                                                      ValueChanged="@((string v) => DocumentsViewModel.EditDocumentTitle = v)"
                                                      Placeholder="Title" Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 200px;" />
                                        <MudTextField Value="@DocumentsViewModel.EditDocumentDescription"
                                                      ValueChanged="@((string v) => DocumentsViewModel.EditDocumentDescription = v)"
                                                      Placeholder="Description (optional)" Variant="Variant.Outlined" Margin="Margin.Dense" Style="flex: 1;" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small"
                                                       OnClick="@(() => DocumentsViewModel.SaveDocumentEditAsync())" Disabled="DocumentsViewModel.IsSavingDocument" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small"
                                                       OnClick="@(() => DocumentsViewModel.CancelDocumentEdit())" />
                                    }
                                    else
                                    {
                                        <MudIcon Icon="@WorldDocumentsViewModel.GetDocumentIcon(doc.ContentType)" Size="Size.Small" Style="color: var(--chronicis-beige-gold); flex-shrink: 0;" />
                                        <div style="flex: 1; min-width: 0;">
                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@doc.Title</MudText>
                                            @if (!string.IsNullOrEmpty(doc.Description))
                                            {
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@doc.Description</MudText>
                                            }
                                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                                @WorldDocumentsViewModel.FormatFileSize(doc.FileSizeBytes) â€¢ Uploaded @doc.UploadedAt.ToString("MMM d, yyyy")
                                            </MudText>
                                        </div>
                                        <MudIconButton Icon="@Icons.Material.Filled.Download" Color="Color.Primary" Size="Size.Small"
                                                       OnClick="@(() => DocumentsViewModel.DownloadDocumentAsync(doc.Id))" title="Download" />
                                        @if (ViewModel.IsCurrentUserGm)
                                        {
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small"
                                                           OnClick="@(() => DocumentsViewModel.StartEditDocument(doc))" title="Edit" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                           OnClick="@(() => DocumentsViewModel.DeleteDocumentAsync(doc.Id))" title="Delete" />
                                        }
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>
            </MudTabPanel>

            <!-- Members & Sharing Tab -->
            <MudTabPanel Text="Members &amp; Sharing" Icon="@Icons.Material.Filled.People">
                <WorldMembersPanel WorldId="WorldId"
                                   CurrentUserId="ViewModel.CurrentUserId"
                                   IsCurrentUserGM="ViewModel.IsCurrentUserGm"
                                   OnMembersChanged="@(() => ViewModel.OnMembersChangedAsync())" />

                <MudDivider Class="my-4" />

                <!-- Public Sharing Section -->
                <div class="sharing-section">
                    <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">Public Sharing</MudText>

                    <div class="pa-3 rounded" style="background: var(--mud-palette-background-grey);">
                        <div class="d-flex align-center gap-3 mb-3">
                            <MudSwitch Value="@SharingViewModel.IsPublic"
                                       ValueChanged="@((bool v) => { SharingViewModel.IsPublic = v; SharingViewModel.OnPublicToggleChanged(ViewModel.World); })"
                                       Color="Color.Primary"
                                       Label="Make this world publicly accessible"
                                       T="bool" />
                        </div>

                        @if (SharingViewModel.IsPublic)
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary mb-3">
                                Anyone with the link can view articles marked as "Public". Members-only and private articles remain hidden.
                            </MudText>

                            <div class="d-flex align-center gap-2 mb-2">
                                <MudText Typo="Typo.body2" Style="white-space: nowrap;">@SharingViewModel.GetPublicUrlBase(Navigation.BaseUri)</MudText>
                                <MudTextField Value="@SharingViewModel.PublicSlug"
                                              ValueChanged="@((string v) => { SharingViewModel.PublicSlug = v; _ = SharingViewModel.CheckSlugAvailabilityAsync(WorldId); })"
                                              Placeholder="your-world-slug"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense"
                                              Immediate="true"
                                              Style="max-width: 300px;"
                                              Disabled="SharingViewModel.IsCheckingSlug"
                                              Error="@(!string.IsNullOrEmpty(SharingViewModel.SlugError))"
                                              ErrorText="@SharingViewModel.SlugError"
                                              HelperText="@SharingViewModel.SlugHelperText" />
                                @if (SharingViewModel.IsCheckingSlug)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                }
                                else if (SharingViewModel.SlugIsAvailable && !string.IsNullOrEmpty(SharingViewModel.PublicSlug))
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                }
                            </div>

                            @if (SharingViewModel.ShouldShowPublicPreview(ViewModel.World))
                            {
                                <div class="d-flex align-center gap-2 mt-3">
                                    <MudTextField Value="@SharingViewModel.GetFullPublicUrl(Navigation.BaseUri, ViewModel.World)"
                                                  Label="Public URL"
                                                  Variant="Variant.Outlined"
                                                  Margin="Margin.Dense"
                                                  ReadOnly="true"
                                                  Adornment="Adornment.End"
                                                  AdornmentIcon="@Icons.Material.Filled.ContentCopy"
                                                  OnAdornmentClick="CopyPublicUrl"
                                                  Style="max-width: 500px;" />
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.OpenInNew"
                                               Href="@SharingViewModel.GetFullPublicUrl(Navigation.BaseUri, ViewModel.World)"
                                               Target="_blank">
                                        Preview
                                    </MudButton>
                                </div>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                Your world is currently private. Only you and campaign members can access it.
                            </MudText>
                        }
                    </div>
                </div>
            </MudTabPanel>

            <!-- Settings Tab -->
            <MudTabPanel Text="Settings" Icon="@Icons.Material.Filled.Settings">
                @if (ViewModel.IsCurrentUserGm)
                {
                    <WorldResourceProviders WorldId="WorldId" />
                }
                else
                {
                    <MudAlert Severity="Severity.Info">
                        Only the world owner can manage settings.
                    </MudAlert>
                }
            </MudTabPanel>
        </MudTabs>

        <!-- Save Status -->
        <div class="chronicis-flex-between mt-4">
            <SaveStatusIndicator IsSaving="ViewModel.IsSaving" HasUnsavedChanges="ViewModel.HasUnsavedChanges" />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@(() => ViewModel.SaveAsync(SharingViewModel))"
                       Disabled="ViewModel.IsSaving"
                       StartIcon="@Icons.Material.Filled.Save">
                Save
            </MudButton>
        </div>
    </MudPaper>
}

@code {
    [Parameter]
    public Guid WorldId { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        ViewModel.PropertyChanged += OnViewModelChanged;
        LinksViewModel.PropertyChanged += OnViewModelChanged;
        DocumentsViewModel.PropertyChanged += OnViewModelChanged;
        SharingViewModel.PropertyChanged += OnViewModelChanged;

        await ViewModel.LoadAsync(WorldId, SharingViewModel, LinksViewModel, DocumentsViewModel);
    }

    private async Task CopyPublicUrl()
    {
        var url = SharingViewModel.GetFullPublicUrl(Navigation.BaseUri, ViewModel.World);
        if (string.IsNullOrEmpty(url)) return;
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", url);
        }
        catch { /* clipboard not available in all contexts */ }
    }

    private void OnViewModelChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
        => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        ViewModel.PropertyChanged -= OnViewModelChanged;
        LinksViewModel.PropertyChanged -= OnViewModelChanged;
        DocumentsViewModel.PropertyChanged -= OnViewModelChanged;
        SharingViewModel.PropertyChanged -= OnViewModelChanged;
    }
}
