@page "/world/{WorldId:guid}"
@attribute [Authorize]
@using Chronicis.Shared.DTOs
@using Chronicis.Client.Components.Dialogs
@inject IWorldApiService WorldApi
@inject ICampaignApiService CampaignApi
@inject ITreeStateService TreeState
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@if (_isLoading)
{
    <MudPaper Elevation="2" Class="chronicis-article-card">
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="40px" Class="mb-4" />
        <MudSkeleton SkeletonType="SkeletonType.Text" Width="60%" />
        <MudSkeleton SkeletonType="SkeletonType.Text" Width="80%" />
    </MudPaper>
}
else if (_world == null)
{
    <MudPaper Elevation="2" Class="chronicis-article-card">
        <MudAlert Severity="Severity.Warning">World not found</MudAlert>
    </MudPaper>
}
else
{
    <MudPaper Elevation="2" Class="chronicis-article-card chronicis-fade-in">
        <!-- Breadcrumbs -->
        <div class="mud-toolbar mb-2">
            <MudBreadcrumbs Items="_breadcrumbs" />
        </div>

        <!-- World Icon and Title -->
        <div class="d-flex align-center mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Public" 
                     Size="Size.Large" 
                     Class="mr-3 generic-container-icon"
                     Style="color: var(--chronicis-beige-gold); font-size: 2.5rem;" />
            <MudTextField @bind-Value="_editName"
                          Variant="Variant.Text"
                          Placeholder="World Name"
                          Class="chronicis-article-title flex-grow-1"
                          Style="font-size: 2rem; font-family: var(--chronicis-font-heading);"
                          Immediate="true"
                          @onkeyup="OnNameChanged"
                          @onkeydown="OnKeyDown"
                          Underline="false" />
        </div>

        <!-- Divider -->
        <div class="chronicis-rune-divider mb-4"></div>

        <!-- Description -->
        <MudTextField @bind-Value="_editDescription"
                      Label="Description"
                      Variant="Variant.Outlined"
                      Lines="3"
                      Placeholder="Describe your world..."
                      Class="mb-4"
                      Immediate="true"
                      @onkeyup="OnDescriptionChanged" />

        <!-- Quick Actions -->
        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--chronicis-beige-gold);">
            Quick Actions
        </MudText>
        
        <div class="d-flex gap-3 flex-wrap mb-4">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.AutoStories"
                       OnClick="CreateCampaign">
                New Campaign
            </MudButton>
            
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Person"
                       OnClick="CreateCharacter">
                New Player Character
            </MudButton>
            
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.MenuBook"
                       OnClick="CreateWikiArticle">
                New Wiki Article
            </MudButton>
        </div>

        <!-- External Resources -->
        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--chronicis-beige-gold);">
            External Resources
        </MudText>

        <div class="mb-4">
            @if (_links.Count == 0 && !_isAddingLink)
            {
                <MudText Typo="Typo.body2" Class="mud-text-secondary mb-2">
                    No external resources yet. Add links to Roll20, D&D Beyond, SRD, or other useful resources.
                </MudText>
            }

            <!-- Existing Links -->
            @foreach (var link in _links)
            {
                <div class="world-link-item d-flex align-center gap-2 mb-2 pa-2 rounded" 
                     style="background: var(--mud-palette-background-grey);">
                    @if (_editingLinkId == link.Id)
                    {
                        <!-- Edit Mode -->
                        <MudIcon Icon="@Icons.Material.Filled.Link" 
                                 Size="Size.Small" 
                                 Style="color: var(--chronicis-beige-gold); flex-shrink: 0;" />
                        <MudTextField @bind-Value="_editLinkTitle"
                                      Placeholder="Title"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Style="min-width: 150px;" />
                        <MudTextField @bind-Value="_editLinkUrl"
                                      Placeholder="URL"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="flex-grow-1" />
                        <MudTextField @bind-Value="_editLinkDescription"
                                      Placeholder="Description (optional)"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Style="min-width: 150px;" />
                        <MudIconButton Icon="@Icons.Material.Filled.Check"
                                       Color="Color.Success"
                                       Size="Size.Small"
                                       OnClick="SaveEditLink"
                                       Disabled="_isSavingLink" />
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                       Color="Color.Default"
                                       Size="Size.Small"
                                       OnClick="CancelEditLink" />
                    }
                    else
                    {
                        <!-- View Mode -->
                        <img src="@GetFaviconUrl(link.Url)" 
                             alt="" 
                             style="width: 20px; height: 20px; flex-shrink: 0;"
                             @onerror="HandleFaviconError" />
                        <div class="flex-grow-1">
                            <MudLink Href="@link.Url" 
                                     Target="_blank" 
                                     Typo="Typo.body1"
                                     Style="color: var(--chronicis-beige-gold);">
                                @link.Title
                                <MudIcon Icon="@Icons.Material.Filled.OpenInNew" 
                                         Size="Size.Small" 
                                         Style="font-size: 14px; vertical-align: middle; margin-left: 4px;" />
                            </MudLink>
                            @if (!string.IsNullOrWhiteSpace(link.Description))
                            {
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                    @link.Description
                                </MudText>
                            }
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Color="Color.Default"
                                       Size="Size.Small"
                                       OnClick="() => StartEditLink(link)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="() => DeleteLink(link)" />
                    }
                </div>
            }

            <!-- Add New Link Form -->
            @if (_isAddingLink)
            {
                <div class="world-link-item d-flex align-center gap-2 mb-2 pa-2 rounded" 
                     style="background: var(--mud-palette-background-grey);">
                    <MudIcon Icon="@Icons.Material.Filled.AddLink" 
                             Size="Size.Small" 
                             Style="color: var(--chronicis-beige-gold); flex-shrink: 0;" />
                    <MudTextField @bind-Value="_newLinkTitle"
                                  Placeholder="Title (e.g., Roll20 Campaign)"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Style="min-width: 150px;" />
                    <MudTextField @bind-Value="_newLinkUrl"
                                  Placeholder="URL (e.g., https://roll20.net/...)"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Class="flex-grow-1" />
                    <MudTextField @bind-Value="_newLinkDescription"
                                  Placeholder="Description (optional)"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Style="min-width: 150px;" />
                    <MudIconButton Icon="@Icons.Material.Filled.Check"
                                   Color="Color.Success"
                                   Size="Size.Small"
                                   OnClick="SaveNewLink"
                                   Disabled="_isSavingLink" />
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Color="Color.Default"
                                   Size="Size.Small"
                                   OnClick="CancelAddLink" />
                </div>
            }
            else
            {
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="StartAddLink"
                           Size="Size.Small">
                    Add Resource
                </MudButton>
            }
        </div>

        <!-- Stats -->
        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--chronicis-beige-gold);">
            World Statistics
        </MudText>
        
        <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
            <tbody>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.AutoStories" Size="Size.Small" Class="mr-2" />Campaigns</td>
                    <td>@_world.CampaignCount</td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-2" />Owner</td>
                    <td>@_world.OwnerName</td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-2" />Created</td>
                    <td>@_world.CreatedAt.ToString("MMMM d, yyyy")</td>
                </tr>
            </tbody>
        </MudSimpleTable>

        <!-- Save Status -->
        <div class="chronicis-flex-between mt-4">
            <div class="chronicis-save-status @_saveStatusClass">
                @if (_isSaving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <span>Saving...</span>
                }
                else if (_hasUnsavedChanges)
                {
                    <span>⚠️ Unsaved changes</span>
                }
                else
                {
                    <span>✓ Saved</span>
                }
            </div>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="SaveWorld"
                       Disabled="_isSaving"
                       StartIcon="@Icons.Material.Filled.Save">
                Save
            </MudButton>
        </div>
    </MudPaper>
}

@code {
    [Parameter]
    public Guid WorldId { get; set; }

    private WorldDetailDto? _world;
    private string _editName = string.Empty;
    private string _editDescription = string.Empty;
    private bool _isLoading = true;
    private bool _isSaving = false;
    private bool _hasUnsavedChanges = false;
    private List<BreadcrumbItem> _breadcrumbs = new();

    // Links state
    private List<WorldLinkDto> _links = new();
    private bool _isAddingLink = false;
    private bool _isSavingLink = false;
    private string _newLinkTitle = string.Empty;
    private string _newLinkUrl = string.Empty;
    private string _newLinkDescription = string.Empty;

    // Edit link state
    private Guid? _editingLinkId = null;
    private string _editLinkTitle = string.Empty;
    private string _editLinkUrl = string.Empty;
    private string _editLinkDescription = string.Empty;

    private string _saveStatusClass => _isSaving ? "saving" : _hasUnsavedChanges ? "unsaved" : "saved";

    protected override async Task OnParametersSetAsync()
    {
        await LoadWorldAsync();
    }

    private async Task LoadWorldAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _world = await WorldApi.GetWorldAsync(WorldId);
            if (_world != null)
            {
                _editName = _world.Name;
                _editDescription = _world.Description ?? string.Empty;
                _hasUnsavedChanges = false;

                _breadcrumbs = new List<BreadcrumbItem>
                {
                    new("Dashboard", href: "/dashboard"),
                    new(_world.Name, href: null, disabled: true)
                };

                await JSRuntime.InvokeVoidAsync("eval", $"document.title = '{EscapeForJs(_world.Name)} - Chronicis'");
                
                // Load links
                _links = await WorldApi.GetWorldLinksAsync(WorldId);
                
                // Highlight in tree
                TreeState.ExpandPathToAndSelect(WorldId);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load world: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnNameChanged() => _hasUnsavedChanges = true;
    private void OnDescriptionChanged() => _hasUnsavedChanges = true;

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SaveWorld();
        }
    }

    private async Task SaveWorld()
    {
        if (_world == null || _isSaving) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            var updateDto = new WorldUpdateDto
            {
                Name = _editName.Trim(),
                Description = string.IsNullOrWhiteSpace(_editDescription) ? null : _editDescription.Trim()
            };

            var updated = await WorldApi.UpdateWorldAsync(WorldId, updateDto);
            if (updated != null)
            {
                _world.Name = updated.Name;
                _world.Description = updated.Description;
                _hasUnsavedChanges = false;

                await TreeState.RefreshAsync();
                await JSRuntime.InvokeVoidAsync("eval", $"document.title = '{EscapeForJs(_editName)} - Chronicis'");
                
                Snackbar.Add("World saved", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    // ===== Link Management =====

    private void StartAddLink()
    {
        _isAddingLink = true;
        _newLinkTitle = string.Empty;
        _newLinkUrl = string.Empty;
        _newLinkDescription = string.Empty;
    }

    private void CancelAddLink()
    {
        _isAddingLink = false;
        _newLinkTitle = string.Empty;
        _newLinkUrl = string.Empty;
        _newLinkDescription = string.Empty;
    }

    private async Task SaveNewLink()
    {
        if (string.IsNullOrWhiteSpace(_newLinkTitle) || string.IsNullOrWhiteSpace(_newLinkUrl))
        {
            Snackbar.Add("Title and URL are required", Severity.Warning);
            return;
        }

        // Basic URL validation
        if (!Uri.TryCreate(_newLinkUrl, UriKind.Absolute, out var uri) || 
            (uri.Scheme != "http" && uri.Scheme != "https"))
        {
            Snackbar.Add("Please enter a valid URL (starting with http:// or https://)", Severity.Warning);
            return;
        }

        _isSavingLink = true;
        StateHasChanged();

        try
        {
            var dto = new WorldLinkCreateDto
            {
                Title = _newLinkTitle.Trim(),
                Url = _newLinkUrl.Trim(),
                Description = string.IsNullOrWhiteSpace(_newLinkDescription) ? null : _newLinkDescription.Trim()
            };

            var created = await WorldApi.CreateWorldLinkAsync(WorldId, dto);
            if (created != null)
            {
                // Reload links to get proper alphabetical order
                _links = await WorldApi.GetWorldLinksAsync(WorldId);
                _isAddingLink = false;
                _newLinkTitle = string.Empty;
                _newLinkUrl = string.Empty;
                _newLinkDescription = string.Empty;
                Snackbar.Add("Link added", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to add link", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to add link: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSavingLink = false;
            StateHasChanged();
        }
    }

    private void StartEditLink(WorldLinkDto link)
    {
        _editingLinkId = link.Id;
        _editLinkTitle = link.Title;
        _editLinkUrl = link.Url;
        _editLinkDescription = link.Description ?? string.Empty;
    }

    private void CancelEditLink()
    {
        _editingLinkId = null;
        _editLinkTitle = string.Empty;
        _editLinkUrl = string.Empty;
        _editLinkDescription = string.Empty;
    }

    private async Task SaveEditLink()
    {
        if (_editingLinkId == null) return;

        if (string.IsNullOrWhiteSpace(_editLinkTitle) || string.IsNullOrWhiteSpace(_editLinkUrl))
        {
            Snackbar.Add("Title and URL are required", Severity.Warning);
            return;
        }

        // Basic URL validation
        if (!Uri.TryCreate(_editLinkUrl, UriKind.Absolute, out var uri) || 
            (uri.Scheme != "http" && uri.Scheme != "https"))
        {
            Snackbar.Add("Please enter a valid URL (starting with http:// or https://)", Severity.Warning);
            return;
        }

        _isSavingLink = true;
        StateHasChanged();

        try
        {
            var dto = new WorldLinkUpdateDto
            {
                Title = _editLinkTitle.Trim(),
                Url = _editLinkUrl.Trim(),
                Description = string.IsNullOrWhiteSpace(_editLinkDescription) ? null : _editLinkDescription.Trim()
            };

            var updated = await WorldApi.UpdateWorldLinkAsync(WorldId, _editingLinkId.Value, dto);
            if (updated != null)
            {
                // Reload links to get proper alphabetical order
                _links = await WorldApi.GetWorldLinksAsync(WorldId);
                _editingLinkId = null;
                _editLinkTitle = string.Empty;
                _editLinkUrl = string.Empty;
                _editLinkDescription = string.Empty;
                Snackbar.Add("Link updated", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to update link", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update link: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSavingLink = false;
            StateHasChanged();
        }
    }

    private async Task DeleteLink(WorldLinkDto link)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete Link",
            $"Are you sure you want to delete \"{link.Title}\"?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed != true) return;

        try
        {
            var deleted = await WorldApi.DeleteWorldLinkAsync(WorldId, link.Id);
            if (deleted)
            {
                _links.Remove(link);
                Snackbar.Add("Link deleted", Severity.Success);
                StateHasChanged();
            }
            else
            {
                Snackbar.Add("Failed to delete link", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to delete link: {ex.Message}", Severity.Error);
        }
    }

    private static string GetFaviconUrl(string url)
    {
        try
        {
            var uri = new Uri(url);
            return $"https://www.google.com/s2/favicons?domain={uri.Host}&sz=32";
        }
        catch
        {
            return string.Empty;
        }
    }

    private void HandleFaviconError()
    {
        // Favicon errors are handled via CSS fallback
    }

    // ===== Article Creation =====

    private async Task CreateCampaign()
    {
        var parameters = new DialogParameters
        {
            { "WorldId", WorldId }
        };

        var dialog = await DialogService.ShowAsync<CreateCampaignDialog>("New Campaign", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is CampaignDto campaign)
        {
            await TreeState.RefreshAsync();
            await LoadWorldAsync();
            Navigation.NavigateTo($"/campaign/{campaign.Id}");
            Snackbar.Add("Campaign created", Severity.Success);
        }
    }

    private async Task CreateCharacter()
    {
        var parameters = new DialogParameters
        {
            { "WorldId", WorldId },
            { "ArticleType", Chronicis.Shared.Enums.ArticleType.Character }
        };

        var dialog = await DialogService.ShowAsync<CreateArticleDialog>("New Player Character", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ArticleDto article)
        {
            await TreeState.RefreshAsync();
            Navigation.NavigateTo($"/article/{article.Slug}");
            Snackbar.Add("Character created", Severity.Success);
        }
    }

    private async Task CreateWikiArticle()
    {
        var parameters = new DialogParameters
        {
            { "WorldId", WorldId },
            { "ArticleType", Chronicis.Shared.Enums.ArticleType.WikiArticle }
        };

        var dialog = await DialogService.ShowAsync<CreateArticleDialog>("New Wiki Article", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ArticleDto article)
        {
            await TreeState.RefreshAsync();
            Navigation.NavigateTo($"/article/{article.Slug}");
            Snackbar.Add("Article created", Severity.Success);
        }
    }

    private static string EscapeForJs(string text) => 
        text.Replace("'", "\\'").Replace("\n", "\\n").Replace("\r", "\\r");
}
