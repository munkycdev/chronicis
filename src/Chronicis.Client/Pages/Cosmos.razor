@page "/articosmoscle/{*Path}"
@attribute [Authorize]
@inject CosmosViewModel VM
@inject ITreeStateService TreeStateService
@implements IDisposable

@code {
    private readonly ILogger<Cosmos> _logger;

    // Direct constructor injection
    public Cosmos(ILogger<Cosmos> logger)
    {
        _logger = logger;
    }
}

@if (TreeStateService.SelectedArticleId.HasValue && TreeStateService.SelectedArticleId.Value != Guid.Empty)
{
    <ArticleDetail />
}
else
{
    <div class="chronicis-welcome-page">
        <!-- Hero Section -->
        <MudPaper Elevation="0" Class="chronicis-hero pa-8 mb-6" Style="background: linear-gradient(135deg, rgba(31, 42, 51, 0.95) 0%, rgba(58, 71, 80, 0.95) 100%); color: #F4F0EA; border-radius: 12px;">
            <div class="text-center">
                <div style="font-size: 4rem; margin-bottom: 16px;">üìñ‚ú®</div>
                <MudText Typo="Typo.h2" Class="mb-3" Style="font-family: 'Spellweaver Display', serif; color: #C4AF8E;">
                    Your Chronicle Awaits
                </MudText>
                <MudText Typo="Typo.h6" Class="mb-4" Style="opacity: 0.9; max-width: 600px; margin: 0 auto;">
                    Every great campaign deserves a legendary chronicle. Organize your world, track your story, and never forget a detail.
                </MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Large"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="VM.CreateFirstArticleAsync"
                           Class="mt-2">
                    Start Your First Article
                </MudButton>
            </div>
        </MudPaper>

        <!-- Stats Cards -->
        @if (VM.Stats != null)
        {
            <MudGrid Class="mb-6">
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                        <div style="font-size: 2.5rem; color: #C4AF8E;">üìö</div>
                        <MudText Typo="Typo.h4" Class="mt-2">@VM.Stats.TotalArticles</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Articles</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                        <div style="font-size: 2.5rem; color: #C4AF8E;">üóÇÔ∏è</div>
                        <MudText Typo="Typo.h4" Class="mt-2">@VM.Stats.RootArticles</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Top-Level Topics</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                        <div style="font-size: 2.5rem; color: #C4AF8E;">‚úçÔ∏è</div>
                        <MudText Typo="Typo.h4" Class="mt-2">@VM.Stats.RecentlyModified</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Edited This Week</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                        <div style="font-size: 2.5rem; color: #C4AF8E;">üé≤</div>
                        <MudText Typo="Typo.h4" Class="mt-2">@VM.Stats.DaysSinceStart</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Days Chronicling</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }

        <!-- Main Content Grid -->
        <MudGrid>
            <!-- Recent Articles -->
            <MudItem xs="12" md="8">
                <MudPaper Elevation="2" Class="pa-6">
                    <div class="d-flex align-center justify-space-between mb-4">
                        <MudText Typo="Typo.h5" Style="color: #C4AF8E;">
                            üìú Recent Articles
                        </MudText>
                        @if (VM.RecentArticles?.Any() ?? false)
                        {
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Primary"
                                       Size="Size.Small">
                                View All
                            </MudButton>
                        }
                    </div>

                    @if (VM.IsLoadingRecent)
                    {
                        <div class="text-center py-4">
                            <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                        </div>
                    }
                    else if (VM.RecentArticles?.Any() ?? false)
                    {
                        <MudList T="string">
                            @foreach (var article in VM.RecentArticles)
                            {
                                <MudListItem T="string" OnClick="@(() => VM.NavigateToArticleAsync(article.Id))">
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@(string.IsNullOrEmpty(article.IconEmoji) ? Icons.Material.Filled.Description : article.IconEmoji)"
                                                 Color="Color.Primary"
                                                 Class="mr-3" />
                                        <div style="flex: 1;">
                                            <MudText Typo="Typo.body1">
                                                @(string.IsNullOrEmpty(article.Title) ? "(Untitled)" : article.Title)
                                            </MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                Modified @CosmosViewModel.FormatRelativeTime(article.ModifiedAt ?? article.CreatedAt)
                                            </MudText>
                                        </div>
                                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" />
                                    </div>
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>
                    }
                    else
                    {
                        <div class="text-center py-6" style="opacity: 0.6;">
                            <div style="font-size: 3rem; margin-bottom: 12px;">üìù</div>
                            <MudText Typo="Typo.body1" Color="Color.Secondary">
                                No articles yet. Start building your chronicle!
                            </MudText>
                        </div>
                    }
                </MudPaper>
            </MudItem>

            <!-- Quick Actions & Tips -->
            <MudItem xs="12" md="4">
                <!-- Quick Actions -->
                <MudPaper Elevation="2" Class="pa-6 mb-4">
                    <MudText Typo="Typo.h6" Class="mb-3" Style="color: #C4AF8E;">
                        ‚ö° Quick Actions
                    </MudText>
                    <MudStack Spacing="2">
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.PersonAdd"
                                   OnClick="@(() => VM.CreateArticleWithTitleAsync("New Character"))">
                            Create Character
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Place"
                                   OnClick="@(() => VM.CreateArticleWithTitleAsync("New Location"))">
                            Add Location
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.CalendarToday"
                                   OnClick="@(() => VM.CreateArticleWithTitleAsync("Session Notes"))">
                            Session Notes
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.AutoStories"
                                   OnClick="@(() => VM.CreateArticleWithTitleAsync("Lore Entry"))">
                            Lore Entry
                        </MudButton>
                    </MudStack>
                </MudPaper>

                <!-- Tips Card -->
                <MudPaper Elevation="2" Class="pa-6" Style="background: linear-gradient(135deg, rgba(196, 175, 142, 0.1) 0%, rgba(196, 175, 142, 0.05) 100%);">
                    <MudText Typo="Typo.h6" Class="mb-3" Style="color: #C4AF8E;">
                        üí° Pro Tips
                    </MudText>
                    <MudStack Spacing="3">
                        <div>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Search Tree:</strong>
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Use the search box in the sidebar to filter articles by title
                            </MudText>
                        </div>
                        <MudDivider />
                        <div>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Organize with Hierarchy:</strong>
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Use the three-dot menu to add child articles and build your knowledge tree
                            </MudText>
                        </div>
                        <MudDivider />
                        <div>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Auto-Save:</strong>
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Your work saves automatically as you type‚Äîno need to click Save!
                            </MudText>
                        </div>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Inspirational Quote Footer -->
        <MudPaper Elevation="0" Class="pa-6 mt-6 text-center chronicis-quote-footer" Style="background: rgba(196, 175, 142, 0.05); border: 1px solid rgba(196, 175, 142, 0.2); border-radius: 8px;">
            @if (VM.LoadingQuote)
            {
                <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
            }
            else if (VM.Quote != null)
            {
                <MudText Typo="Typo.body1" Style="font-style: italic; color: #3A4750;">
                    "@VM.Quote.Content"
                </MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                    ‚Äî @VM.Quote.Author
                </MudText>
                <MudTooltip Text="Get a new quote">
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   OnClick="VM.LoadNewQuoteAsync"
                                   Class="mt-2"
                                   Style="opacity: 0.6;" />
                </MudTooltip>
            }
        </MudPaper>
    </div>
}

@code {
    [Parameter]
    public string? Path { get; set; }

    protected override async Task OnInitializedAsync()
    {
        VM.PropertyChanged += OnVmPropertyChanged;
        await VM.InitializeAsync(Path);
    }

    protected override async Task OnParametersSetAsync()
    {
        await VM.OnParametersSetAsync(Path);
    }

    private void OnVmPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        VM.PropertyChanged -= OnVmPropertyChanged;
        VM.Dispose();
    }
}
