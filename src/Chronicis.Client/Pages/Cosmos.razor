@page "/articosmoscle/{*Path}"
@attribute [Authorize]
@inject ITreeStateService TreeStateService
@inject IArticleApiService ArticleApi
@inject IQuoteService QuoteService
@inject IBreadcrumbService BreadcrumbService
@inject NavigationManager Navigation
@implements IDisposable

@if (TreeStateService.SelectedArticleId.HasValue && TreeStateService.SelectedArticleId.Value != Guid.Empty)
{
    <ArticleDetail />
}
else
{
    <div class="chronicis-welcome-page">
        <!-- Hero Section -->
        <MudPaper Elevation="0" Class="chronicis-hero pa-8 mb-6" Style="background: linear-gradient(135deg, rgba(31, 42, 51, 0.95) 0%, rgba(58, 71, 80, 0.95) 100%); color: #F4F0EA; border-radius: 12px;">
            <div class="text-center">
                <div style="font-size: 4rem; margin-bottom: 16px;">üìñ‚ú®</div>
                <MudText Typo="Typo.h2" Class="mb-3" Style="font-family: 'Spellweaver Display', serif; color: #C4AF8E;">
                    Your Chronicle Awaits
                </MudText>
                <MudText Typo="Typo.h6" Class="mb-4" Style="opacity: 0.9; max-width: 600px; margin: 0 auto;">
                    Every great campaign deserves a legendary chronicle. Organize your world, track your story, and never forget a detail.
                </MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Secondary"
                           Size="Size.Large"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="CreateFirstArticle"
                           Class="mt-2">
                    Start Your First Article
                </MudButton>
            </div>
        </MudPaper>

        <!-- Stats Cards -->
        @if (_stats != null)
        {
            <MudGrid Class="mb-6">
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                        <div style="font-size: 2.5rem; color: #C4AF8E;">üìö</div>
                        <MudText Typo="Typo.h4" Class="mt-2">@_stats.TotalArticles</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Articles</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                        <div style="font-size: 2.5rem; color: #C4AF8E;">üóÇÔ∏è</div>
                        <MudText Typo="Typo.h4" Class="mt-2">@_stats.RootArticles</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Top-Level Topics</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                        <div style="font-size: 2.5rem; color: #C4AF8E;">‚úçÔ∏è</div>
                        <MudText Typo="Typo.h4" Class="mt-2">@_stats.RecentlyModified</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Edited This Week</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 text-center chronicis-stat-card">
                        <div style="font-size: 2.5rem; color: #C4AF8E;">üé≤</div>
                        <MudText Typo="Typo.h4" Class="mt-2">@_stats.DaysSinceStart</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Days Chronicling</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }

        <!-- Main Content Grid -->
        <MudGrid>
            <!-- Recent Articles -->
            <MudItem xs="12" md="8">
                <MudPaper Elevation="2" Class="pa-6">
                    <div class="d-flex align-center justify-space-between mb-4">
                        <MudText Typo="Typo.h5" Style="color: #C4AF8E;">
                            üìú Recent Articles
                        </MudText>
                        @if (_recentArticles?.Any() ?? false)
                        {
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Secondary"
                                       Size="Size.Small">
                                View All
                            </MudButton>
                        }
                    </div>

                    @if (_isLoadingRecent)
                    {
                        <div class="text-center py-4">
                            <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                        </div>
                    }
                    else if (_recentArticles?.Any() ?? false)
                    {
                        <MudList T="string">
                            @foreach (var article in _recentArticles)
                            {
                                <MudListItem T="string" OnClick="@(() => NavigateToArticle(article.Id))">
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@(string.IsNullOrEmpty(article.IconEmoji) ? Icons.Material.Filled.Description : article.IconEmoji)"
                                                 Color="Color.Secondary"
                                                 Class="mr-3" />
                                        <div style="flex: 1;">
                                            <MudText Typo="Typo.body1">
                                                @(string.IsNullOrEmpty(article.Title) ? "(Untitled)" : article.Title)
                                            </MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                Modified @FormatRelativeTime(article.ModifiedAt.HasValue ? article.ModifiedAt.Value : article.CreatedAt)
                                            </MudText>
                                        </div>
                                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" />
                                    </div>
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>
                    }
                    else
                    {
                        <div class="text-center py-6" style="opacity: 0.6;">
                            <div style="font-size: 3rem; margin-bottom: 12px;">üìù</div>
                            <MudText Typo="Typo.body1" Color="Color.Secondary">
                                No articles yet. Start building your chronicle!
                            </MudText>
                        </div>
                    }
                </MudPaper>
            </MudItem>

            <!-- Quick Actions & Tips -->
            <MudItem xs="12" md="4">
                <!-- Quick Actions -->
                <MudPaper Elevation="2" Class="pa-6 mb-4">
                    <MudText Typo="Typo.h6" Class="mb-3" Style="color: #C4AF8E;">
                        ‚ö° Quick Actions
                    </MudText>
                    <MudStack Spacing="2">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.PersonAdd"
                                   OnClick="@(() => CreateArticleWithTitle("New Character"))">
                            Create Character
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Place"
                                   OnClick="@(() => CreateArticleWithTitle("New Location"))">
                            Add Location
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.CalendarToday"
                                   OnClick="@(() => CreateArticleWithTitle("Session Notes"))">
                            Session Notes
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.AutoStories"
                                   OnClick="@(() => CreateArticleWithTitle("Lore Entry"))">
                            Lore Entry
                        </MudButton>
                    </MudStack>
                </MudPaper>

                <!-- Tips Card -->
                <MudPaper Elevation="2" Class="pa-6" Style="background: linear-gradient(135deg, rgba(196, 175, 142, 0.1) 0%, rgba(196, 175, 142, 0.05) 100%);">
                    <MudText Typo="Typo.h6" Class="mb-3" Style="color: #C4AF8E;">
                        üí° Pro Tips
                    </MudText>
                    <MudStack Spacing="3">
                        <div>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Search Tree:</strong>
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Use the search box in the sidebar to filter articles by title
                            </MudText>
                        </div>
                        <MudDivider />
                        <div>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Organize with Hierarchy:</strong>
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Use the three-dot menu to add child articles and build your knowledge tree
                            </MudText>
                        </div>
                        <MudDivider />
                        <div>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Auto-Save:</strong>
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Your work saves automatically as you type‚Äîno need to click Save!
                            </MudText>
                        </div>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Inspirational Quote Footer -->
        <MudPaper Elevation="0" Class="pa-6 mt-6 text-center chronicis-quote-footer" Style="background: rgba(196, 175, 142, 0.05); border: 1px solid rgba(196, 175, 142, 0.2); border-radius: 8px;">
            @if (_loadingQuote)
            {
                <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
            }
            else if (_quote != null)
            {
                <MudText Typo="Typo.body1" Style="font-style: italic; color: #3A4750;">
                    "@_quote.Content"
                </MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                    ‚Äî @_quote.Author
                </MudText>
                <MudTooltip Text="Get a new quote">
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   OnClick="LoadNewQuote"
                                   Class="mt-2"
                                   Style="opacity: 0.6;" />
                </MudTooltip>
            }
        </MudPaper>
    </div>
}

@code {
    [Parameter]
    public string? Path { get; set; }

    private CampaignStats? _stats;
    private List<ArticleDto>? _recentArticles;
    private bool _isLoadingRecent = true;
    private Quote? _quote;
    private bool _loadingQuote = true;

    protected override async Task OnInitializedAsync()
    {
        TreeStateService.OnStateChanged += OnTreeStateChanged;

        // If URL has article path, load it
        if (!string.IsNullOrEmpty(Path))
        {
            await LoadArticleByPath(Path);
        }

        await Task.WhenAll(
            LoadDashboardData(),
            LoadQuote()
        );
    }

    protected override async Task OnParametersSetAsync()
    {
        // Handle URL changes (browser back/forward)
        if (!string.IsNullOrEmpty(Path))
        {
            await LoadArticleByPath(Path);
        }
    }

    private async Task LoadArticleByPath(string path)
    {
        try
        {
            var article = await ArticleApi.GetArticleByPathAsync(path);

            if (article != null)
            {
                if (article.Id != TreeStateService.SelectedArticleId)
                {
                    TreeStateService.ExpandPathToAndSelect(article.Id);
                }
            }
            else
            {
                // Article not found
                if (!TreeStateService.SelectedArticleId.HasValue)
                {
                    Console.Error.WriteLine($"Article not found for path: {path}");
                    Navigation.NavigateTo("/", replace: true);
                }
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading article by path: {ex.Message}");
            if (!TreeStateService.SelectedArticleId.HasValue)
            {
                Navigation.NavigateTo("/", replace: true);
            }
        }
    }

    private async Task LoadQuote()
    {
        _loadingQuote = true;
        StateHasChanged();

        try
        {
            _quote = await QuoteService.GetRandomQuoteAsync();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading quote: {ex.Message}");
            // Fallback quote already handled in service
        }
        finally
        {
            _loadingQuote = false;
            StateHasChanged();
        }
    }

    private async Task LoadNewQuote()
    {
        await LoadQuote();
    }

    private async Task LoadDashboardData()
    {
        _isLoadingRecent = true;
        StateHasChanged();

        try
        {
            // Load recent articles (top 5 by modified date)
            var allArticles = await ArticleApi.GetRootArticlesAsync();
            _recentArticles = await GetRecentArticlesRecursive(allArticles);

            // Calculate stats
            _stats = new CampaignStats
            {
                TotalArticles = CountTotalArticles(allArticles),
                RootArticles = allArticles.Count,
                RecentlyModified = _recentArticles.Count(a =>
                    (a.ModifiedAt.HasValue ? a.ModifiedAt.Value : a.CreatedAt) > DateTime.Now.AddDays(-7)),
                DaysSinceStart = allArticles.Any()
                    ? (int)(DateTime.Now - allArticles.Min(a => a.CreatedAt)).TotalDays
                    : 0
            };
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            _isLoadingRecent = false;
            StateHasChanged();
        }
    }

    private async Task<List<ArticleDto>> GetRecentArticlesRecursive(List<ArticleTreeDto> articles, int maxResults = 5)
    {
        var allArticles = new List<ArticleDto>();

        foreach (var article in articles)
        {
            // Convert TreeDto to full Dto
            var fullArticle = await ArticleApi.GetArticleAsync(article.Id);
            if (fullArticle != null)
            {
                allArticles.Add(fullArticle);
            }

            // Recursively get children
            if (article.HasChildren && article.Children != null)
            {
                var childArticles = await GetRecentArticlesRecursive(article.Children.ToList(), maxResults);
                allArticles.AddRange(childArticles);
            }
        }

        return allArticles
            .OrderByDescending(a => a.ModifiedAt.HasValue ? a.ModifiedAt.Value : a.CreatedAt)
            .Take(maxResults)
            .ToList();
    }

    private int CountTotalArticles(List<ArticleTreeDto> articles)
    {
        int count = articles.Count;
        foreach (var article in articles)
        {
            if (article.Children != null)
            {
                count += CountTotalArticles(article.Children.ToList());
            }
        }
        return count;
    }

    private async Task NavigateToArticle(Guid articleId)
    {
        // Get the full article details to build path from breadcrumbs
        var article = await ArticleApi.GetArticleDetailAsync(articleId);
        if (article != null && article.Breadcrumbs.Any())
        {
            var path = BreadcrumbService.BuildArticleUrl(article.Breadcrumbs);
            Navigation.NavigateTo(path);
        }
    }

    private async Task CreateFirstArticle()
    {
        await CreateArticleWithTitle(string.Empty);
    }

    private async Task CreateArticleWithTitle(string title)
    {
        var createDto = new ArticleCreateDto
        {
            Title = title,
            Body = string.Empty,
            ParentId = null,
            EffectiveDate = DateTime.Now
        };

        var created = await ArticleApi.CreateArticleAsync(createDto);
        if (created == null)
        {
            Console.Error.WriteLine("Failed to create article");
            return;
        }

        await TreeStateService.RefreshAsync();
        TreeStateService.ExpandPathToAndSelect(created.Id);
    }

    private string FormatRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)}w ago";

        return dateTime.ToString("MMM d, yyyy");
    }

    private void OnTreeStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        TreeStateService.OnStateChanged -= OnTreeStateChanged;
    }

    private class CampaignStats
    {
        public int TotalArticles { get; set; }
        public int RootArticles { get; set; }
        public int RecentlyModified { get; set; }
        public int DaysSinceStart { get; set; }
    }
}
