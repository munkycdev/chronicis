@page "/arc/{ArcId:guid}"
@attribute [Authorize]
@using Chronicis.Shared.DTOs
@using Chronicis.Shared.Enums
@using Chronicis.Client.Components.Dialogs
@using Chronicis.Client.Components.Shared
@using Chronicis.Client.Utilities
@inject IArcApiService ArcApi
@inject ICampaignApiService CampaignApi
@inject IWorldApiService WorldApi
@inject IArticleApiService ArticleApi
@inject ITreeStateService TreeState
@inject IBreadcrumbService BreadcrumbService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@if (_isLoading)
{
    <LoadingSkeleton />
}
else if (_arc != null)
{
    <MudPaper Elevation="2" Class="chronicis-article-card chronicis-fade-in">
        <DetailPageHeader Breadcrumbs="_breadcrumbs"
                          Icon="@Icons.Material.Filled.Bookmark"
                          @bind-Title="_editName"
                          Placeholder="Arc Name"
                          OnTitleEdited="OnNameChanged"
                          OnEnterPressed="SaveArc" />

        <!-- Description -->
        <MudTextField @bind-Value="_editDescription"
                      Label="Description"
                      Variant="Variant.Outlined"
                      Lines="3"
                      Placeholder="Describe this arc..."
                      Class="mb-4"
                      Immediate="true"
                      @onkeyup="OnDescriptionChanged" />

        <!-- Sort Order -->
        <MudNumericField @bind-Value="_editSortOrder"
                         Label="Sort Order"
                         Variant="Variant.Outlined"
                         Min="0"
                         Class="mb-4"
                         Style="max-width: 150px;"
                         Immediate="true"
                         @onkeyup="OnSortOrderChanged" />

        <!-- Sessions Section -->
        <div class="d-flex align-center justify-space-between mb-3">
            <MudText Typo="Typo.h6" Style="color: var(--chronicis-beige-gold);">
                <MudIcon Icon="@Icons.Material.Filled.EventNote" Size="Size.Small" Class="mr-2" />
                Sessions
            </MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="CreateSession">
                New Session
            </MudButton>
        </div>

        @if (_sessions.Any())
        {
            <MudList T="ArticleTreeDto" Dense="true" Class="mb-4">
                @foreach (var session in _sessions.OrderBy(s => s.Title))
                {
                    <EntityListItem Icon="@Icons.Material.Filled.EventNote"
                                    Title="@(string.IsNullOrEmpty(session.Title) ? "Untitled Session" : session.Title)"
                                    OnClick="@(() => NavigateToSession(session))" />
                }
            </MudList>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                No sessions yet. Create your first session to start documenting your adventures!
            </MudAlert>
        }

        <!-- Arc Info -->
        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--chronicis-beige-gold);">
            Arc Info
        </MudText>
        
        <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
            <tbody>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.PlayCircle" Size="Size.Small" Class="mr-2" />Active Arc</td>
                    <td>
                        <MudSwitch T="bool" 
                                   Value="_arc.IsActive" 
                                   ValueChanged="OnActiveToggle"
                                   Color="Color.Success"
                                   Size="Size.Small"
                                   Disabled="_isTogglingActive" />
                    </td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.EventNote" Size="Size.Small" Class="mr-2" />Sessions</td>
                    <td>@_arc.SessionCount</td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.Sort" Size="Size.Small" Class="mr-2" />Sort Order</td>
                    <td>@_arc.SortOrder</td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-2" />Created</td>
                    <td>@_arc.CreatedAt.ToString("MMMM d, yyyy")</td>
                </tr>
            </tbody>
        </MudSimpleTable>

        <!-- AI Summary Section -->
        <AISummarySection EntityId="ArcId" 
                          EntityType="Arc" 
                          @bind-IsExpanded="_summaryExpanded" />

        <!-- Save Status -->
        <div class="chronicis-flex-between mt-4">
            <SaveStatusIndicator IsSaving="_isSaving" HasUnsavedChanges="_hasUnsavedChanges" />

            <div class="d-flex gap-2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="SaveArc"
                           Disabled="_isSaving"
                           StartIcon="@Icons.Material.Filled.Save">
                    Save
                </MudButton>
                
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           OnClick="DeleteArc"
                           Disabled="_isSaving || _sessions.Any()"
                           StartIcon="@Icons.Material.Filled.Delete">
                    Delete
                </MudButton>
            </div>
        </div>
        
        @if (_sessions.Any())
        {
            <MudText Typo="Typo.caption" Class="mt-2" Style="color: var(--mud-palette-text-secondary);">
                Delete all sessions before deleting this arc.
            </MudText>
        }
    </MudPaper>
}

@code {
    [Parameter]
    public Guid ArcId { get; set; }

    private ArcDto? _arc;
    private CampaignDto? _campaign;
    private WorldDto? _world;
    private List<ArticleTreeDto> _sessions = new();
    private string _editName = string.Empty;
    private string _editDescription = string.Empty;
    private int _editSortOrder = 0;
    private bool _isLoading = true;
    private bool _isSaving = false;
    private bool _isTogglingActive = false;
    private bool _hasUnsavedChanges = false;
    private bool _summaryExpanded = false;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnParametersSetAsync()
    {
        await LoadArcAsync();
    }

    private async Task LoadArcAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _arc = await ArcApi.GetArcAsync(ArcId);
            if (_arc == null)
            {
                Navigation.NavigateTo("/dashboard", replace: true);
                return;
            }
            else
            {
                _editName = _arc.Name;
                _editDescription = _arc.Description ?? string.Empty;
                _editSortOrder = _arc.SortOrder;
                _hasUnsavedChanges = false;

                // Load sessions (articles with ArcId and Session type)
                var allArticles = await ArticleApi.GetAllArticlesAsync();
                _sessions = allArticles
                    .Where(a => a.ArcId == ArcId && a.Type == ArticleType.Session)
                    .ToList();

                // Load campaign and world for breadcrumbs
                _campaign = await CampaignApi.GetCampaignAsync(_arc.CampaignId);
                if (_campaign != null)
                {
                    var worldDetail = await WorldApi.GetWorldAsync(_campaign.WorldId);
                    _world = worldDetail != null ? new WorldDto 
                    { 
                        Id = worldDetail.Id, 
                        Name = worldDetail.Name,
                        Slug = worldDetail.Slug
                    } : null;
                }

                if (_arc != null && _campaign != null && _world != null)
                {
                    _breadcrumbs = BreadcrumbService.ForArc(_arc, _campaign, _world);
                }
                else
                {
                    // Fallback if data not fully loaded
                    _breadcrumbs = new List<BreadcrumbItem>
                    {
                        new("Dashboard", href: "/dashboard"),
                        new(_arc?.Name ?? "Arc", href: null, disabled: true)
                    };
                }

                await JSRuntime.InvokeVoidAsync("eval", $"document.title = '{JsUtilities.EscapeForJs(_arc?.Name ?? "Arc")} - Chronicis'");
                
                // Highlight in tree
                TreeState.ExpandPathToAndSelect(ArcId);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load arc: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnNameChanged() => _hasUnsavedChanges = true;
    private void OnDescriptionChanged() => _hasUnsavedChanges = true;
    private void OnSortOrderChanged() => _hasUnsavedChanges = true;

    private async Task OnActiveToggle(bool isActive)
    {
        if (_arc == null || _isTogglingActive) return;
        
        _isTogglingActive = true;
        StateHasChanged();

        try
        {
            if (isActive)
            {
                var success = await ArcApi.ActivateArcAsync(ArcId);
                if (success)
                {
                    _arc.IsActive = true;
                    Snackbar.Add("Arc set as active", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Failed to activate arc", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("To deactivate, set another arc as active", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isTogglingActive = false;
            StateHasChanged();
        }
    }

    private async Task SaveArc()
    {
        if (_arc == null || _isSaving) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            var updateDto = new ArcUpdateDto
            {
                Name = _editName.Trim(),
                Description = string.IsNullOrWhiteSpace(_editDescription) ? null : _editDescription.Trim(),
                SortOrder = _editSortOrder
            };

            var updated = await ArcApi.UpdateArcAsync(ArcId, updateDto);
            if (updated != null)
            {
                _arc.Name = updated.Name;
                _arc.Description = updated.Description;
                _arc.SortOrder = updated.SortOrder;
                _hasUnsavedChanges = false;

                await TreeState.RefreshAsync();
                await JSRuntime.InvokeVoidAsync("eval", $"document.title = '{JsUtilities.EscapeForJs(_editName)} - Chronicis'");
                
                Snackbar.Add("Arc saved", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task DeleteArc()
    {
        if (_arc == null || _sessions.Any()) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to delete '{_arc.Name}'?\n\nThis action cannot be undone.");

        if (!confirmed) return;

        try
        {
            await ArcApi.DeleteArcAsync(ArcId);
            await TreeState.RefreshAsync();
            
            Snackbar.Add("Arc deleted", Severity.Success);
            Navigation.NavigateTo($"/campaign/{_arc.CampaignId}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to delete: {ex.Message}", Severity.Error);
        }
    }

    private async Task CreateSession()
    {
        if (_arc == null || _campaign == null) return;

        var sessionNumber = _sessions.Count + 1;
        var createDto = new ArticleCreateDto
        {
            Title = $"Session {sessionNumber}",
            Body = string.Empty,
            WorldId = _campaign.WorldId,
            CampaignId = _campaign.Id,
            ArcId = ArcId,
            Type = ArticleType.Session,
            EffectiveDate = DateTime.Now
        };

        var created = await ArticleApi.CreateArticleAsync(createDto);
        if (created == null)
        {
            Snackbar.Add("Failed to create session", Severity.Error);
            return;
        }

        await TreeState.RefreshAsync();
        await LoadArcAsync();

        // Navigate using full path from breadcrumbs
        if (created.Breadcrumbs.Any())
        {
            var path = BreadcrumbService.BuildArticleUrl(created.Breadcrumbs);
            Navigation.NavigateTo(path);
        }
        else
        {
            Navigation.NavigateTo($"/article/{created.Slug}");
        }
        Snackbar.Add("Session created", Severity.Success);
    }

    private async Task NavigateToSession(ArticleTreeDto session)
    {
        // Load full article to get breadcrumbs for proper path
        var article = await ArticleApi.GetArticleDetailAsync(session.Id);
        if (article != null && article.Breadcrumbs.Any())
        {
            var path = BreadcrumbService.BuildArticleUrl(article.Breadcrumbs);
            Navigation.NavigateTo(path);
        }
        else
        {
            // Fallback
            Navigation.NavigateTo($"/article/{session.Slug}");
        }
    }
}
