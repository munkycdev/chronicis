@page "/arc/{ArcId:guid}"
@attribute [Authorize]
@implements IDisposable
@using Chronicis.Shared.DTOs
@using Chronicis.Shared.DTOs.Quests
@using Chronicis.Shared.DTOs.Sessions
@using Chronicis.Client.Components.Dialogs
@using Chronicis.Client.Components.Shared
@using Chronicis.Client.Components.Quests
@inject ArcDetailViewModel ViewModel
@inject IAppContextService AppContext

@if (ViewModel.IsLoading)
{
    <LoadingSkeleton />
}
else if (ViewModel.Arc != null)
{
    <MudPaper Elevation="2" Class="chronicis-article-card chronicis-fade-in">
        <DetailPageHeader Breadcrumbs="ViewModel.Breadcrumbs"
                          Icon="@Icons.Material.Filled.Bookmark"
                          Title="@ViewModel.EditName"
                          TitleChanged="@(v => ViewModel.EditName = v)"
                          Placeholder="Arc Name"
                          OnTitleEdited="@(() => {})"
                          OnEnterPressed="@(() => ViewModel.SaveAsync())" />

        <MudTextField Value="@ViewModel.EditDescription"
                      ValueChanged="@((string v) => ViewModel.EditDescription = v)"
                      Label="Description"
                      Variant="Variant.Outlined"
                      Lines="3"
                      Placeholder="Describe this arc..."
                      Class="mb-4"
                      Immediate="true" />

        <MudNumericField Value="@ViewModel.EditSortOrder"
                         ValueChanged="@((int v) => ViewModel.EditSortOrder = v)"
                         Label="Sort Order"
                         Variant="Variant.Outlined"
                         Min="0"
                         Class="mb-4"
                         Style="max-width: 150px;"
                         Immediate="true" />

        <div class="d-flex align-center justify-space-between mb-3">
            <MudText Typo="Typo.h6" Style="color: var(--chronicis-beige-gold);">
                <MudIcon Icon="@Icons.Material.Filled.EventNote" Size="Size.Small" Class="mr-2" />
                Sessions
            </MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@(() => ViewModel.CreateSessionAsync())">
                New Session
            </MudButton>
        </div>

        @if (ViewModel.Sessions.Any())
        {
            <MudList T="SessionTreeDto" Dense="true" Class="mb-4">
                @foreach (var session in ViewModel.Sessions.OrderBy(s => s.Name))
                {
                    <EntityListItem Icon="@Icons.Material.Filled.EventNote"
                                    Title="@(string.IsNullOrEmpty(session.Name) ? "Untitled Session" : session.Name)"
                                    OnClick="@(() => ViewModel.NavigateToSessionAsync(session))" />
                }
            </MudList>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                No sessions yet. Create your first session to start documenting your adventures!
            </MudAlert>
        }

        <ArcQuestList ArcId="@ArcId" IsGm="ViewModel.IsCurrentUserGM" OnEditQuest="ViewModel.OnEditQuest" />

        @if (ViewModel.SelectedQuest != null)
        {
            <MudDivider Class="my-4" />
            <ArcQuestEditor Quest="ViewModel.SelectedQuest"
                            OnQuestUpdated="ViewModel.OnQuestUpdated" />
            <ArcQuestTimeline Quest="ViewModel.SelectedQuest"
                              IsGm="ViewModel.IsCurrentUserGM"
                              CurrentUserId="ViewModel.CurrentUserId" />
        }

        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--chronicis-beige-gold);">
            Arc Info
        </MudText>

        <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
            <tbody>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.PlayCircle" Size="Size.Small" Class="mr-2" />Active Arc</td>
                    <td>
                        <MudSwitch T="bool"
                                   Value="ViewModel.Arc.IsActive"
                                   ValueChanged="@((bool v) => ViewModel.OnActiveToggleAsync(v))"
                                   Color="Color.Success"
                                   Size="Size.Small"
                                   Disabled="ViewModel.IsTogglingActive" />
                    </td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.EventNote" Size="Size.Small" Class="mr-2" />Sessions</td>
                    <td>@ViewModel.Arc.SessionCount</td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.Sort" Size="Size.Small" Class="mr-2" />Sort Order</td>
                    <td>@ViewModel.Arc.SortOrder</td>
                </tr>
                <tr>
                    <td><MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-2" />Created</td>
                    <td>@ViewModel.Arc.CreatedAt.ToString("MMMM d, yyyy")</td>
                </tr>
            </tbody>
        </MudSimpleTable>

        <AISummarySection EntityId="ArcId"
                          EntityType="Arc"
                          IsExpanded="ViewModel.SummaryExpanded"
                          IsExpandedChanged="@((bool v) => ViewModel.SummaryExpanded = v)" />

        <div class="chronicis-flex-between mt-4">
            <SaveStatusIndicator IsSaving="ViewModel.IsSaving" HasUnsavedChanges="ViewModel.HasUnsavedChanges" />

            <div class="d-flex gap-2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="@(() => ViewModel.SaveAsync())"
                           Disabled="ViewModel.IsSaving"
                           StartIcon="@Icons.Material.Filled.Save">
                    Save
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           OnClick="@(() => ViewModel.DeleteAsync())"
                           Disabled="@(ViewModel.IsSaving || ViewModel.Sessions.Any())"
                           StartIcon="@Icons.Material.Filled.Delete">
                    Delete
                </MudButton>
            </div>
        </div>

        @if (ViewModel.Sessions.Any())
        {
            <MudText Typo="Typo.caption" Class="mt-2" Style="color: var(--mud-palette-text-secondary);">
                Delete all sessions before deleting this arc.
            </MudText>
        }
    </MudPaper>
}

@code {
    [Parameter]
    public Guid ArcId { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        ViewModel.PropertyChanged += OnViewModelChanged;
        await ViewModel.LoadAsync(ArcId);

        if (ViewModel.Campaign != null &&
            (AppContext.CurrentWorldId != ViewModel.Campaign.WorldId || AppContext.CurrentCampaignId != ViewModel.Campaign.Id))
        {
            await AppContext.SelectWorldAsync(ViewModel.Campaign.WorldId, ViewModel.Campaign.Id);
        }
    }

    private void OnViewModelChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
        => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        ViewModel.PropertyChanged -= OnViewModelChanged;
    }
}
