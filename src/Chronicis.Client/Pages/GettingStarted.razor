@page "/getting-started"
@attribute [Authorize]
@inject GettingStartedViewModel VM
@implements IDisposable

@code {
    private readonly ILogger<GettingStarted> _logger;

    // Direct constructor injection
    public GettingStarted(ILogger<GettingStarted> logger)
    {
        _logger = logger;
    }
}

<PageTitle>Quick Start Guide - Chronicis</PageTitle>

<div class="getting-started-page">
    <div class="getting-started-content">
        @if (VM.CurrentStep == 0)
        {
            <!-- Step 1: Welcome -->
            <div class="step-container chronicis-fade-in">
                <div class="welcome-icon">üìñ‚ú®</div>
                <h1>@(VM.IsReturningUser ? "Quick Start Guide" : "Welcome to Chronicis")</h1>
                <p class="welcome-subtitle">
                    Your personal chronicle for tabletop adventures
                </p>
                
                <div class="welcome-features">
                    <div class="feature-item">
                        <span class="feature-icon">üåç</span>
                        <div>
                            <strong>Build Your World</strong>
                            <p>Create rich settings with locations, NPCs, and lore</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">üìù</span>
                        <div>
                            <strong>Track Your Sessions</strong>
                            <p>Document adventures and never forget what happened</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">üîó</span>
                        <div>
                            <strong>Connect Everything</strong>
                            <p>Link articles together with wiki-style [[brackets]]</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">ü§ñ</span>
                        <div>
                            <strong>AI-Powered Summaries</strong>
                            <p>Let AI help you remember the important details</p>
                        </div>
                    </div>
                </div>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Large"
                           OnClick="VM.NextStep"
                           Class="mt-6"
                           EndIcon="@Icons.Material.Filled.ArrowForward">
                    @(VM.IsReturningUser ? "Review the Basics" : "Let's Get Started")
                </MudButton>
            </div>
        }
        else if (VM.CurrentStep == 1)
        {
            <!-- Step 2: Understanding the Structure -->
            <div class="step-container chronicis-fade-in">
                <div class="step-icon">üèóÔ∏è</div>
                <h1>How Chronicis is Organized</h1>
                <p class="step-subtitle">
                    Your content is organized in a hierarchy that mirrors how tabletop campaigns work.
                </p>

                <div class="structure-explanation">
                    <div class="structure-item">
                        <div class="structure-header">
                            <span class="structure-icon">üåç</span>
                            <strong>World</strong>
                        </div>
                        <p>
                            Your campaign setting ‚Äî the universe where your adventures take place. 
                            This could be an official setting like <em>Forgotten Realms</em> or <em>Eberron</em>, 
                            or your own homebrew creation. Everything else lives inside a World.
                        </p>
                    </div>

                    <div class="structure-item">
                        <div class="structure-header">
                            <span class="structure-icon">üìú</span>
                            <strong>Campaign</strong>
                        </div>
                        <p>
                            A specific adventure or ongoing game with your group. You might run 
                            <em>Curse of Strahd</em> and <em>Tomb of Annihilation</em> in the same world ‚Äî 
                            those would be two separate campaigns. Each campaign tracks its own story.
                        </p>
                    </div>

                    <div class="structure-item">
                        <div class="structure-header">
                            <span class="structure-icon">üìö</span>
                            <strong>Arc</strong>
                        </div>
                        <p>
                            Story chapters within a campaign. Maybe your party spent several sessions 
                            in Waterdeep, then traveled to Baldur's Gate ‚Äî those could be separate arcs. 
                            Arcs help you organize sessions into meaningful chunks.
                        </p>
                    </div>

                    <div class="structure-item">
                        <div class="structure-header">
                            <span class="structure-icon">üé≤</span>
                            <strong>Session</strong>
                        </div>
                        <p>
                            A single game night. Each session belongs to an arc and captures what 
                            happened during that play session ‚Äî encounters, discoveries, memorable moments.
                        </p>
                    </div>
                </div>

                <div class="button-row">
                    <MudButton Variant="Variant.Text"
                               Color="Color.Default"
                               OnClick="VM.PreviousStep"
                               StartIcon="@Icons.Material.Filled.ArrowBack">
                        Back
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               OnClick="VM.NextStep"
                               EndIcon="@Icons.Material.Filled.ArrowForward">
                        Continue
                    </MudButton>
                </div>
            </div>
        }
        else if (VM.CurrentStep == 2)
        {
            <!-- Step 3: Sidebar Sections -->
            <div class="step-container chronicis-fade-in">
                <div class="step-icon">üìÇ</div>
                <h1>Your Sidebar Sections</h1>
                <p class="step-subtitle">
                    Each world has four main sections in the sidebar to organize your content.
                </p>

                <div class="sections-explanation">
                    <div class="section-item campaigns">
                        <div class="section-header">
                            <span class="section-badge">üìÅ</span>
                            <strong>CAMPAIGNS</strong>
                        </div>
                        <p>
                            Where your game sessions live. Create campaigns, add arcs to organize 
                            the story, then log sessions as you play. This is your adventure timeline.
                        </p>
                        <div class="section-tip">
                            <strong>Tip:</strong> After each session, jot down key events, NPCs met, 
                            and decisions made. Future you will thank present you.
                        </div>
                    </div>

                    <div class="section-item characters">
                        <div class="section-header">
                            <span class="section-badge">üë•</span>
                            <strong>PLAYER CHARACTERS</strong>
                        </div>
                        <p>
                            Home for player characters in your group. Create a character articles on the World Detail page,
                            then <strong>claim it as yours</strong> to see it on your dashboard. 
                            Track backstory, goals, relationships, and growth.
                        </p>
                        <div class="section-tip">
                            <strong>Tip:</strong> Link your character to NPCs and locations using 
                            [[wiki links]] to build a web of connections.
                        </div>
                    </div>

                    <div class="section-item wiki">
                        <div class="section-header">
                            <span class="section-badge">üìñ</span>
                            <strong>WIKI</strong>
                        </div>
                        <p>
                            Your world-building encyclopedia. Document locations, NPCs, factions, 
                            items, lore, religions, history ‚Äî anything that makes your world feel alive. 
                            Nest articles to create hierarchies (e.g., Continent ‚Üí Region ‚Üí City ‚Üí District).
                        </p>
                        <div class="section-tip">
                            <strong>Tip:</strong> Use the AI Summary feature on articles with lots of 
                            backlinks to auto-generate useful overviews.
                        </div>
                    </div>

                    <div class="section-item resources">
                        <div class="section-header">
                            <span class="section-badge">üîó</span>
                            <strong>EXTERNAL RESOURCES</strong>
                        </div>
                        <p>
                            Quick links to tools your group uses ‚Äî D&D Beyond character sheets, 
                            Roll20 or Foundry VTT, shared Google Drives, Discord servers. 
                            Plus, upload documents like character sheets, maps, handouts, and reference 
                            materials (PDFs, Office files, images up to 200MB) to keep everything in one place.
                        </p>
                        <div class="section-tip">
                            <strong>Tip:</strong> Only the world owner can upload and manage documents, 
                            but all members can download them.
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <MudButton Variant="Variant.Text"
                               Color="Color.Default"
                               OnClick="VM.PreviousStep"
                               StartIcon="@Icons.Material.Filled.ArrowBack">
                        Back
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               OnClick="VM.NextStep"
                               EndIcon="@Icons.Material.Filled.ArrowForward">
                        Continue
                    </MudButton>
                </div>
            </div>
        }
        else if (VM.CurrentStep == 3)
        {
            <!-- Step 4: Ready to Go -->
            <div class="step-container chronicis-fade-in">
                <div class="step-icon">üéâ</div>
                <h1>You're Ready!</h1>
                <p class="step-subtitle">
                    Here's how to get the most out of Chronicis:
                </p>

                <div class="tips-grid">
                    <div class="tip-card">
                        <div class="tip-icon">üîó</div>
                        <strong>Link Everything</strong>
                        <p>Type <code>[[Article Name]]</code> to create links between articles. 
                        This builds a connected knowledge base.</p>
                    </div>

                    <div class="tip-card">
                        <div class="tip-icon">üë§</div>
                        <strong>Claim Your Character</strong>
                        <p>Open your character article and click "Claim as My Character" 
                        to see it on your dashboard.</p>
                    </div>

                    <div class="tip-card">
                        <div class="tip-icon">ü§ñ</div>
                        <strong>Generate Summaries</strong>
                        <p>Articles with backlinks can generate AI summaries. 
                        Click the summary button in the article sidebar.</p>
                    </div>

                    <div class="tip-card">
                        <div class="tip-icon">‚å®Ô∏è</div>
                        <strong>Keyboard Shortcuts</strong>
                        <p><code>Ctrl+S</code> to save, <code>Ctrl+N</code> to create a new article. 
                        Your work also auto-saves as you type.</p>
                    </div>

                    <div class="tip-card">
                        <div class="tip-icon">üìÇ</div>
                        <strong>Drag to Organize</strong>
                        <p>Drag articles in the sidebar to reorganize your hierarchy. 
                        Nest content however makes sense for your world.</p>
                    </div>

                    <div class="tip-card">
                        <div class="tip-icon">üåê</div>
                        <strong>Share Your World</strong>
                        <p>Make your world public in World Settings to share it with anyone 
                        via a custom URL‚Äîno login required for viewers.</p>
                    </div>

                    <div class="tip-card">
                        <div class="tip-icon">üîí</div>
                        <strong>Keep Secrets Private</strong>
                        <p>Toggle any article to private in the metadata panel. 
                        Only you can see private articles‚Äîperfect for DM notes or plot twists.</p>
                    </div>

                    <div class="tip-card">
                        <div class="tip-icon">‚ùì</div>
                        <strong>Need Help?</strong>
                        <p>Click the help icon in the top bar anytime to return to this guide.</p>
                    </div>
                </div>

                <div class="button-row">
                    <MudButton Variant="Variant.Text"
                               Color="Color.Default"
                               OnClick="VM.PreviousStep"
                               StartIcon="@Icons.Material.Filled.ArrowBack">
                        Back
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               OnClick="VM.CompleteOnboardingAsync"
                               Disabled="VM.IsCompleting"
                               EndIcon="@Icons.Material.Filled.Check">
                        @if (VM.IsCompleting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Finishing up...</span>
                        }
                        else if (VM.IsReturningUser)
                        {
                            <span>Back to Dashboard</span>
                        }
                        else
                        {
                            <span>Start Your Chronicle</span>
                        }
                    </MudButton>
                </div>
            </div>
        }

        <!-- Progress Dots -->
        <div class="progress-dots">
            @for (int i = 0; i < GettingStartedViewModel.TotalSteps; i++)
            {
                var step = i;
                <div class="dot @(step == VM.CurrentStep ? "active" : "") @(step < VM.CurrentStep ? "completed" : "")"
                     @onclick="() => VM.GoToStep(step)"></div>
            }
        </div>
    </div>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        VM.PropertyChanged += OnVmPropertyChanged;
        await VM.InitializeAsync();
    }

    private void OnVmPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        VM.PropertyChanged -= OnVmPropertyChanged;
    }
}
