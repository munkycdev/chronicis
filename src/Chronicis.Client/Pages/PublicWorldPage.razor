@page "/w/{PublicSlug}"
@page "/w/{PublicSlug}/{*ArticlePath}"
@layout PublicLayout
@using Chronicis.Shared.DTOs
@using Chronicis.Shared.Enums
@using Chronicis.Client.Components.Shared
@using Microsoft.JSInterop
@inject IPublicApiService PublicApi
@inject IMarkdownService MarkdownService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@implements IDisposable

<PageTitle>@GetPageTitle()</PageTitle>

@if (_isLoading)
{
    <div class="public-world-loading">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Typo="Typo.body1" Class="mt-3">Loading world...</MudText>
    </div>
}
else if (_world == null)
{
    <div class="public-world-not-found">
        <MudPaper Elevation="2" Class="pa-6 text-center">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" 
                     Style="font-size: 64px; color: var(--chronicis-beige-gold);" />
            <MudText Typo="Typo.h5" Class="mt-4 mb-2">World Not Found</MudText>
            <MudText Typo="Typo.body1" Class="mud-text-secondary mb-4">
                This world doesn't exist or isn't publicly shared.
            </MudText>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       Href="/"
                       StartIcon="@Icons.Material.Filled.Home">
                Go Home
            </MudButton>
        </MudPaper>
    </div>
}
else
{
    <div class="public-world-container">
        <!-- Sidebar with article tree -->
        <aside class="public-world-sidebar">
            <div class="public-world-sidebar-header">
                <a href="/w/@PublicSlug" class="public-world-title-link">
                    <MudText Typo="Typo.subtitle1" Style="color: var(--chronicis-beige-gold); font-weight: 600;">
                        @_world.Name
                    </MudText>
                </a>
            </div>

            <MudDivider Class="my-2" Style="opacity: 0.3;" />

            @if (_articleTree.Count == 0)
            {
                <div class="pa-3">
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                        No public articles in this world yet.
                    </MudText>
                </div>
            }
            else
            {
                <div class="public-article-tree">
                    @foreach (var article in _articleTree)
                    {
                        <PublicArticleTreeItem Article="@article" 
                                               PublicSlug="@PublicSlug"
                                               CurrentPath="@ArticlePath"
                                               OnArticleSelected="NavigateToArticle" />
                    }
                </div>
            }
        </aside>

        <!-- Main content area -->
        <main class="public-world-main">
            @if (string.IsNullOrEmpty(ArticlePath))
            {
                <!-- World landing view -->
                <MudPaper Elevation="2" Class="pa-6">
                    <div class="public-world-hero">
                        <MudIcon Icon="@Icons.Material.Filled.Public" 
                                 Style="font-size: 48px; color: var(--chronicis-beige-gold);" />
                        <MudText Typo="Typo.h4" Class="mt-3">@_world.Name</MudText>
                        @if (!string.IsNullOrEmpty(_world.Description))
                        {
                            <MudText Typo="Typo.body1" Class="mud-text-secondary mt-2">
                                @_world.Description
                            </MudText>
                        }
                        <MudText Typo="Typo.caption" Class="mud-text-secondary mt-3">
                            Created by @_world.OwnerName
                        </MudText>
                    </div>

                    @if (_articleTree.Count > 0)
                    {
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Select an article from the sidebar to start reading.
                        </MudText>
                    }
                </MudPaper>
            }
            else if (_currentArticle == null && !_isLoadingArticle)
            {
                <!-- Article not found -->
                <MudPaper Elevation="2" Class="pa-6 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.Article" 
                             Style="font-size: 48px; color: var(--chronicis-beige-gold);" />
                    <MudText Typo="Typo.h6" Class="mt-3">Article Not Found</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary mt-2">
                        This article doesn't exist or isn't publicly visible.
                    </MudText>
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Primary" 
                               Class="mt-3"
                               OnClick="() => NavigateToArticle(string.Empty)">
                        Back to World Overview
                    </MudButton>
                </MudPaper>
            }
            else if (_isLoadingArticle)
            {
                <MudPaper Elevation="2" Class="pa-6">
                    <MudSkeleton Width="60%" Height="32px" />
                    <MudSkeleton Width="100%" Height="20px" Class="mt-4" />
                    <MudSkeleton Width="100%" Height="20px" Class="mt-2" />
                    <MudSkeleton Width="80%" Height="20px" Class="mt-2" />
                </MudPaper>
            }
            else
            {
                <!-- Article view -->
                <MudPaper Elevation="2" Class="pa-6">
                    <!-- Breadcrumbs -->
                    @if (_currentArticle!.Breadcrumbs?.Any() == true)
                    {
                        <ChroniclsBreadcrumbs Items="@GetBreadcrumbItems()" UseCustomLinks="true" Class="mb-3 pa-0" />
                    }

                    <!-- Article header -->
                    <div class="d-flex align-center gap-3 mb-4">
                        @if (!string.IsNullOrEmpty(_currentArticle.IconEmoji))
                        {
                            <IconDisplay Icon="@_currentArticle.IconEmoji" DefaultIcon="" Style="font-size: 2rem;" />
                        }
                        <div>
                            <MudText Typo="Typo.h4">@_currentArticle.Title</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                @GetArticleTypeLabel(_currentArticle.Type)
                                @if (_currentArticle.ModifiedAt.HasValue)
                                {
                                    <text> · Updated @_currentArticle.ModifiedAt.Value.ToString("MMM d, yyyy")</text>
                                }
                            </MudText>
                        </div>
                    </div>

                    <!-- AI Summary (if available) -->
                    @if (!string.IsNullOrEmpty(_currentArticle.AISummary))
                    {
                        <MudAlert Severity="Severity.Info" Class="mb-4 summary-text" Dense="true">
                            <strong>AI Summary:</strong> @_currentArticle.AISummary
                        </MudAlert>
                    }

                    <!-- Article body -->
                    <div id="public-article-body" class="public-article-body chronicis-editor-content">
                        @if (!string.IsNullOrEmpty(_currentArticle.Body))
                        {
                            @((MarkupString)MarkdownService.EnsureHtml(_currentArticle.Body))
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                <em>No content available.</em>
                            </MudText>
                        }
                    </div>
                </MudPaper>
            }
        </main>
    </div>
}

@code {
    [Parameter]
    public string PublicSlug { get; set; } = string.Empty;

    [Parameter]
    public string? ArticlePath { get; set; }

    private WorldDetailDto? _world;
    private List<ArticleTreeDto> _articleTree = new();
    private ArticleDto? _currentArticle;
    private bool _isLoading = true;
    private bool _isLoadingArticle = false;
    private DotNetObjectReference<PublicWorldPage>? _dotNetHelper;
    private bool _wikiLinksInitialized = false;

    protected override async Task OnParametersSetAsync()
    {
        // Reset wiki links state when navigating between articles
        _wikiLinksInitialized = false;
        await LoadWorldAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Initialize wiki link click handlers after the article body is rendered
        if (_currentArticle != null && !string.IsNullOrEmpty(_currentArticle.Body) && !_wikiLinksInitialized)
        {
            _dotNetHelper ??= DotNetObjectReference.Create(this);
            try
            {
                await JSRuntime.InvokeVoidAsync("initializePublicWikiLinks", "public-article-body", _dotNetHelper);
                _wikiLinksInitialized = true;
            }
            catch (Exception)
            {
                // JS interop may fail during prerendering or if component is disposed
            }
        }
    }

    public void Dispose()
    {
        _dotNetHelper?.Dispose();
    }

    [JSInvokable]
    public async Task OnPublicWikiLinkClicked(string targetArticleId)
    {
        if (!Guid.TryParse(targetArticleId, out var articleId)) return;

        try
        {
            var path = await PublicApi.ResolvePublicArticlePathAsync(PublicSlug, articleId);
            if (!string.IsNullOrEmpty(path))
            {
                Navigation.NavigateTo($"/w/{PublicSlug}/{path}");
            }
        }
        catch (Exception)
        {
            // Silently fail - link may not be public or may not exist
        }
    }

    private async Task LoadWorldAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            // Load world info
            _world = await PublicApi.GetPublicWorldAsync(PublicSlug);
            
            if (_world != null)
            {
                // Load article tree
                _articleTree = await PublicApi.GetPublicArticleTreeAsync(PublicSlug);

                // Load specific article if path provided
                if (!string.IsNullOrEmpty(ArticlePath))
                {
                    await LoadArticleAsync();
                }
            }
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadArticleAsync()
    {
        if (string.IsNullOrEmpty(ArticlePath)) return;

        _isLoadingArticle = true;
        StateHasChanged();

        try
        {
            _currentArticle = await PublicApi.GetPublicArticleAsync(PublicSlug, ArticlePath);
        }
        finally
        {
            _isLoadingArticle = false;
            StateHasChanged();
        }
    }

    private void NavigateToArticle(string articlePath)
    {
        if (string.IsNullOrEmpty(articlePath))
        {
            Navigation.NavigateTo($"/w/{PublicSlug}");
        }
        else
        {
            Navigation.NavigateTo($"/w/{PublicSlug}/{articlePath}");
        }
    }

    private List<BreadcrumbItem> GetBreadcrumbItems()
    {
        return _currentArticle == null
            ? new List<BreadcrumbItem>()
            : PublicBreadcrumbBuilder.Build(PublicSlug, _currentArticle);
    }

    private static string GetArticleTypeLabel(ArticleType type) => type switch
    {
        ArticleType.WikiArticle => "Wiki Article",
        ArticleType.Character => "Character",
        ArticleType.CharacterNote => "Character Note",
        ArticleType.Session => "Session",
        ArticleType.SessionNote => "Session Note",
        ArticleType.Legacy => "Article",
        _ => "Article"
    };

    private string GetPageTitle()
    {
        var worldName = string.IsNullOrWhiteSpace(_world?.Name) ? "World" : _world.Name;
        return $"{worldName} — Chronicis";
    }
}
