@page "/w/{PublicSlug}"
@page "/w/{PublicSlug}/{*ArticlePath}"
@layout PublicLayout
@using Chronicis.Shared.DTOs
@using Chronicis.Shared.Enums
@using Chronicis.Client.Components.Shared
@inject IPublicApiService PublicApi
@inject IMarkdownService MarkdownService
@inject NavigationManager Navigation

<PageTitle>@(_world?.Name ?? "World") — Chronicis</PageTitle>

@if (_isLoading)
{
    <div class="public-world-loading">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Typo="Typo.body1" Class="mt-3">Loading world...</MudText>
    </div>
}
else if (_world == null)
{
    <div class="public-world-not-found">
        <MudPaper Elevation="2" Class="pa-6 text-center">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" 
                     Style="font-size: 64px; color: var(--chronicis-beige-gold);" />
            <MudText Typo="Typo.h5" Class="mt-4 mb-2">World Not Found</MudText>
            <MudText Typo="Typo.body1" Class="mud-text-secondary mb-4">
                This world doesn't exist or isn't publicly shared.
            </MudText>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       Href="/"
                       StartIcon="@Icons.Material.Filled.Home">
                Go Home
            </MudButton>
        </MudPaper>
    </div>
}
else
{
    <div class="public-world-container">
        <!-- Sidebar with article tree -->
        <aside class="public-world-sidebar">
            <div class="public-world-sidebar-header">
                <a href="/w/@PublicSlug" class="public-world-title-link">
                    <MudText Typo="Typo.subtitle1" Style="color: var(--chronicis-beige-gold); font-weight: 600;">
                        @_world.Name
                    </MudText>
                </a>
            </div>

            <MudDivider Class="my-2" Style="opacity: 0.3;" />

            @if (_articleTree.Count == 0)
            {
                <div class="pa-3">
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                        No public articles in this world yet.
                    </MudText>
                </div>
            }
            else
            {
                <div class="public-article-tree">
                    @foreach (var article in _articleTree)
                    {
                        <PublicArticleTreeItem Article="@article" 
                                               PublicSlug="@PublicSlug"
                                               CurrentPath="@ArticlePath"
                                               OnArticleSelected="NavigateToArticle" />
                    }
                </div>
            }
        </aside>

        <!-- Main content area -->
        <main class="public-world-main">
            @if (string.IsNullOrEmpty(ArticlePath))
            {
                <!-- World landing view -->
                <MudPaper Elevation="2" Class="pa-6">
                    <div class="public-world-hero">
                        <MudIcon Icon="@Icons.Material.Filled.Public" 
                                 Style="font-size: 48px; color: var(--chronicis-beige-gold);" />
                        <MudText Typo="Typo.h4" Class="mt-3">@_world.Name</MudText>
                        @if (!string.IsNullOrEmpty(_world.Description))
                        {
                            <MudText Typo="Typo.body1" Class="mud-text-secondary mt-2">
                                @_world.Description
                            </MudText>
                        }
                        <MudText Typo="Typo.caption" Class="mud-text-secondary mt-3">
                            Created by @_world.OwnerName
                        </MudText>
                    </div>

                    @if (_articleTree.Count > 0)
                    {
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Select an article from the sidebar to start reading.
                        </MudText>
                    }
                </MudPaper>
            }
            else if (_currentArticle == null && !_isLoadingArticle)
            {
                <!-- Article not found -->
                <MudPaper Elevation="2" Class="pa-6 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.Article" 
                             Style="font-size: 48px; color: var(--chronicis-beige-gold);" />
                    <MudText Typo="Typo.h6" Class="mt-3">Article Not Found</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary mt-2">
                        This article doesn't exist or isn't publicly visible.
                    </MudText>
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Primary" 
                               Class="mt-3"
                               OnClick="() => NavigateToArticle(string.Empty)">
                        Back to World Overview
                    </MudButton>
                </MudPaper>
            }
            else if (_isLoadingArticle)
            {
                <MudPaper Elevation="2" Class="pa-6">
                    <MudSkeleton Width="60%" Height="32px" />
                    <MudSkeleton Width="100%" Height="20px" Class="mt-4" />
                    <MudSkeleton Width="100%" Height="20px" Class="mt-2" />
                    <MudSkeleton Width="80%" Height="20px" Class="mt-2" />
                </MudPaper>
            }
            else
            {
                <!-- Article view -->
                <MudPaper Elevation="2" Class="pa-6">
                    <!-- Breadcrumbs -->
                    @if (_currentArticle!.Breadcrumbs?.Any() == true)
                    {
                        <ChroniclsBreadcrumbs Items="@GetBreadcrumbItems()" UseCustomLinks="true" Class="mb-3 pa-0" />
                    }

                    <!-- Article header -->
                    <div class="d-flex align-center gap-3 mb-4">
                        @if (!string.IsNullOrEmpty(_currentArticle.IconEmoji))
                        {
                            <IconDisplay Icon="@_currentArticle.IconEmoji" DefaultIcon="" Style="font-size: 2rem;" />
                        }
                        <div>
                            <MudText Typo="Typo.h4">@_currentArticle.Title</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                @GetArticleTypeLabel(_currentArticle.Type)
                                @if (_currentArticle.ModifiedAt.HasValue)
                                {
                                    <text> · Updated @_currentArticle.ModifiedAt.Value.ToString("MMM d, yyyy")</text>
                                }
                            </MudText>
                        </div>
                    </div>

                    <!-- AI Summary (if available) -->
                    @if (!string.IsNullOrEmpty(_currentArticle.AISummary))
                    {
                        <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                            <strong>AI Summary:</strong> @_currentArticle.AISummary
                        </MudAlert>
                    }

                    <!-- Article body -->
                    <div class="public-article-body chronicis-editor-content">
                        @if (!string.IsNullOrEmpty(_currentArticle.Body))
                        {
                            @((MarkupString)MarkdownService.EnsureHtml(_currentArticle.Body))
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                <em>No content available.</em>
                            </MudText>
                        }
                    </div>
                </MudPaper>
            }
        </main>
    </div>
}

@code {
    [Parameter]
    public string PublicSlug { get; set; } = string.Empty;

    [Parameter]
    public string? ArticlePath { get; set; }

    private WorldDetailDto? _world;
    private List<ArticleTreeDto> _articleTree = new();
    private ArticleDto? _currentArticle;
    private bool _isLoading = true;
    private bool _isLoadingArticle = false;

    protected override async Task OnParametersSetAsync()
    {
        await LoadWorldAsync();
    }

    private async Task LoadWorldAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            // Load world info
            _world = await PublicApi.GetPublicWorldAsync(PublicSlug);
            
            if (_world != null)
            {
                // Load article tree
                _articleTree = await PublicApi.GetPublicArticleTreeAsync(PublicSlug);

                // Load specific article if path provided
                if (!string.IsNullOrEmpty(ArticlePath))
                {
                    await LoadArticleAsync();
                }
            }
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadArticleAsync()
    {
        if (string.IsNullOrEmpty(ArticlePath)) return;

        _isLoadingArticle = true;
        StateHasChanged();

        try
        {
            _currentArticle = await PublicApi.GetPublicArticleAsync(PublicSlug, ArticlePath);
        }
        finally
        {
            _isLoadingArticle = false;
            StateHasChanged();
        }
    }

    private void NavigateToArticle(string articlePath)
    {
        if (string.IsNullOrEmpty(articlePath))
        {
            Navigation.NavigateTo($"/w/{PublicSlug}");
        }
        else
        {
            Navigation.NavigateTo($"/w/{PublicSlug}/{articlePath}");
        }
    }

    private List<BreadcrumbItem> GetBreadcrumbItems()
    {
        var items = new List<BreadcrumbItem>();
        
        if (_currentArticle?.Breadcrumbs == null) return items;

        // Determine which breadcrumbs are virtual (Campaign/Arc/Player Characters/Wiki) vs real articles
        var campaignId = _currentArticle.CampaignId;
        var arcId = _currentArticle.ArcId;
        
        // Virtual group slugs that shouldn't be clickable
        var virtualGroupSlugs = new HashSet<string> { "characters", "wiki", "campaigns", "uncategorized" };

        foreach (var crumb in _currentArticle.Breadcrumbs)
        {
            var isLast = crumb.Id == _currentArticle.Id;
            
            if (crumb.IsWorld)
            {
                // World - always clickable, goes back to world landing
                items.Add(new BreadcrumbItem(crumb.Title, $"/w/{PublicSlug}"));
            }
            else if (crumb.Id == Guid.Empty || virtualGroupSlugs.Contains(crumb.Slug.ToLowerInvariant()))
            {
                // Virtual group breadcrumb (Player Characters, Wiki, etc.) - not clickable
                items.Add(new BreadcrumbItem(crumb.Title, null, disabled: true));
            }
            else if (campaignId.HasValue && crumb.Id == campaignId.Value)
            {
                // Campaign breadcrumb - virtual, not clickable
                items.Add(new BreadcrumbItem(crumb.Title, null, disabled: true));
            }
            else if (arcId.HasValue && crumb.Id == arcId.Value)
            {
                // Arc breadcrumb - virtual, not clickable
                items.Add(new BreadcrumbItem(crumb.Title, null, disabled: true));
            }
            else
            {
                // Real article breadcrumb
                if (isLast)
                {
                    items.Add(new BreadcrumbItem(crumb.Title, null, disabled: true));
                }
                else
                {
                    // Build path for this article
                    // Only include real article slugs (not virtual groups)
                    var articleSlugs = _currentArticle.Breadcrumbs
                        .Where(b => !b.IsWorld && 
                               b.Id != Guid.Empty &&
                               !virtualGroupSlugs.Contains(b.Slug.ToLowerInvariant()) &&
                               !(campaignId.HasValue && b.Id == campaignId.Value) &&
                               !(arcId.HasValue && b.Id == arcId.Value))
                        .TakeWhile(b => b.Id != crumb.Id)
                        .Select(b => b.Slug)
                        .ToList();
                    articleSlugs.Add(crumb.Slug);
                    var path = string.Join("/", articleSlugs);
                    
                    items.Add(new BreadcrumbItem(crumb.Title, $"/w/{PublicSlug}/{path}"));
                }
            }
        }

        return items;
    }

    private static string GetArticleTypeLabel(ArticleType type) => type switch
    {
        ArticleType.WikiArticle => "Wiki Article",
        ArticleType.Character => "Character",
        ArticleType.CharacterNote => "Character Note",
        ArticleType.Session => "Session",
        ArticleType.SessionNote => "Session Note",
        ArticleType.Legacy => "Article",
        _ => "Article"
    };
}
