@page "/w/{PublicSlug}"
@page "/w/{PublicSlug}/{*ArticlePath}"
@layout PublicLayout
@using Chronicis.Shared.DTOs
@using Chronicis.Shared.Enums
@using Chronicis.Client.Components.Shared
@using Microsoft.JSInterop
@inject PublicWorldPageViewModel VM
@inject IMarkdownService MarkdownService
@inject IJSRuntime JSRuntime

@implements IAsyncDisposable

<PageTitle>@VM.GetPageTitle()</PageTitle>

@if (VM.IsLoading)
{
    <div class="public-world-loading">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Typo="Typo.body1" Class="mt-3">Loading world...</MudText>
    </div>
}
else if (VM.World == null)
{
    <div class="public-world-not-found">
        <MudPaper Elevation="2" Class="pa-6 text-center">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" 
                     Style="font-size: 64px; color: var(--chronicis-beige-gold);" />
            <MudText Typo="Typo.h5" Class="mt-4 mb-2">World Not Found</MudText>
            <MudText Typo="Typo.body1" Class="mud-text-secondary mb-4">
                This world doesn't exist or isn't publicly shared.
            </MudText>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       Href="/"
                       StartIcon="@Icons.Material.Filled.Home">
                Go Home
            </MudButton>
        </MudPaper>
    </div>
}
else
{
    <div class="public-world-container">
        <!-- Sidebar with article tree -->
        <aside class="public-world-sidebar">
            <div class="public-world-sidebar-header">
                <a href="/w/@PublicSlug" class="public-world-title-link">
                    <MudText Typo="Typo.subtitle1" Style="color: var(--chronicis-beige-gold); font-weight: 600;">
                        @VM.World.Name
                    </MudText>
                </a>
            </div>

            <MudDivider Class="my-2" Style="opacity: 0.3;" />

            @if (VM.ArticleTree.Count == 0)
            {
                <div class="pa-3">
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                        No public articles in this world yet.
                    </MudText>
                </div>
            }
            else
            {
                <div class="public-article-tree">
                    @foreach (var article in VM.ArticleTree)
                    {
                        <PublicArticleTreeItem Article="@article" 
                                               PublicSlug="@PublicSlug"
                                               CurrentPath="@ArticlePath"
                                               OnArticleSelected="@(path => VM.NavigateToArticle(PublicSlug, path))" />
                    }
                </div>
            }
        </aside>

        <!-- Main content area -->
        <main class="public-world-main">
            @if (string.IsNullOrEmpty(ArticlePath))
            {
                <!-- World landing view -->
                <MudPaper Elevation="2" Class="pa-6">
                    <div class="public-world-hero">
                        <MudIcon Icon="@Icons.Material.Filled.Public" 
                                 Style="font-size: 48px; color: var(--chronicis-beige-gold);" />
                        <MudText Typo="Typo.h4" Class="mt-3">@VM.World.Name</MudText>
                        @if (!string.IsNullOrEmpty(VM.World.Description))
                        {
                            <MudText Typo="Typo.body1" Class="mud-text-secondary mt-2">
                                @VM.World.Description
                            </MudText>
                        }
                        <MudText Typo="Typo.caption" Class="mud-text-secondary mt-3">
                            Created by @VM.World.OwnerName
                        </MudText>
                    </div>

                    @if (VM.ArticleTree.Count > 0)
                    {
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Select an article from the sidebar to start reading.
                        </MudText>
                    }
                </MudPaper>
            }
            else if (VM.CurrentArticle == null && !VM.IsLoadingArticle)
            {
                <!-- Article not found -->
                <MudPaper Elevation="2" Class="pa-6 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.Article" 
                             Style="font-size: 48px; color: var(--chronicis-beige-gold);" />
                    <MudText Typo="Typo.h6" Class="mt-3">Article Not Found</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary mt-2">
                        This article doesn't exist or isn't publicly visible.
                    </MudText>
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Primary" 
                               Class="mt-3"
                               OnClick="() => VM.NavigateToArticle(PublicSlug, string.Empty)">
                        Back to World Overview
                    </MudButton>
                </MudPaper>
            }
            else if (VM.IsLoadingArticle)
            {
                <MudPaper Elevation="2" Class="pa-6">
                    <MudSkeleton Width="60%" Height="32px" />
                    <MudSkeleton Width="100%" Height="20px" Class="mt-4" />
                    <MudSkeleton Width="100%" Height="20px" Class="mt-2" />
                    <MudSkeleton Width="80%" Height="20px" Class="mt-2" />
                </MudPaper>
            }
            else
            {
                <!-- Article view -->
                <MudPaper Elevation="2" Class="pa-6">
                    <!-- Breadcrumbs -->
                    @if (VM.CurrentArticle!.Breadcrumbs?.Any() == true)
                    {
                        <ChroniclsBreadcrumbs Items="@VM.GetBreadcrumbItems(PublicSlug)" UseCustomLinks="true" Class="mb-3 pa-0" />
                    }

                    <!-- Article header -->
                    <div class="d-flex align-center gap-3 mb-4">
                        @if (!string.IsNullOrEmpty(VM.CurrentArticle.IconEmoji))
                        {
                            <IconDisplay Icon="@VM.CurrentArticle.IconEmoji" DefaultIcon="" Style="font-size: 2rem;" />
                        }
                        <div>
                            <MudText Typo="Typo.h4">@VM.CurrentArticle.Title</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                @PublicWorldPageViewModel.GetArticleTypeLabel(VM.CurrentArticle.Type)
                                @if (VM.CurrentArticle.ModifiedAt.HasValue)
                                {
                                    <text> Â· Updated @VM.CurrentArticle.ModifiedAt.Value.ToString("MMM d, yyyy")</text>
                                }
                            </MudText>
                        </div>
                    </div>

                    <!-- AI Summary (if available) -->
                    @if (!string.IsNullOrEmpty(VM.CurrentArticle.AISummary))
                    {
                        <MudAlert Severity="Severity.Info" Class="mb-4 summary-text" Dense="true">
                            <strong>AI Summary:</strong> @VM.CurrentArticle.AISummary
                        </MudAlert>
                    }

                    <!-- Article body -->
                    <div id="public-article-body" class="public-article-body chronicis-editor-content">
                        @if (!string.IsNullOrEmpty(VM.CurrentArticle.Body))
                        {
                            @((MarkupString)VM.GetRenderedArticleBodyHtml(MarkdownService))
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                <em>No content available.</em>
                            </MudText>
                        }
                    </div>
                </MudPaper>
            }
        </main>
    </div>
}

@code {
    [Parameter]
    public string PublicSlug { get; set; } = string.Empty;

    [Parameter]
    public string? ArticlePath { get; set; }

    protected override void OnInitialized()
    {
        VM.PropertyChanged += OnVmPropertyChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await VM.LoadWorldAsync(PublicSlug, ArticlePath);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (VM.CurrentArticle != null
            && !string.IsNullOrEmpty(VM.CurrentArticle.Body)
            && !VM.WikiLinksInitialized)
        {
            await VM.InitializeWikiLinksAsync(JSRuntime);
        }
    }

    private void OnVmPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        VM.PropertyChanged -= OnVmPropertyChanged;
        await VM.DisposeAsync();
    }
}
