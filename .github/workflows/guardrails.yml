name: Guardrails

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  guardrails:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore
        shell: pwsh
        run: dotnet restore ./Chronicis.CI.sln

      - name: Verify formatting
        shell: pwsh
        run: dotnet format ./Chronicis.CI.sln --verify-no-changes --verbosity minimal

      - name: Build
        shell: pwsh
        run: dotnet build ./Chronicis.CI.sln --configuration Release --no-restore

      # ------------------------------------------------------------
      # Test ONLY Chronicis.Shared.Tests (matches your local run)
      # ------------------------------------------------------------
      - name: Test Chronicis.Shared.Tests (with coverage)
        shell: pwsh
        run: |
          dotnet test ./tests/Chronicis.Shared.Tests/Chronicis.Shared.Tests.csproj `
            --configuration Release `
            --no-build `
            --verbosity normal `
            /p:CollectCoverage=true `
            /p:CoverletOutputFormat=cobertura `
            /p:CoverletOutput=./tests/Chronicis.Shared.Tests/TestResults/coverage/

      - name: Install ReportGenerator
        shell: pwsh
        run: dotnet tool update -g dotnet-reportgenerator-globaltool

      # ------------------------------------------------------------
      # Generate HTML + merged Cobertura from that single coverage file
      # ------------------------------------------------------------
      - name: Generate coverage HTML + summary
        shell: pwsh
        run: |
          reportgenerator `
            -reports:"tests/Chronicis.Shared.Tests/TestResults/coverage/*.cobertura.xml" `
            -targetdir:"coveragereport" `
            -reporttypes:"Html;MarkdownSummaryGithub;Cobertura"

      - name: Publish coverage summary to GitHub Actions
        shell: pwsh
        run: |
          if (Test-Path "coveragereport/SummaryGithub.md") {
            Get-Content "coveragereport/SummaryGithub.md" | Add-Content $env:GITHUB_STEP_SUMMARY
          } else {
            "Coverage summary not found." | Add-Content $env:GITHUB_STEP_SUMMARY
          }

      # ------------------------------------------------------------
      # Use the merged Cobertura file generated by ReportGenerator
      # This guarantees history == published HTML
      # ------------------------------------------------------------
      - name: Compute overall coverage rates
        id: rates
        shell: pwsh
        run: |
          $cobertura = "coveragereport/Cobertura.xml"

          if (-not (Test-Path $cobertura)) {
            throw "Merged Cobertura.xml not found."
          }

          Write-Host "Using merged cobertura file: $cobertura"

          python3 ci/coverage/extract_rates.py $cobertura | Out-File -Encoding utf8 rates.json

          $rates = Get-Content rates.json | ConvertFrom-Json
          "linePct=$($rates.linePct)"     | Out-File -Append -Encoding utf8 $env:GITHUB_OUTPUT
          "branchPct=$($rates.branchPct)" | Out-File -Append -Encoding utf8 $env:GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Update coverage history branch
      # ------------------------------------------------------------
      - name: Checkout coverage history branch
        uses: actions/checkout@v4
        with:
          ref: coverage-history
          path: _history
          fetch-depth: 1

      - name: Update history.json (via script)
        id: history
        shell: pwsh
        env:
          LINE_PCT: ${{ steps.rates.outputs.linePct }}
          BRANCH_PCT: ${{ steps.rates.outputs.branchPct }}
          SHA: ${{ github.sha }}
          HISTORY_PATH: _history/history.json
        run: |
          $iso = python3 ci/coverage/update_history.py
          "ISO_DATE=$iso" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV

      - name: Commit updated history.json
        shell: pwsh
        working-directory: _history
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add history.json
          git diff --cached --quiet
          if ($LASTEXITCODE -eq 0) {
            Write-Host "No history changes to commit."
            exit 0
          }

          git commit -m "Update coverage history: $env:ISO_DATE"
          git push origin HEAD:coverage-history

      # ------------------------------------------------------------
      # Assemble GitHub Pages site
      # ------------------------------------------------------------
      - name: Assemble Pages site
        shell: pwsh
        run: |
          if (Test-Path "site") { Remove-Item -Recurse -Force "site" }
          New-Item -ItemType Directory -Force -Path "site/coverage" | Out-Null

          Copy-Item -Recurse -Force "ci/pages/*" "site/"

          New-Item -ItemType Directory -Force -Path "site/coverage/report" | Out-Null
          Copy-Item -Recurse -Force "coveragereport/*" "site/coverage/report/"

          Copy-Item -Force "_history/history.json" "site/coverage/history.json"

          "OK" | Out-File -Encoding utf8 "site/health.txt"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy-pages:
    needs: guardrails
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
