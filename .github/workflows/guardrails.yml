name: Guardrails

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  guardrails:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore
        shell: pwsh
        run: dotnet restore ./Chronicis.CI.sln

      - name: Verify formatting
        shell: pwsh
        run: dotnet format ./Chronicis.CI.sln --verify-no-changes --verbosity minimal

      - name: Build
        shell: pwsh
        run: dotnet build ./Chronicis.CI.sln --configuration Release --no-restore

      # ------------------------------------------------------------
      # Run ONLY Chronicis.Shared.Tests with coverage
      # Also: search workspace for cobertura outputs and copy into a known folder
      # ------------------------------------------------------------
      - name: Test Chronicis.Shared.Tests (with coverage)
        shell: pwsh
        run: |
          $outDir = Join-Path $env:GITHUB_WORKSPACE "TestResults/Chronicis.Shared.Tests"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          # Try to force output to our folder (Coverlet uses this as a prefix)
          $outPrefix = Join-Path $outDir "coverage"

          Write-Host "Running tests with coverage..."
          dotnet test ./tests/Chronicis.Shared.Tests/Chronicis.Shared.Tests.csproj `
            --configuration Release `
            --verbosity normal `
            /p:CollectCoverage=true `
            /p:CoverletOutputFormat=cobertura `
            /p:CoverletOutput="$outPrefix"

          Write-Host ""
          Write-Host "Searching for cobertura files anywhere in the workspace..."
          $found = Get-ChildItem -Recurse -Path $env:GITHUB_WORKSPACE -Filter *.cobertura.xml -ErrorAction SilentlyContinue

          if (-not $found -or $found.Count -eq 0) {
            Write-Host "No cobertura files were generated anywhere. Diagnostics follow."
            Write-Host ""
            Write-Host "List TestResults folder:"
            if (Test-Path (Join-Path $env:GITHUB_WORKSPACE "TestResults")) {
              Get-ChildItem -Recurse (Join-Path $env:GITHUB_WORKSPACE "TestResults") | ForEach-Object { Write-Host $_.FullName }
            } else {
              Write-Host "No TestResults folder exists."
            }

            Write-Host ""
            Write-Host "List test project bin/obj (Release) folders:"
            $testRoot = Join-Path $env:GITHUB_WORKSPACE "tests/Chronicis.Shared.Tests"
            if (Test-Path $testRoot) {
              Get-ChildItem -Recurse $testRoot -Directory -ErrorAction SilentlyContinue |
                Where-Object { $_.FullName -match "/bin/Release|/obj/Release" } |
                Select-Object -First 200 |
                ForEach-Object { Write-Host $_.FullName }
            }

            throw "Coverlet did not produce any *.cobertura.xml files."
          }

          Write-Host "Cobertura files found:"
          $found | ForEach-Object { Write-Host $_.FullName }

          Write-Host ""
          Write-Host "Copying cobertura files into $outDir ..."
          foreach ($f in $found) {
            Copy-Item -Force $f.FullName (Join-Path $outDir $f.Name)
          }

          Write-Host ""
          Write-Host "Coverage output directory contents:"
          Get-ChildItem -Recurse $outDir | ForEach-Object { Write-Host $_.FullName }

      - name: Install ReportGenerator
        shell: pwsh
        run: dotnet tool update -g dotnet-reportgenerator-globaltool

      # ------------------------------------------------------------
      # Generate HTML + merged Cobertura from the known folder
      # ------------------------------------------------------------
      - name: Generate coverage HTML + summary
        shell: pwsh
        run: |
          $outDir = "TestResults/Chronicis.Shared.Tests"

          $reports = Get-ChildItem -Recurse -Path $outDir -Filter *.cobertura.xml | Select-Object -ExpandProperty FullName
          if (-not $reports -or $reports.Count -eq 0) {
            Write-Host "No cobertura files found under $outDir. Directory contents:"
            Get-ChildItem -Recurse -Path $outDir | ForEach-Object { Write-Host $_.FullName }
            throw "No cobertura files found under $outDir"
          }

          Write-Host "Using cobertura files:"
          $reports | ForEach-Object { Write-Host $_ }

          $reportArg = ($reports -join ';')

          reportgenerator `
            -reports:"$reportArg" `
            -targetdir:"coveragereport" `
            -reporttypes:"Html;MarkdownSummaryGithub;Cobertura"

      - name: Publish coverage summary to GitHub Actions
        shell: pwsh
        run: |
          if (Test-Path "coveragereport/SummaryGithub.md") {
            Get-Content "coveragereport/SummaryGithub.md" | Add-Content $env:GITHUB_STEP_SUMMARY
          } else {
            "Coverage summary not found." | Add-Content $env:GITHUB_STEP_SUMMARY
          }

      # ------------------------------------------------------------
      # Compute rates from the merged Cobertura file produced above
      # ------------------------------------------------------------
      - name: Compute overall coverage rates
        id: rates
        shell: pwsh
        run: |
          $mergedCobertura = "coveragereport/Cobertura.xml"

          if (-not (Test-Path $mergedCobertura)) {
            Write-Host "coveragereport directory contents:"
            Get-ChildItem -Recurse "coveragereport" | ForEach-Object { Write-Host $_.FullName }
            throw "Merged Cobertura.xml not found at $mergedCobertura"
          }

          Write-Host "Using merged cobertura file: $mergedCobertura"

          python3 ci/coverage/extract_rates.py $mergedCobertura | Out-File -Encoding utf8 rates.json

          $rates = Get-Content rates.json | ConvertFrom-Json
          "linePct=$($rates.linePct)"     | Out-File -Append -Encoding utf8 $env:GITHUB_OUTPUT
          "branchPct=$($rates.branchPct)" | Out-File -Append -Encoding utf8 $env:GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Update coverage history branch
      # ------------------------------------------------------------
      - name: Checkout coverage history branch
        uses: actions/checkout@v4
        with:
          ref: coverage-history
          path: _history
          fetch-depth: 1

      - name: Update history.json (via script)
        id: history
        shell: pwsh
        env:
          LINE_PCT: ${{ steps.rates.outputs.linePct }}
          BRANCH_PCT: ${{ steps.rates.outputs.branchPct }}
          SHA: ${{ github.sha }}
          HISTORY_PATH: _history/history.json
        run: |
          $iso = python3 ci/coverage/update_history.py
          "ISO_DATE=$iso" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV

      - name: Commit updated history.json
        shell: pwsh
        working-directory: _history
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add history.json
          git diff --cached --quiet
          if ($LASTEXITCODE -eq 0) {
            Write-Host "No history changes to commit."
            exit 0
          }

          git commit -m "Update coverage history: $env:ISO_DATE"
          git push origin HEAD:coverage-history

      # ------------------------------------------------------------
      # Assemble GitHub Pages site
      # ------------------------------------------------------------
      - name: Assemble Pages site
        shell: pwsh
        run: |
          if (Test-Path "site") { Remove-Item -Recurse -Force "site" }

          New-Item -ItemType Directory -Force -Path "site/coverage/report" | Out-Null

          Copy-Item -Recurse -Force "ci/pages/*" "site/"
          Copy-Item -Recurse -Force "coveragereport/*" "site/coverage/report/"
          Copy-Item -Force "_history/history.json" "site/coverage/history.json"

          "OK" | Out-File -Encoding utf8 "site/health.txt"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy-pages:
    needs: guardrails
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
