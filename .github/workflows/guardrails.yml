name: Guardrails

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

env:
  SOLUTION_PATH: ./Chronicis.CI.sln
  REPORT_DIR_REL: coveragereport

jobs:
  guardrails:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Show .NET info
        shell: pwsh
        run: |
          dotnet --info
          dotnet --version

      - name: Restore
        shell: pwsh
        run: dotnet restore "${{ env.SOLUTION_PATH }}"

      - name: Build (Release)
        shell: pwsh
        run: dotnet build "${{ env.SOLUTION_PATH }}" --configuration Release --no-restore

      # ------------------------------------------------------------
      # Coverage collection using coverlet.collector (XPlat Code Coverage)
      #
      # Key difference from coverlet.msbuild: the collector approach works
      # at test runtime, not build time. This means --no-build is safe and
      # instrumentation of referenced assemblies works correctly via the
      # Include filter in coverlet.runsettings.
      # ------------------------------------------------------------
      - name: Test unit projects with coverage (XPlat Code Coverage)
        shell: pwsh
        run: |
          $workspace = $env:GITHUB_WORKSPACE
          $resultsDir = Join-Path $workspace "TestResults"
          $unitCoverageDir = Join-Path $resultsDir "unit-coverage"

          # Clean previous results
          if (Test-Path $resultsDir) { Remove-Item -Recurse -Force $resultsDir }
          New-Item -ItemType Directory -Force -Path $unitCoverageDir | Out-Null

          $coverageRuns = @(
            @{ Name = "Shared"; Project = "tests/Chronicis.Shared.Tests/Chronicis.Shared.Tests.csproj"; ResultsSubdir = "shared" },
            @{ Name = "Api";    Project = "tests/Chronicis.Api.Tests/Chronicis.Api.Tests.csproj";       ResultsSubdir = "api" },
            @{ Name = "Client"; Project = "tests/Chronicis.Client.Tests/Chronicis.Client.Tests.csproj"; ResultsSubdir = "client" }
          )

          foreach ($run in $coverageRuns) {
            $projectResultsDir = Join-Path $unitCoverageDir $run.ResultsSubdir
            Write-Host "Running coverage for $($run.Name): $($run.Project)"

            dotnet test $run.Project `
              --configuration Release `
              --no-build `
              --verbosity normal `
              --collect:"XPlat Code Coverage" `
              --settings coverlet.runsettings `
              --results-directory "$projectResultsDir"

            if ($LASTEXITCODE -ne 0) {
              throw "Coverage test run failed for $($run.Project)"
            }
          }

      - name: Test architectural project (no coverage)
        shell: pwsh
        run: |
          dotnet test "tests/Chronicis.ArchitecturalTests/Chronicis.ArchitecturalTests.csproj" `
            --configuration Release `
            --no-build `
            --verbosity normal

          # Find all coverage files produced by the collector
          $workspace = $env:GITHUB_WORKSPACE
          $resultsDir = Join-Path $workspace "TestResults"
          $unitCoverageDir = Join-Path $resultsDir "unit-coverage"
          $coberturaFiles = Get-ChildItem -Recurse -Path $unitCoverageDir -Filter "coverage.cobertura.xml" -ErrorAction SilentlyContinue
          if (-not $coberturaFiles -or $coberturaFiles.Count -eq 0) {
            Write-Host "No coverage.cobertura.xml files found under: $unitCoverageDir"
            if (Test-Path $resultsDir) {
              Get-ChildItem -Recurse $resultsDir | Select-Object -First 300 | ForEach-Object { Write-Host $_.FullName }
            }
            throw "Coverage collection produced zero cobertura files."
          }

          Write-Host "Coverage files found ($($coberturaFiles.Count)):"
          $coberturaFiles | Sort-Object FullName | ForEach-Object { Write-Host "  $($_.FullName)" }

      - name: Install ReportGenerator
        shell: pwsh
        run: dotnet tool update -g dotnet-reportgenerator-globaltool

      - name: Generate merged coverage report
        shell: pwsh
        run: |
          $workspace = $env:GITHUB_WORKSPACE
          $resultsDir = Join-Path $workspace "TestResults"
          $unitCoverageDir = Join-Path $resultsDir "unit-coverage"
          $reportDir  = Join-Path $workspace "${{ env.REPORT_DIR_REL }}"
          $stagingDir = Join-Path $workspace "coverage-staging"

          if (Test-Path $reportDir) { Remove-Item -Recurse -Force $reportDir }
          New-Item -ItemType Directory -Force -Path $reportDir | Out-Null
          if (Test-Path $stagingDir) { Remove-Item -Recurse -Force $stagingDir }
          New-Item -ItemType Directory -Force -Path $stagingDir | Out-Null

          $sharedCoverage = Get-ChildItem -Recurse -Path (Join-Path $unitCoverageDir "shared") -Filter "coverage.cobertura.xml" | Select-Object -First 1 -ExpandProperty FullName
          $apiCoverage    = Get-ChildItem -Recurse -Path (Join-Path $unitCoverageDir "api")    -Filter "coverage.cobertura.xml" | Select-Object -First 1 -ExpandProperty FullName
          $clientCoverage = Get-ChildItem -Recurse -Path (Join-Path $unitCoverageDir "client") -Filter "coverage.cobertura.xml" | Select-Object -First 1 -ExpandProperty FullName

          if (-not $sharedCoverage -or -not $apiCoverage -or -not $clientCoverage) {
            throw "Missing one or more unit coverage inputs (shared/api/client)."
          }

          $inputs = @(
            @{ Name = "shared"; Assembly = "Chronicis.Shared"; Source = $sharedCoverage },
            @{ Name = "api";    Assembly = "Chronicis.Api";    Source = $apiCoverage },
            @{ Name = "client"; Assembly = "Chronicis.Client"; Source = $clientCoverage }
          )

          $stagedCoberturas = @()
          foreach ($input in $inputs) {
            $target = Join-Path $stagingDir $input.Name
            New-Item -ItemType Directory -Force -Path $target | Out-Null
            Write-Host "Staging filtered coverage for $($input.Assembly) from $($input.Source)"

            reportgenerator `
              -reports:"$($input.Source)" `
              -targetdir:"$target" `
              -assemblyfilters:"+$($input.Assembly)" `
              -reporttypes:"Cobertura"

            $staged = Join-Path $target "Cobertura.xml"
            if (-not (Test-Path $staged)) {
              throw "Failed to generate staged Cobertura for $($input.Assembly)"
            }

            $stagedCoberturas += $staged
          }

          $reportArg = ($stagedCoberturas -join ';')

          Write-Host "Final ReportGenerator inputs ($($stagedCoberturas.Count) files):"
          $stagedCoberturas | ForEach-Object { Write-Host "  $_" }

          reportgenerator `
            -reports:"$reportArg" `
            -targetdir:"$reportDir" `
            -reporttypes:"Html;Cobertura;MarkdownSummaryGithub"

          Write-Host "Report generated. Contents:"
          Get-ChildItem $reportDir | ForEach-Object { Write-Host "  $($_.FullName)" }

      - name: Publish coverage summary to GitHub Actions
        shell: pwsh
        run: |
          $summary = Join-Path $env:GITHUB_WORKSPACE "${{ env.REPORT_DIR_REL }}/SummaryGithub.md"
          if (Test-Path $summary) {
            Get-Content $summary | Add-Content $env:GITHUB_STEP_SUMMARY
          } else {
            "Coverage summary not found." | Add-Content $env:GITHUB_STEP_SUMMARY
          }

      - name: Compute overall coverage rates
        id: rates
        shell: pwsh
        run: |
          $workspace = $env:GITHUB_WORKSPACE
          $stagingDir = Join-Path $workspace "coverage-staging"
          $shared = Join-Path $stagingDir "shared/Cobertura.xml"
          $api = Join-Path $stagingDir "api/Cobertura.xml"
          $client = Join-Path $stagingDir "client/Cobertura.xml"

          foreach ($path in @($shared, $api, $client)) {
            if (-not (Test-Path $path)) {
              throw "Staged Cobertura not found: $path"
            }
          }

          Write-Host "Using staged Cobertura inputs:"
          Write-Host "  $shared"
          Write-Host "  $api"
          Write-Host "  $client"
          python3 ci/coverage/extract_rates.py $shared $api $client | Out-File -Encoding utf8 rates.json

          $rates = Get-Content rates.json | ConvertFrom-Json
          "linePct=$($rates.linePct)"     | Out-File -Append -Encoding utf8 $env:GITHUB_OUTPUT
          "branchPct=$($rates.branchPct)" | Out-File -Append -Encoding utf8 $env:GITHUB_OUTPUT

      - name: Append exact aggregated coverage rates
        shell: pwsh
        run: |
          "" | Add-Content $env:GITHUB_STEP_SUMMARY
          "### Exact Aggregated Coverage (per-assembly staged Cobertura)" | Add-Content $env:GITHUB_STEP_SUMMARY
          "- Line coverage: `${{ steps.rates.outputs.linePct }}%`" | Add-Content $env:GITHUB_STEP_SUMMARY
          "- Branch coverage: `${{ steps.rates.outputs.branchPct }}%`" | Add-Content $env:GITHUB_STEP_SUMMARY

      # ------------------------------------------------------------
      # Update coverage history branch
      # ------------------------------------------------------------
      - name: Checkout coverage history branch
        uses: actions/checkout@v4
        with:
          ref: coverage-history
          path: _history
          fetch-depth: 1

      - name: Update history.json (via script)
        id: history
        shell: pwsh
        env:
          LINE_PCT: ${{ steps.rates.outputs.linePct }}
          BRANCH_PCT: ${{ steps.rates.outputs.branchPct }}
          SHA: ${{ github.sha }}
          HISTORY_PATH: _history/history.json
        run: |
          $iso = python3 ci/coverage/update_history.py
          "ISO_DATE=$iso" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV

      - name: Commit updated history.json
        shell: pwsh
        working-directory: _history
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add history.json
          git diff --cached --quiet
          if ($LASTEXITCODE -eq 0) {
            Write-Host "No history changes to commit."
            exit 0
          }

          git commit -m "Update coverage history: $env:ISO_DATE"
          git push origin HEAD:coverage-history

      # ------------------------------------------------------------
      # Assemble Pages site and publish
      # ------------------------------------------------------------
      - name: Assemble Pages site
        shell: pwsh
        run: |
          $workspace = $env:GITHUB_WORKSPACE
          $site = Join-Path $workspace "site"

          if (Test-Path $site) { Remove-Item -Recurse -Force $site }
          New-Item -ItemType Directory -Force -Path (Join-Path $site "coverage/report") | Out-Null

          Copy-Item -Recurse -Force "ci/pages/*" $site
          Copy-Item -Recurse -Force "${{ env.REPORT_DIR_REL }}/*" (Join-Path $site "coverage/report/")
          Copy-Item -Force "_history/history.json" (Join-Path $site "coverage/history.json")
          "OK" | Out-File -Encoding utf8 (Join-Path $site "health.txt")

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: site

  deploy-pages:
    needs: guardrails
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
