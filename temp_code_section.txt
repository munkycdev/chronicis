@code {
    // Link panel state - managed by THIS component
    private List<BacklinkDto> _backlinks = new();
    private bool _loadingBacklinks = false;
    
    private List<BacklinkDto> _outgoingLinks = new();
    private bool _loadingOutgoingLinks = false;
    
    private List<ArticleExternalLinkDto> _externalLinks = new();
    private bool _loadingExternalLinks = false;
    
    private Guid _lastArticleId = Guid.Empty;
    private bool _isCreator;
    private ArticleVisibility _currentVisibility;
    private bool _isSavingVisibility;
    private Guid? _currentUserId;
    
    // Aliases
    private string _aliasesText = string.Empty;
    private string _originalAliasesText = string.Empty;
    private bool _isSavingAliases;

    [Parameter]
    public ArticleDto Article { get; set; } = null!;

    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter]
    public EventCallback OnArticleVisibilityChanged { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var user = await UserApi.GetUserProfileAsync();
        _currentUserId = user?.Id;
    }

    protected override async Task OnParametersSetAsync()
    {
        _isCreator = _currentUserId.HasValue && Article.CreatedBy == _currentUserId.Value;
        _currentVisibility = Article.Visibility;
        
        // Initialize aliases text from Article
        var newAliasesText = Article.Aliases != null && Article.Aliases.Any()
            ? string.Join(", ", Article.Aliases.Select(a => a.AliasText))
            : string.Empty;
        
        // Only update if the article changed (not just user editing)
        if (_originalAliasesText != newAliasesText || string.IsNullOrEmpty(_aliasesText))
        {
            _aliasesText = newAliasesText;
            _originalAliasesText = newAliasesText;
        }
        
        // Load links when article changes
        var articleChanged = Article.Id != _lastArticleId;
        if (articleChanged)
        {
            _lastArticleId = Article.Id;
            _backlinks = new();
            _outgoingLinks = new();
            _externalLinks = new();
            
            // Only load if drawer is already open
            if (IsOpen)
            {
                await Task.WhenAll(
                    LoadBacklinksAsync(),
                    LoadOutgoingLinksAsync(),
                    LoadExternalLinksAsync()
                );
            }
        }
    }

    private async Task OnOpenChangedInternal()
    {
        await IsOpenChanged.InvokeAsync(IsOpen);
        
        // Load links when drawer opens (if not already loaded)
        if (IsOpen)
        {
            var tasks = new List<Task>();
            
            if (!_backlinks.Any() && !_loadingBacklinks)
                tasks.Add(LoadBacklinksAsync());
                
            if (!_outgoingLinks.Any() && !_loadingOutgoingLinks)
                tasks.Add(LoadOutgoingLinksAsync());
                
            if (!_externalLinks.Any() && !_loadingExternalLinks)
                tasks.Add(LoadExternalLinksAsync());
            
            if (tasks.Any())
                await Task.WhenAll(tasks);
        }
    }

    private async Task LoadBacklinksAsync()
    {
        _loadingBacklinks = true;
        StateHasChanged();

        try
        {
            _backlinks = await LinkApi.GetBacklinksAsync(Article.Id);
        }
        catch (Exception)
        {
            _backlinks = new List<BacklinkDto>();
        }
        finally
        {
            _loadingBacklinks = false;
            StateHasChanged();
        }
    }

    private async Task LoadOutgoingLinksAsync()
    {
        _loadingOutgoingLinks = true;
        StateHasChanged();

        try
        {
            _outgoingLinks = await LinkApi.GetOutgoingLinksAsync(Article.Id);
        }
        catch (Exception)
        {
            _outgoingLinks = new List<BacklinkDto>();
        }
        finally
        {
            _loadingOutgoingLinks = false;
            StateHasChanged();
        }
    }

    private async Task LoadExternalLinksAsync()
    {
        _loadingExternalLinks = true;
        StateHasChanged();

        try
        {
            _externalLinks = await LinkApi.GetExternalLinksAsync(Article.Id);
        }
        catch (Exception)
        {
            _externalLinks = new List<ArticleExternalLinkDto>();
        }
        finally
        {
            _loadingExternalLinks = false;
            StateHasChanged();
        }
    }

    private async Task HandleNavigateToArticle(Guid articleId)
    {
        try
        {
            var path = await ArticleCache.GetNavigationPathAsync(articleId);
            
            if (!string.IsNullOrEmpty(path))
            {
                Navigation.NavigateTo($"/article/{path}");
            }
        }
        catch (Exception)
        {
            // Navigation failed - could log or show error
        }
    }
